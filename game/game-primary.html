<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Primary / Drives – Football Data Tracker</title>

  <!-- Auth guard -->
  <script>
    (function(){
      const ok = localStorage.getItem('auth_ok')==='1' &&
                 Number(localStorage.getItem('auth_until')||0) > Date.now();
      if(!ok){ window.location.href = '../index.html#login'; }
    })();
  </script>

  <!-- Fonts + site theme -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../style.css"/>

  <!-- Page-local styles (tidy grids + mobile) -->
  <style>
    :root{
      --card-bg:#fff; --card-br:#E7E9F2; --ink:#0f172a; --ink-2:#334155; --muted:#64748b;
      --pill:#3a1660; --pill-2:#a36bff; --focus:#a36bff33;
    }
    body.practice-page{ background:linear-gradient(180deg,#0f0b1a 0%, #130e22 55%, #0e0b18 100%); }

    .container{ max-width:1100px; margin:0 auto; padding:16px; display:grid; gap:16px;
      grid-template-columns: 1fr;
      grid-template-areas: "ctx" "clock" "drive" "play" "summary" "log"; }
    @media (min-width: 980px){
      .container{ gap:18px; grid-template-columns: 1fr 1fr;
        grid-template-areas: "ctx clock" "drive play" "summary summary" "log log"; }
    }

    .card{ background:var(--card-bg); border:1px solid var(--card-br); border-radius:18px; padding:18px;
      box-shadow:0 10px 24px rgba(2,8,23,.06); color:var(--ink);}
    .area-ctx{grid-area:ctx}.area-clock{grid-area:clock}.area-drive{grid-area:drive}
    .area-play{grid-area:play}.area-summary{grid-area:summary}.area-log{grid-area:log}

    .section-title{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
    .section-title h2{margin:0;font-size:1.25rem;line-height:1.15}
    .tiny{font-size:.9rem;color:var(--muted)}
    .chip{display:inline-block;padding:.35rem .7rem;border-radius:999px;background:#f3f4f7;border:1px solid #e5e7ef;font-weight:600;color:#4b5563}

    label{display:block;font-size:.95rem;color:var(--ink-2);margin:0 0 .35rem}
    input,select,textarea{ width:100%; padding:.72rem .85rem; border-radius:12px; border:2px solid #cfd6ea; background:#fff; color:#0f172a;
      box-shadow:0 1px 0 rgba(0,0,0,.02) inset; transition:border-color .15s, box-shadow .15s, background .15s; font-size:1rem; }
    input::placeholder, textarea::placeholder{ color:#9aa3b2 }
    input:focus,select:focus,textarea:focus{ outline:none; border-color:#a36bff; box-shadow:0 0 0 4px var(--focus); }
    input[disabled], select[disabled], textarea[disabled]{ background:#f6f7fb; color:#94a3b8; border-color:#e2e8f0; }

    /* tidy grid helpers */
    .row{display:grid; gap:12px}
    .row.cols-2{grid-template-columns:1fr 1fr}
    .row.cols-3{grid-template-columns:repeat(3,1fr)}
    .row.cols-4{grid-template-columns:repeat(4,1fr)}
    .row.cols-5{grid-template-columns:repeat(5,1fr)}
    @media (max-width:680px){ .row.cols-2,.row.cols-3,.row.cols-4,.row.cols-5{grid-template-columns:1fr} }

    .btnbar{display:flex;flex-wrap:wrap;gap:.5rem}
    .btn{appearance:none;border:1px solid var(--pill);background:var(--pill);color:#fff;cursor:pointer;
      padding:.65rem 1rem;border-radius:999px;font-weight:700;transition:transform .15s, box-shadow .15s, background .15s, border-color .15s}
    .btn:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(163,107,255,.22) }
    .btn.subtle{ background:#fff; color:var(--pill); border-color:#e2d6ff }
    .btn.warn{ background:#fde9d6; color:#7a3b01; border-color:#f5c899 }
    .btn.ghost{ background:#fff; color:#111827; border-color:#e5e7ef }
    .btn.small{ padding:.45rem .7rem; font-weight:700 }

    .clock-wrap{display:grid;grid-template-columns:auto 1fr;gap:16px;align-items:center}
    .clock-face{font-variant-numeric:tabular-nums;font-size:2.2rem;letter-spacing:.6px}
    .clock-keys{display:flex;flex-wrap:wrap;gap:.5rem}

    .toggle{ display:flex; flex-wrap:wrap; gap:.6rem; }
    .toggle-input{ position:absolute; opacity:0; pointer-events:none; }
    .toggle-btn{ position:relative; padding:.55rem .9rem .55rem 2.2rem; border-radius:999px; border:2px solid #e2e8f0;
      background:#fff; color:#111827; font-weight:800; cursor:pointer; transition:.15s}
    .toggle-btn::before{ content:""; position:absolute; left:.8rem; top:50%; transform:translateY(-50%);
      width:14px; height:14px; border-radius:50%; border:2px solid #cbd5e1; background:#fff; transition:all .15s }
    .toggle-input:checked + .toggle-btn{ background:linear-gradient(90deg, var(--pill), var(--pill-2)); color:#fff; border-color:transparent; box-shadow:0 8px 18px rgba(163,107,255,.24) }
    .toggle-input:checked + .toggle-btn::before{ content:"✓"; width:18px; height:18px; display:grid; place-items:center; border:none; background:#ffffff; color:#3a1660; font-size:.8rem; font-weight:900 }

    .kpi{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    #log{ max-height:260px; overflow:auto; background:#fbfbfe; border:1px solid #eef1f8; border-radius:12px; padding:10px; color:#1f2937 }

    /* Mobile thumb bar */
    .thumbbar{position:sticky;bottom:0;left:0;right:0;z-index:40;background:#0b0914cc;
      backdrop-filter:blur(6px);display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:10px}
    .thumbbar .btn{font-size:1.05rem;padding:.9rem 0;border-radius:14px}
    @media (min-width:980px){ .thumbbar{display:none} }
  </style>
</head>

<body class="practice-page">
  <header class="page-header">
    <h1>Primary / Drives</h1>
    <nav class="menu-actions" aria-label="Header navigation">
      <a href="game-day.html" class="menu-btn">Game Day</a>
      <a href="game-st.html" class="menu-btn">Special Teams</a>
      <a href="../index.html" class="menu-btn">Home</a>
    </nav>
  </header>

  <main>
    <div class="container">
      <!-- live Game/Drive/Play banner -->
      <div id="ctxBanner" class="chip tiny" aria-live="polite" style="grid-column:1 / -1"></div>

      <!-- ===== Game Context ===== -->
      <section class="card area-ctx">
        <div class="section-title">
          <h2>Game Context</h2>
          <span id="status" class="tiny">Ready</span>
        </div>

        <!-- Row 1: choose by date OR by Game ID -->
        <div class="row cols-3">
          <div>
            <label>Pick by Date</label>
            <input id="game_date" type="date" placeholder="YYYY-MM-DD"/>
          </div>
          <div>
            <label>Or: Game ID (from schedule)</label>
            <input id="game_id" list="list_game_ids" placeholder="e.g. G2025-01"/>
            <datalist id="list_game_ids"></datalist>
          </div>
          <div>
            <label>Week</label>
            <input id="game_week" placeholder="—" disabled/>
          </div>
        </div>

        <!-- Row 2: labels auto-filled from schedule -->
        <div class="row cols-3" style="margin-top:.4rem">
          <div><label>Our Team Label</label><input id="our_team" placeholder="Us" disabled/></div>
          <div><label>Opponent Label</label><input id="opp_team" placeholder="Opponent" disabled/></div>
          <div><label>Venue</label><input id="meta_ha_input" placeholder="H/A" disabled/></div>
        </div>

        <!-- Row 3: meta chips shown and editable weather preview -->
        <div class="row cols-2" style="margin-top:.4rem">
          <div><label>Weather (from schedule)</label><input id="meta_weather_input" placeholder="—" disabled/></div>
          <div class="btnbar" style="align-items:flex-end">
            <button class="btn subtle" id="pickNextBtn" type="button">Pick Next on Schedule</button>
            <span class="chip">Date or ID → Autofill teams</span>
          </div>
        </div>

        <div id="game_meta" class="row cols-3" aria-live="polite" style="margin-top:.6rem;display:none">
          <span class="chip" id="meta_date"></span>
          <span class="chip" id="meta_week"></span>
          <span class="chip" id="meta_opp"></span>
          <span class="chip" id="meta_ha"></span>
          <span class="chip" id="meta_weather"></span>
        </div>
      </section>

      <!-- ===== Game Clock ===== -->
      <section class="card area-clock">
        <div class="section-title">
          <h2>Game Clock</h2>
          <span class="tiny">Snap stamps Quarter + Clock into the Play form</span>
        </div>

        <div class="clock-wrap">
          <div>
            <label>Quarter</label>
            <select id="clk_quarter">
              <option value="1">Q1</option><option value="2">Q2</option>
              <option value="3">Q3</option><option value="4">Q4</option>
              <option value="OT">OT</option>
            </select>
          </div>
          <div>
            <label>Time (mm:ss)</label>
            <div class="clock-face" id="clk_display">15:00</div>
          </div>
        </div>

        <div class="clock-keys" style="margin-top:.8rem">
          <button class="btn pill-dark small" id="clk_start">Start</button>
          <button class="btn subtle small" id="clk_pause">Pause</button>
          <button class="btn warn small" id="clk_reset">Reset Q</button>

          <button class="btn ghost small" data-dt="-5">-5s</button>
          <button class="btn ghost small" data-dt="-1">-1s</button>
          <button class="btn ghost small" data-dt="+1">+1s</button>
          <button class="btn ghost small" data-dt="+5">+5s</button>

          <button class="btn pill-dark small" id="clk_snap">Snap → Play</button>
        </div>

        <div class="toggle" style="margin-top:.7rem">
          <input type="checkbox" id="auto_accum" class="toggle-input" checked>
          <button type="button" class="toggle-btn" data-for="auto_accum">Auto-accumulate possession time for active drive</button>
        </div>
      </section>

      <!-- ===== Drive Controls ===== -->
      <section class="card area-drive">
        <div class="section-title">
          <h2>Drive</h2>
          <span class="chip" id="driveBadge">No active drive</span>
        </div>

        <div class="btnbar" style="margin-bottom:.6rem">
          <button class="btn pill-dark" id="newDriveBtn">Start New Drive</button>
          <button class="btn warn" id="endDriveBtn" disabled>End / Save Drive</button>
        </div>

        <div class="row cols-2">
          <div><label>Active Drive ID</label><input id="drive_id" placeholder="auto" disabled/></div>
          <div><label>Team In Possession</label>
            <select id="drive_poss"><option>Us</option><option>Opponent</option></select>
          </div>
        </div>

        <div class="row cols-4">
          <div><label>Start Yardline (+/-)</label><input id="drive_start" type="number" step="1" placeholder="-25 = our 25, +40 = opp 40"/></div>
          <div><label>End Yardline (+/-)</label><input id="drive_end" type="number" step="1"/></div>
          <div><label>Plays in Drive</label><input id="drive_plays" type="number" step="1"/></div>
          <div><label>Yards Gained</label><input id="drive_yards" type="number" step="1" placeholder="auto from start/end"/></div>
        </div>

        <div class="row cols-3">
          <div><label>Possession Time (sec)</label><input id="drive_posstime" type="number" step="1" placeholder="auto from snaps"/></div>
          <div><label>Result</label>
            <select id="drive_result">
              <option value="">—</option><option>TD</option><option>FG</option><option>Punt</option>
              <option>TO on Downs</option><option>INT</option><option>Fumble</option>
              <option>End Half</option><option>End Game</option>
            </select>
          </div>
          <div><label>Scoring Type</label>
            <select id="drive_scoretype">
              <option value="">—</option><option>Rush TD</option><option>Pass TD</option><option>Return TD</option>
              <option>FG</option><option>Safety</option><option>PAT</option><option>2PT</option>
            </select>
          </div>
        </div>

        <div class="toggle" style="margin-top:.6rem">
          <input type="checkbox" id="auto_drive_yards" class="toggle-input" checked>
          <button type="button" class="toggle-btn" data-for="auto_drive_yards">Auto-calc Yards (end − start)</button>

          <input type="checkbox" id="auto_drive_plays" class="toggle-input" checked>
          <button type="button" class="toggle-btn" data-for="auto_drive_plays">Auto-count Plays in Drive</button>
        </div>
      </section>

      <!-- ===== Play Entry ===== -->
      <section class="card area-play">
        <div class="section-title">
          <h2>Play</h2>
        </div>

        <div class="btnbar" style="margin-bottom:.6rem">
          <button class="btn subtle" id="newPlayIdBtn">New Play ID</button>
          <button class="btn pill-dark" id="addPlayBtn">Add Play to Table</button>
          <span class="chip" id="playBadge">No play ID yet</span>
        </div>

        <div class="row cols-5">
          <div><label>Play ID</label><input id="play_id" placeholder="auto or click 'New Play ID'"/></div>
          <div><label>Drive ID</label><input id="play_drive_id" placeholder="auto from active drive" disabled/></div>
          <div><label>Offense Team</label>
            <select id="play_offense"><option>Us</option><option>Opponent</option></select>
          </div>
          <div><label>Quarter</label>
            <select id="play_qtr"><option>1</option><option>2</option><option>3</option><option>4</option><option>OT</option></select>
          </div>
          <div><label>Clock (mm:ss)</label><input id="play_clock" placeholder="12:34"/></div>
        </div>

        <div class="row cols-5">
          <div><label>Down</label><select id="play_down"><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
          <div><label>Distance (yds)</label><input id="play_dist" type="number" step="1"/></div>
          <div><label>Yard Line (+/-)</label><input id="play_yardline" type="number" step="1"/></div>
          <div><label>Play Type</label><select id="play_type"></select></div>
          <div><label>Result Yards</label><input id="play_yards" type="number" step="1"/></div>
        </div>

        <div class="row cols-4">
          <div><label>Formation</label><input id="play_form" list="list_formations" placeholder="e.g. Gun Trips"/></div>
          <div><label>Personnel</label><input id="play_pers" list="list_personnel" placeholder="e.g. 11, 12, 21"/></div>
          <div><label>Motion</label><input id="play_motion" list="list_motions" placeholder="Jet, Orbit, None"/></div>
          <div><label>Play Name (Playbook)</label><input id="play_name" list="list_playnames" placeholder="Type to autocomplete…"/></div>
        </div>

        <div class="toggle" style="margin-top:.4rem">
          <input type="checkbox" id="flag_explosive" class="toggle-input">
          <button type="button" class="toggle-btn" data-for="flag_explosive">Explosive</button>

          <input type="checkbox" id="flag_rz" class="toggle-input">
          <button type="button" class="toggle-btn" data-for="flag_rz">Red Zone</button>

          <input type="checkbox" id="flag_g2g" class="toggle-input">
          <button type="button" class="toggle-btn" data-for="flag_g2g">Goal-to-Go</button>

          <input type="checkbox" id="flag_2min" class="toggle-input">
          <button type="button" class="toggle-btn" data-for="flag_2min">Two-Minute</button>

          <input type="checkbox" id="flag_success" class="toggle-input">
          <button type="button" class="toggle-btn" data-for="flag_success">Success (EPA+)</button>
        </div>

        <div class="row cols-3" style="margin-top:.4rem">
          <div><label>EP Before</label><input id="ep_before" type="number" step="0.01"/></div>
          <div><label>EP After</label><input id="ep_after" type="number" step="0.01"/></div>
          <div><label>EPA</label><input id="epa" type="number" step="0.01" placeholder="auto if EP fields set"/></div>
        </div>

        <div class="toggle" style="margin-top:.6rem">
          <input type="checkbox" id="auto_offense_from_drive" class="toggle-input" checked>
          <button type="button" class="toggle-btn" data-for="auto_offense_from_drive">Auto: Offense = Drive Possession</button>

          <input type="checkbox" id="auto_epa" class="toggle-input" checked>
          <button type="button" class="toggle-btn" data-for="auto_epa">Auto: EPA = EP After − EP Before</button>

          <input type="checkbox" id="auto_next_yardline" class="toggle-input" checked>
          <button type="button" class="toggle-btn" data-for="auto_next_yardline">Auto: Next Yard Line = current + result yds</button>

          <input type="checkbox" id="auto_playbook_fill" class="toggle-input" checked>
          <button type="button" class="toggle-btn" data-for="auto_playbook_fill">Auto: Fill from Playbook selection</button>
        </div>

        <datalist id="list_formations"></datalist>
        <datalist id="list_personnel"></datalist>
        <datalist id="list_motions"></datalist>
        <datalist id="list_playnames"></datalist>
      </section>

      <!-- ===== Game Summary ===== -->
      <section class="card area-summary">
        <div class="section-title">
          <h2>Game Summary — Helpers</h2>
          <span class="tiny">Writes to <strong>05_Fact_GameSummary</strong></span>
        </div>
        <div class="kpi">
          <div><label>Team Points</label><input id="sum_pts_team" type="number" step="1"/></div>
          <div><label>Opponent Points</label><input id="sum_pts_opp" type="number" step="1"/></div>
          <div><label>Team Offensive Yards</label><input id="sum_yards" type="number" step="1"/></div>
          <div><label>First Downs</label><input id="sum_firstdowns" type="number" step="1"/></div>
          <div><label>Plays</label><input id="sum_plays" type="number" step="1"/></div>
          <div><label>Time of Poss (sec)</label><input id="sum_top" type="number" step="1"/></div>
          <div><label>Penalties</label><input id="sum_pens" type="number" step="1"/></div>
          <div><label>Penalty Yards</label><input id="sum_penyds" type="number" step="1"/></div>
          <div><label>Drives</label><input id="sum_drives" type="number" step="1"/></div>
          <div><label>Game Control (min)</label><input id="sum_gcmin" type="number" step="1"/></div>
          <div><label>Snap Count Total</label><input id="sum_snaps" type="number" step="1"/></div>
        </div>
        <div class="btnbar" style="margin-top:.6rem">
          <button class="btn pill-dark" id="saveSummaryBtn">Update Game Summary</button>
        </div>
      </section>

      <!-- ===== Log ===== -->
      <section class="card area-log">
        <div class="section-title"><h2>Log</h2><span class="tiny">Most recent first</span></div>
        <div id="log"></div>
      </section>
    </div>

    <!-- Mobile thumb bar -->
    <div class="thumbbar" aria-label="Quick actions">
      <button class="btn subtle" id="tb_snap">Snap</button>
      <button class="btn" id="tb_new">New Play</button>
      <button class="btn pill-dark" id="tb_save">Save</button>
      <button class="btn ghost" id="tb_undo">Undo</button>
    </div>
  </main>

  <footer><p>&copy; 2025 Game Speed Data Systems</p></footer>

  <!-- ===== Shared plumbing ===== -->
  <script>window.API_BASE='https://script.google.com/macros/s/AKfycbxQk6BgJLkZltXX7xijq9QKmTEfB51M65cHzrYCe6SCTykrSWnFDMecXfiLGRTd9iOCLg/exec';</script>
  <script src="../js/api.js"></script>
  <script src="../js/context.js"></script>

  <!-- ===== Page logic ===== -->
  <script>
    // Configure shared context + banner
    GameContext.configure({ apiBase: window.API_BASE, server: true, pollMs: 1000 });
    GameContext.mountBanner('#ctxBanner');
    GameContext.bindInputs({ game_id:'#game_id', drive_id:'#drive_id', play_id:'#play_id' });

    /* ========= Config & constants ========= */
    const DICT_SHEET_ID   = '1oHO-5gM9l3PTSjUxwQlYzFaAMTtlco2VZj8l315Uk1c'; // Master Data / dictionaries
    const PLAYBOOK_TAB    = 'Playbook_Dictionary';
    const EP_TAB          = 'EP_Table'; // optional
    const SCHEDULE_SHEET  = '1_PXbtnooI9gRxKF6h7BnjQdSVbnQV6D2gwX0zURqtlI';
    const SCHEDULE_TAB    = '01_Dim_Schedule';
    const ROUTE_DRIVES    = 'drives';
    const ROUTE_PLAYS     = 'plays';
    const ROUTE_SUM       = 'game_summary';
    const QUARTER_LEN     = 15*60, OT_LEN = 10*60;

    // your preferred label for "Our Team" (auto-appended with H/A)
    const OUR_TEAM_LABEL_DEFAULT = localStorage.getItem('our_team_label') || 'Us';

    /* ========= Log helper ========= */
    const el = id => document.getElementById(id);
    const logBox = el('log');
    function log(msg, type=''){
      const row = document.createElement('div');
      if(type==='success') row.className='success';
      if(type==='error') row.className='error';
      row.textContent = '['+new Date().toLocaleTimeString()+'] '+msg;
      logBox.prepend(row);
      el('status').textContent = (type==='error'?'Error':'Ready');
    }

    /* ========= State ========= */
    let activeDriveId = '';
    let drivePlayCount = 0;
    let driveElapsedSec = 0;
    let lastSnap = null;

    let playbook = [], playMap = {};
    let schedule = [], scheduleMap = {}, scheduleByDate = {};

    const options = {
      playTypes: ['Run','Pass','Sack','Kneel','Spike','Penalty only'],
      formations: [], personnel: [], motions: []
    };

    /* ========= Idempotent append + offline queue + undo ========= */
    const pendingKey = 'pendingWrites_v1';
    const undoStack = [];
    async function appendRow(route, row, ensure=[], idemKey=''){
      const payload = { action:'append', route, row, ensure_headers: ensure, idempotency_key: idemKey || row.play_id || row.drive_id || '' };
      try{
        const res = await apiPost(payload);
        if(!res.ok && res.error==='DUPLICATE'){ log('Duplicate ignored (idempotent).','success'); return res; }
        if(!res.ok) throw new Error(res.error||'Append failed');
        undoStack.push({route, key: row.play_id||row.drive_id||'', row});
        return res;
      }catch(err){
        const q = JSON.parse(localStorage.getItem(pendingKey)||'[]');
        q.push({route,row,ensure,idem:payload.idempotency_key,ts:Date.now()});
        localStorage.setItem(pendingKey, JSON.stringify(q));
        log('Offline: queued write.', 'error');
        return {ok:false, queued:true};
      }
    }
    setInterval(async ()=>{
      const q = JSON.parse(localStorage.getItem(pendingKey)||'[]');
      if(!q.length) return;
      try{
        const {route,row,ensure,idem} = q[0];
        const res = await apiPost({ action:'append', route, row, ensure_headers: ensure, idempotency_key: idem });
        if(res && res.ok){ q.shift(); localStorage.setItem(pendingKey, JSON.stringify(q)); log('Queued write flushed.','success'); }
      }catch(e){}
    }, 8000);

    /* ========= Helpers ========= */
    async function nextId(prefix){
      const res = await apiGet({ action:'next_id', prefix });
      if(!res.ok) throw new Error(res.error||'ID failed'); return res.id;
    }
    function ensureGame(){
      const gid = (el('game_id').value || GameContext.get().game_id || '').trim();
      if(!gid) throw new Error('Set a Game ID first (pick from schedule).');
      return gid;
    }
    const numVal = v => (v===''||v==null ? '' : Number(v));
    const boolVal = v => (v ? 1 : 0);

    /* ========= CLOCK ========= */
    let secLeft = QUARTER_LEN, clkTimer = null;
    function displayClock(){
      const m = String(Math.floor(secLeft/60)).padStart(2,'0');
      const s = String(secLeft%60).padStart(2,'0');
      el('clk_display').textContent = `${m}:${s}`;
    }
    function getQSeconds(){ return (el('clk_quarter').value==='OT') ? OT_LEN : QUARTER_LEN; }
    function startClock(){ if(clkTimer) return; clkTimer=setInterval(()=>{ if(secLeft>0){ secLeft--; displayClock(); } },1000); }
    function pauseClock(){ if(clkTimer){ clearInterval(clkTimer); clkTimer=null; } }
    function resetQuarter(){ pauseClock(); secLeft=getQSeconds(); displayClock(); }
    function nudgeSeconds(d){ secLeft=Math.max(0, Math.min(getQSeconds(), secLeft+d)); displayClock(); }
    function snapToPlay(){
      const q = el('clk_quarter').value;
      const m = String(Math.floor(secLeft/60)).padStart(2,'0');
      const s = String(secLeft%60).padStart(2,'0');
      el('play_qtr').value = q;
      el('play_clock').value = `${m}:${s}`;

      if(el('auto_accum').checked && activeDriveId){
        if(lastSnap){
          const qIndex = x => x==='OT' ? 5 : Number(x);
          const lenForQ = x => x==='OT' ? OT_LEN : QUARTER_LEN;
          let elapsed = 0;
          if(qIndex(q) === qIndex(lastSnap.q)){
            elapsed = Math.max(0, lastSnap.secLeft - secLeft);
          }else{
            elapsed += lastSnap.secLeft;
            for(let k=qIndex(lastSnap.q)+1; k<qIndex(q); k++){
              elapsed += (k===5 ? OT_LEN : QUARTER_LEN);
            }
            elapsed += (lenForQ(q) - secLeft);
          }
          driveElapsedSec += elapsed;
          el('drive_posstime').value = Math.round(driveElapsedSec);
        }
        lastSnap = { q, secLeft };
      }
    }
    el('clk_start').onclick=startClock; el('clk_pause').onclick=pauseClock; el('clk_reset').onclick=resetQuarter;
    el('clk_snap').onclick=snapToPlay; document.querySelectorAll('.clock-keys .btn[data-dt]')
      .forEach(b=>b.addEventListener('click',()=>nudgeSeconds(parseInt(b.dataset.dt,10))));
    el('clk_quarter').addEventListener('change', resetQuarter); displayClock();

    /* ========= PLAYBOOK ========= */
    function fillDatalist(id, arr){ const dl=el(id); dl.innerHTML=''; arr.forEach(v=>{ const o=document.createElement('option'); o.value=v; dl.appendChild(o); }); }
    function fillSelect(id, arr){ const s=el(id); s.innerHTML=''; arr.forEach(v=>{ const o=document.createElement('option'); o.textContent=v; s.appendChild(o); }); }
    fillSelect('play_type', options.playTypes);

    async function loadPlaybook(){
      try{
        const res = await apiGet({ action:'table', sheet_id: DICT_SHEET_ID, sheet_name: PLAYBOOK_TAB });
        if(!res.ok) throw new Error(res.error || 'Playbook fetch failed');
        playbook = res.rows || []; playMap = {};
        const names=new Set(), forms=new Set(), pers=new Set(), mot=new Set();
        playbook.forEach(r=>{
          const name = (r.play_name||'').toString().trim();
          if(name){ names.add(name); playMap[name.toUpperCase()] = r; }
          if(r.formation) forms.add(String(r.formation));
          if(r.personnel) pers.add(String(r.personnel));
          if(r.motion)    mot.add(String(r.motion));
        });
        fillDatalist('list_playnames', Array.from(names).sort());
        options.formations = Array.from(forms).sort();
        options.personnel  = Array.from(pers).sort();
        options.motions    = Array.from(mot).sort();
        fillDatalist('list_formations', options.formations);
        fillDatalist('list_personnel',  options.personnel);
        fillDatalist('list_motions',    options.motions);
        log(`Playbook loaded (${playbook.length} rows).`, 'success');
      } catch(err){ log(err.message, 'error'); }
    }
    el('play_name').addEventListener('change', ()=>{
      if(!el('auto_playbook_fill').checked) return;
      const key = el('play_name').value.trim().toUpperCase();
      const rec = playMap[key];
      if(rec){
        if(rec.play_type && options.playTypes.includes(rec.play_type)) el('play_type').value = rec.play_type;
        if(rec.formation) el('play_form').value = rec.formation;
        if(rec.personnel) el('play_pers').value = rec.personnel;
        if(rec.motion)    el('play_motion').value = rec.motion;
      }
    });

    /* ========= SCHEDULE ========= */
    async function loadSchedule(){
      try{
        const res = await apiGet({ action:'table', sheet_id: SCHEDULE_SHEET, sheet_name: SCHEDULE_TAB });
        if(!res.ok) throw new Error(res.error || 'Schedule fetch failed');
        schedule = (res.rows || []).filter(r => r.game_id);
        scheduleMap = {}; scheduleByDate = {};
        const ids=[];
        schedule.forEach(r=>{
          const gid=String(r.game_id).trim(); if(!gid) return;
          scheduleMap[gid]=r; ids.push(gid);
          const d=(r.date||'').toString().slice(0,10); if(d) scheduleByDate[d]=r;
        });
        ids.sort((a,b)=>{
          const ra=scheduleMap[a], rb=scheduleMap[b];
          const da=(ra.date||''), db=(rb.date||'');
          if(da && db && da!==db) return da<db?-1:1;
          const wa=Number(ra.week||0), wb=Number(rb.week||0);
          return wa-wb;
        });
        fillDatalist('list_game_ids', ids);
        log(`Schedule loaded (${ids.length} games).`, 'success');

        // hydrate from GameContext if set elsewhere
        const ctx = GameContext.get();
        if (ctx.game_id && scheduleMap[ctx.game_id]) {
          applyGameRow(scheduleMap[ctx.game_id]);
        }
      } catch(err){ log(err.message, 'error'); }
    }

    function applyGameRow(r){
      if(!r) return;
      const gid = String(r.game_id).trim();
      el('game_id').value = gid;
      el('game_date').value = (r.date||'').toString().slice(0,10);
      el('game_week').value = r.week || '';

      // labels auto from schedule
      const ha = (r.home_away||'').toString().trim(); // H/A
      el('our_team').value = OUR_TEAM_LABEL_DEFAULT + (ha ? ` (${ha})` : '');
      el('opp_team').value = r.opponent || 'Opponent';

      // meta chips + mirrored inputs
      el('meta_date').textContent    = r.date ? `Date: ${r.date}` : 'Date: —';
      el('meta_week').textContent    = r.week ? `Week: ${r.week}` : 'Week: —';
      el('meta_opp').textContent     = r.opponent ? `Opponent: ${r.opponent}` : 'Opponent: —';
      el('meta_ha').textContent      = ha ? `Venue: ${ha}` : 'Venue: —';
      el('meta_weather').textContent = r.weather_conditions ? `Weather: ${r.weather_conditions}` : 'Weather: —';
      el('meta_ha_input').value      = ha || '';
      el('meta_weather_input').value = r.weather_conditions || '';
      el('game_meta').style.display='grid';

      GameContext.setGame(gid);
      log(`Game selected: ${gid} vs ${r.opponent||'—'}`, 'success');
    }

    // Pick by Game ID
    el('game_id').addEventListener('change', ()=>{
      const gid = el('game_id').value.trim(); if(!gid) return;
      const r = scheduleMap[gid];
      if(!r){ log(`Game ID "${gid}" not found in schedule.`, 'error'); return; }
      applyGameRow(r);
    });

    // Pick by Date
    el('game_date').addEventListener('change', ()=>{
      const d = el('game_date').value;
      const r = scheduleByDate[d];
      if(!r){ log(`No game on ${d} found in schedule.`, 'error'); return; }
      applyGameRow(r);
    });

    // Next game helper
    el('pickNextBtn').addEventListener('click', ()=>{
      if(!schedule.length) return;
      const today = new Date().toISOString().slice(0,10);
      const nextRow = schedule.find(r => (String(r.date||'').slice(0,10)) >= today) || schedule[0];
      applyGameRow(nextRow);
    });

    /* ========= QoL: mirror drive→play offense ========= */
    el('drive_poss').addEventListener('change', ()=>{
      if(el('auto_offense_from_drive').checked) el('play_offense').value = el('drive_poss').value;
    });

    /* ========= EP/EPA helpers (optional table) ========= */
    let EPIndex = null, epReady = false;
    const binDist = d => (Number(d)<=3 ? 'S' : Number(d)<=7 ? 'M' : 'L');
    const clamp01 = (x,min,max)=>Math.max(min,Math.min(max,x));
    const toAbsYL = yl => clamp01(50 + Number(yl||0), 0, 100);
    const binYL   = yl => Math.round(toAbsYL(yl)/5)*5;
    function autoExplosive(type, yards){ const y=Number(yards||0); return (type==='Run' && y>=10) || (type==='Pass' && y>=20) ? 1 : 0; }
    function autoRZ(yl){ return Number(yl||0) >= 20 ? 1 : 0; }
    function yardsToGoal(yl){ return 100 - toAbsYL(yl); }
    function autoG2G(yl, dist){ const ytg=yardsToGoal(yl); return (ytg && dist) ? (Number(ytg)===Number(dist) ? 1 : 0) : 0; }
    function autoTwoMin(q, mmss){
      if(q==='2' || q==='4'){ const [m,s]=(mmss||'0:00').split(':').map(Number); return (m<2 || (m===2&&s===0)) ? 1 : 0; }
      return 0;
    }
    function computeNextDnD(down, dist, resultYds){
      let d=Number(down), t=Number(dist), y=Number(resultYds);
      if([d,t].some(n=>isNaN(n))) return {down:'',dist:''};
      if(y >= t) return {down:1, dist:10};
      return {down: Math.min(4,d+1), dist: Math.max(1, t-y)};
    }
    function getUnit(){ return (el('drive_poss').value === 'Us') ? 'Offense' : 'Defense'; }

    async function loadEPTable(){
      try{
        const res = await apiGet({ action:'table', sheet_id: DICT_SHEET_ID, sheet_name: EP_TAB });
        if(!res.ok) throw new Error(res.error||'EP table fetch failed');
        EPIndex = {};
        (res.rows||[]).forEach(r=>{
          const k = `${r.down}|${String(r.dist_bin||'').toUpperCase()}|${Number(r.yl_bin)}`;
          EPIndex[k] = Number(r.ep||0);
        });
        epReady = Object.keys(EPIndex).length>0;
        log(`EP table loaded (${Object.keys(EPIndex).length} keys).`,'success');
      }catch(e){ /* optional */ }
    }
    function epLookup(down, dist, yl){
      if(!epReady) return '';
      const key = `${down}|${binDist(Number(dist||0))}|${binYL(yl)}`;
      return (EPIndex[key] ?? '');
    }

    /* ========= DRIVES ========= */
    el('newDriveBtn').addEventListener('click', async ()=>{
      try{
        ensureGame();
        activeDriveId = await nextId('DRIVE');
        drivePlayCount = 0; driveElapsedSec = 0; lastSnap = null;
        el('drive_id').value = activeDriveId;
        el('play_drive_id').value = activeDriveId;
        el('driveBadge').textContent = `Active: ${activeDriveId}`;
        el('endDriveBtn').disabled = false;
        if(el('auto_offense_from_drive').checked){
          el('play_offense').value = el('drive_poss').value;
        }
        GameContext.setDrive(activeDriveId);
        log(`Started drive ${activeDriveId}`, 'success');
      } catch(err){ log(err.message, 'error'); }
    });

    el('endDriveBtn').addEventListener('click', async ()=>{
      try{
        const game_id = ensureGame();
        if(!activeDriveId) throw new Error('No active drive to end.');

        if(el('auto_drive_yards').checked && el('drive_yards').value==='' &&
           el('drive_start').value!=='' && el('drive_end').value!==''){
          el('drive_yards').value = Number(el('drive_end').value) - Number(el('drive_start').value);
        }
        if(el('auto_drive_plays').checked && el('drive_plays').value===''){
          el('drive_plays').value = drivePlayCount;
        }

        const row = {
          game_id,
          drive_id: activeDriveId,
          unit: getUnit(),
          'Team In Possession': el('drive_poss').value,
          'Start Yardline': numVal(el('drive_start').value),
          'End Yardline':   numVal(el('drive_end').value),
          'Plays in Drive': numVal(el('drive_plays').value),
          'Yards Gained':   numVal(el('drive_yards').value),
          'Possession Time (sec)': numVal(el('drive_posstime').value),
          'Result': el('drive_result').value,
          'Scoring Type': el('drive_scoretype').value
        };
        await appendRow(ROUTE_DRIVES, row, Object.keys(row), activeDriveId);
        log(`Drive saved: ${activeDriveId}`, 'success');

        // handoff to ST page for Punt/FG
        const res = el('drive_result').value;
        if(res==='Punt' || res==='FG'){ setTimeout(()=>{ window.location.href='game-st.html'; }, 400); }

        el('driveBadge').textContent = 'No active drive';
        el('endDriveBtn').disabled = true;
        activeDriveId = '';
        el('drive_id').value = '';
        el('play_drive_id').value = '';
        GameContext.setDrive('');
      } catch(err){ log(err.message, 'error'); }
    });

    /* ========= PLAYS ========= */
    el('newPlayIdBtn').addEventListener('click', async ()=>{
      try{
        const id = await nextId('PLAY');
        el('play_id').value = id;
        el('playBadge').textContent = `Editing: ${id}`;
        GameContext.setPlay(id);
      } catch(err){ log(err.message, 'error'); }
    });

    el('addPlayBtn').addEventListener('click', async ()=>{
      try{
        const game_id = ensureGame();
        const play_id = el('play_id').value.trim(); if(!play_id) throw new Error('Create a Play ID first.');
        const drive_id = activeDriveId || el('play_drive_id').value.trim();
        if(!drive_id) throw new Error('No drive_id (start a drive or paste one).');

        if(el('auto_offense_from_drive').checked){
          el('play_offense').value = el('drive_poss').value;
        }

        const row = {
          play_id, drive_id, game_id,
          unit: getUnit(),
          'Offense Team': el('play_offense').value,
          Quarter: el('play_qtr').value,
          Clock: el('play_clock').value,
          Down: el('play_down').value,
          Distance: numVal(el('play_dist').value),
          'Yard Line': numVal(el('play_yardline').value),
          'Play Type': el('play_type').value,
          Formation: el('play_form').value,
          Personnel: el('play_pers').value,
          Motion: el('play_motion').value,
          'Result Yards': numVal(el('play_yards').value),
          'Explosive Flag': 0,
          'Red Zone Flag': 0,
          'Goal-to-Go Flag': 0,
          'Two-Minute Flag': 0,
          'EP Before': '',
          'EP After':  '',
          EPA: '',
          'Success Flag': 0,
          for_us_epa: '',
          for_us_success: 0
        };

        // auto flags
        row['Explosive Flag'] = (el('flag_explosive').checked) ? 1 : (function(t,y){const n=Number(y||0);return (t==='Run'&&n>=10)||(t==='Pass'&&n>=20)?1:0;})(row['Play Type'],row['Result Yards']);
        row['Red Zone Flag']  = (el('flag_rz').checked) || (Number(row['Yard Line']||0)>=20) ? 1 : 0;
        row['Goal-to-Go Flag']= (el('flag_g2g').checked) || (function(yl,dist){ const ytg=100 - (50 + Number(yl||0)); return (ytg && dist) ? (Number(ytg)===Number(dist) ? 1 : 0) : 0; })(row['Yard Line'], row['Distance']);
        row['Two-Minute Flag']= (el('flag_2min').checked) ? 1 : (function(q,mmss){ if(q==='2'||q==='4'){ const [m,s]=(mmss||'0:00').split(':').map(Number); return (m<2|| (m===2&&s===0))?1:0;} return 0; })(row.Quarter,row.Clock);

        // EP/EPA (if EP table present)
        if(epReady && row.Down && row.Distance!=='' && row['Yard Line']!==''){
          const epb = epLookup(row.Down, row.Distance, row['Yard Line']);
          const next = (function(down,dist,y){ let d=Number(down),t=Number(dist),z=Number(y); if(z>=t) return {down:1,dist:10}; return {down:Math.min(4,d+1),dist:Math.max(1,t-z)}; })(row.Down,row.Distance,row['Result Yards']);
          const nextYL = (el('auto_next_yardline').checked && el('play_yardline').value!=='' && el('play_yards').value!=='')
                         ? Number(el('play_yardline').value) + Number(el('play_yards').value)
                         : row['Yard Line'];
          const epaft = (next.down && next.dist) ? epLookup(next.down, next.dist, nextYL) : '';
          if(epb!=='' && epaft!==''){
            row['EP Before'] = Number(epb.toFixed ? epb.toFixed(2) : epb);
            row['EP After']  = Number(epaft.toFixed ? epaft.toFixed(2) : epaft);
            row.EPA          = Number((row['EP After'] - row['EP Before']).toFixed(2));
            row['Success Flag'] = row.EPA>0 ? 1 : 0;
          }
        }

        const offenseUs = row['Offense Team'] === 'Us';
        row.for_us_success = offenseUs ? row['Success Flag'] : (row['Success Flag'] ? 0 : 1);
        row.for_us_epa     = (row.EPA==='' ? '' : (offenseUs ? row.EPA : -Number(row.EPA)));

        await appendRow(ROUTE_PLAYS, row, Object.keys(row), play_id);
        log(`Play saved: ${play_id}`, 'success');

        if(activeDriveId) drivePlayCount++;

        if(el('auto_next_yardline').checked && el('play_yardline').value!=='' && el('play_yards').value!==''){
          el('play_yardline').value = String(Number(el('play_yardline').value) + Number(el('play_yards').value));
        }

        GameContext.setPlay(play_id);

        const next = (function(down,dist,y){ let d=Number(down),t=Number(dist),z=Number(y); if(z>=t) return {down:1,dist:10}; return {down:Math.min(4,d+1),dist:Math.max(1,t-z)}; })(row.Down,row.Distance,row['Result Yards']);
        if(next.down) el('play_down').value = String(next.down);
        if(next.dist) el('play_dist').value = String(next.dist);

        el('play_id').value = ''; el('playBadge').textContent = 'No play ID yet';
        ['play_yards','ep_before','ep_after','epa'].forEach(i=>{ if(el(i)) el(i).value=''; });
        ['flag_explosive','flag_rz','flag_g2g','flag_2min','flag_success'].forEach(i=>{ if(el(i)) el(i).checked=false; });
        refreshToggleStates();
      } catch(err){ log(err.message, 'error'); }
    });

    /* ========= SUMMARY ========= */
    el('saveSummaryBtn').addEventListener('click', async ()=>{
      try{
        const game_id = ensureGame();
        const row = {
          game_id,
          'Team Points': numVal(el('sum_pts_team').value),
          'Opponent Points': numVal(el('sum_pts_opp').value),
          'Team Offensive Yards': numVal(el('sum_yards').value),
          'First Downs': numVal(el('sum_firstdowns').value),
          'Plays': numVal(el('sum_plays').value),
          'Time of Possession (sec)': numVal(el('sum_top').value),
          'Penalties': numVal(el('sum_pens').value),
          'Penalty Yards': numVal(el('sum_penyds').value),
          'Drives': numVal(el('sum_drives').value),
          'game_control_minutes': numVal(el('sum_gcmin').value),
          'snap_count_total': numVal(el('sum_snaps').value)
        };
        await appendRow(ROUTE_SUM, row, Object.keys(row), `${game_id}|summary`);
        log('Game summary updated.', 'success');
      } catch(err){ log(err.message, 'error'); }
    });

    /* ========= Toggles + init ========= */
    function wireToggles(){
      document.querySelectorAll('.toggle-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-for');
          const box = document.getElementById(id);
          if(!box) return;
          box.checked = !box.checked;
          btn.setAttribute('aria-pressed', box.checked ? 'true' : 'false');
        });
      });
      refreshToggleStates();
    }
    function refreshToggleStates(){
      document.querySelectorAll('.toggle-btn').forEach(btn=>{
        const id = btn.getAttribute('data-for');
        const box = document.getElementById(id);
        btn.setAttribute('aria-pressed', box && box.checked ? 'true' : 'false');
      });
    }

    // Thumb bar actions + Undo
    el('tb_snap').onclick = ()=> el('clk_snap').click();
    el('tb_new').onclick  = ()=> el('newPlayIdBtn').click();
    el('tb_save').onclick = ()=> el('addPlayBtn').click();
    el('tb_undo').onclick = async ()=>{
      const last = undoStack.pop(); if(!last){ log('Nothing to undo.'); return; }
      try{
        const res = await apiPost({ action:'delete_last', route:last.route, key:last.key });
        if(!res.ok) throw new Error(res.error||'Undo failed');
        log('Last entry undone.','success');
      }catch(e){ log(e.message,'error'); }
    };

    wireToggles();
    loadPlaybook();
    loadSchedule();
    loadEPTable();
    if (el('game_id').value.trim()) GameContext.setGame(el('game_id').value.trim());
  </script>
</body>
</html>
