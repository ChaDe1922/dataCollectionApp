<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>D-Line (DL) – Football Data Tracker</title>

  <!-- Auth guard -->
  <script>
    (function(){
      const ok = localStorage.getItem('auth_ok')==='1' &&
                 Number(localStorage.getItem('auth_until')||0) > Date.now();
      if(!ok){ window.location.href = '../index.html#login'; }
    })();
  </script>

  <!-- Fonts + site theme -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../style.css"/>

  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --ok:#1bbf83; --warn:#ffa142; --err:#ff6b6b;
      --pill:#3a1660; --pill-2:#a36bff; --bd:#E7E9F2; --card:#fff; --halo:#a36bff33;
    }
    body.practice-page{ background:linear-gradient(180deg,#0f0b1a 0%, #130e22 55%, #0e0b18 100%); }
    .container{
      max-width:1100px; margin:0 auto; padding:16px; display:grid; gap:16px;
      grid-template-columns: 1fr; grid-template-areas:
        "ctx" "active" "quick" "table" "run" "rush" "pen" "log";
    }
    @media (min-width: 980px){
      .container{ grid-template-columns: 1fr 1fr; grid-template-areas:
        "ctx    active"
        "quick  quick"
        "table  table"
        "run    rush"
        "pen    pen"
        "log    log";
      }
    }
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:18px; padding:18px; box-shadow:0 10px 24px rgba(2,8,23,.06); color:var(--ink); }
    .area-ctx{grid-area:ctx} .area-active{grid-area:active} .area-quick{grid-area:quick}
    .area-table{grid-area:table} .area-run{grid-area:run} .area-rush{grid-area:rush}
    .area-pen{grid-area:pen} .area-log{grid-area:log}

    .section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .section-title h2{margin:0;font-size:1.2rem}
    .tiny{font-size:.9rem;color:var(--muted)}
    .chip{display:inline-block;padding:.35rem .7rem;border-radius:999px;background:#f3f4f7;border:1px solid #e5e7ef;font-weight:600;color:#4b5563}
    label{display:block;font-size:.95rem;color:#334155;margin:0 0 .35rem}
    input,select,textarea{
      width:100%; padding:.7rem .85rem; border-radius:12px; border:2px solid #cfd6ea; background:#fff;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    input:focus,select:focus,textarea:focus{ outline:none; border-color:#a36bff; box-shadow:0 0 0 4px var(--halo); }

    .row{display:grid; gap:12px}
    .row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:repeat(3,1fr)} .row.cols-4{grid-template-columns:repeat(4,1fr)}
    @media (max-width:720px){ .row.cols-2,.row.cols-3,.row.cols-4{grid-template-columns:1fr} }

    .btnbar{display:flex;gap:.5rem;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--pill);background:var(--pill);color:#fff;cursor:pointer;padding:.6rem 1rem;border-radius:999px;font-weight:800}
    .btn:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(163,107,255,.22)}
    .btn.subtle{background:#fff;color:var(--pill);border-color:#e2d6ff}
    .btn.warn{background:#fde9d6;color:#7a3b01;border-color:#f5c899}
    .btn.ghost{background:#fff;color:#111827;border-color:#e5e7ef}
    .btn.small{padding:.45rem .7rem}

    /* Active chips */
    .chiplist{display:flex;gap:.4rem;flex-wrap:wrap}
    .chipitem{display:flex;align-items:center;gap:.4rem;padding:.35rem .6rem;border:1px solid #e5e7ef;background:#f9fafb;border-radius:999px;cursor:pointer}
    .chipitem.active{outline:2px solid #a36bff; background:#f6f1ff}
    .chipitem .rm{background:transparent;border:none;color:#475569;cursor:pointer;font-weight:900}

    /* Table */
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead th{ text-align:left; font-size:.9rem; color:#475569; border-bottom:1px solid #e5e7ef; padding:.45rem .4rem; position:sticky; top:0; background:#fff; }
    tbody td{ padding:.35rem .3rem; border-bottom:1px solid #f1f5f9; }
    tbody tr:hover{ background:#fafaff; }
    .num{ width:84px; }

    #log{ max-height:220px; overflow:auto; background:#fbfbfe; border:1px solid #eef1f8; border-radius:12px; padding:10px; color:#1f2937 }
    .success{color:var(--ok)} .error{color:var(--err)}
  </style>
</head>

<body class="practice-page">
  <header class="page-header">
    <h1>Defensive Line (DL)</h1>
    <nav class="menu-actions" aria-label="Header">
      <a href="game-day.html" class="menu-btn">Game Day</a>
      <a href="game-primary.html" class="menu-btn">Primary / Drives</a>
      <a href="../index.html" class="menu-btn">Home</a>
    </nav>
  </header>

  <main>
    <div class="container">
      <!-- ===== Game Context ===== -->
      <section class="card area-ctx">
        <div class="section-title">
          <h2>Game Context</h2>
          <span id="status" class="tiny">Ready</span>
        </div>
        <div class="row cols-3">
          <div><label>Game ID</label><input id="ctx_game" placeholder="G2025-01" disabled></div>
          <div><label>Drive ID</label><input id="ctx_drive" placeholder="DRIVE_…" disabled></div>
          <div><label>Play ID</label><input id="ctx_play" placeholder="PLAY_…" disabled></div>
        </div>
        <div class="tiny" style="margin-top:.4rem">
          Use <strong>Game Primary</strong> to start drives, snap the clock, and generate Play IDs. This page focuses on DL production.
        </div>
      </section>

      <!-- ===== Active DLs (Presence) ===== -->
      <section class="card area-active">
        <div class="section-title"><h2>Active DL</h2><span class="tiny">Presence group: <strong>DL</strong></span></div>

        <div class="row cols-3">
          <div>
            <label>Add Player</label>
            <input id="add_player" list="dl_players" placeholder="Type name or #…">
            <datalist id="dl_players"></datalist>
          </div>
          <div>
            <label>Front / Package</label>
            <input id="pkg" list="dl_pkg" placeholder="4-2-5, 3-3-5, Bear, Nickel…">
            <datalist id="dl_pkg">
              <option>Base 4-2-5</option><option>Base 3-3-5</option><option>Bear</option><option>Nickel</option><option>Dime</option>
            </datalist>
          </div>
          <div>
            <label>Unit Label</label>
            <input id="unit" placeholder="DL">
          </div>
        </div>

        <div class="chiplist" id="active_chips" style="margin-top:.5rem" aria-live="polite"></div>

        <div class="btnbar" style="margin-top:.6rem">
          <button class="btn" id="presenceSetBtn">Set Presence (DL)</button>
          <button class="btn subtle" id="presenceLoadBtn">Load From Presence</button>
          <span class="chip tiny" id="activeCount">0 active</span>
          <span class="chip tiny" id="selCount">0 selected</span>
        </div>
      </section>

      <!-- ===== Quick Events ===== -->
      <section class="card area-quick">
        <div class="section-title"><h2>Quick Events</h2><span class="tiny">Apply to selected chips (or all if none selected)</span></div>
        <div class="btnbar">
          <button class="btn small" data-ev="solo">+ Solo</button>
          <button class="btn small" data-ev="assist">+ Assist</button>
          <button class="btn small" data-ev="missed">+ Missed</button>
          <button class="btn small" data-ev="tfl">+ TFL</button>
          <button class="btn small" data-ev="sack">+ Sack</button>
          <button class="btn small" data-ev="ff">+ FF</button>
          <button class="btn small" data-ev="fr">+ FR</button>
          <button class="btn small" data-ev="safety">+ Safety</button>
          <button class="btn ghost small" id="clearEventsBtn">Clear row(s)</button>
        </div>
      </section>

      <!-- ===== Per-Player Table ===== -->
      <section class="card area-table">
        <div class="section-title"><h2>Per-Player Production</h2><span class="tiny">Writes to <strong>32_Fact_Tackles</strong></span></div>

        <div style="overflow:auto; border:1px solid #eef1f8; border-radius:12px;">
          <table id="tbl">
            <thead>
              <tr>
                <th style="min-width:180px">Player</th>
                <th class="num">Solo</th>
                <th class="num">Assist</th>
                <th class="num">Missed</th>
                <th class="num">TFL</th>
                <th class="num">Sack</th>
                <th class="num">FF</th>
                <th class="num">FR</th>
                <th class="num">FR Yds</th>
                <th>FR TD</th>
                <th>Safety</th>
                <th>Penalty</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="btnbar" style="margin-top:.6rem">
          <button class="btn" id="saveTacklesBtn">Save Tackles / Takeaways</button>
        </div>
      </section>

      <!-- ===== Run Defense (DL) ===== -->
      <section class="card area-run">
        <div class="section-title"><h2>Run Defense</h2><span class="tiny">Writes to <strong>31_Fact_RunDefense</strong></span></div>
        <div class="row cols-3">
          <div>
            <label>Gap</label>
            <select id="rd_gap">
              <option>A</option><option selected>B</option><option>C</option><option>D</option>
            </select>
          </div>
          <div>
            <label>Integrity</label>
            <select id="rd_integrity"><option selected>Maintained</option><option>Lost</option></select>
          </div>
          <div>
            <label>Result</label>
            <select id="rd_result">
              <option value="">—</option><option>Run Stop</option><option>TFL</option><option>Missed Tackle</option>
            </select>
          </div>
        </div>
        <div class="btnbar" style="margin-top:.6rem">
          <button class="btn subtle" id="saveRunDefBtn">Save Run Defense for Selected</button>
        </div>
      </section>

      <!-- ===== Pass Rush (DL) ===== -->
      <section class="card area-rush">
        <div class="section-title"><h2>Pass Rush</h2><span class="tiny">Writes to <strong>30_Fact_PassRush</strong></span></div>
        <div class="row cols-4">
          <div><label>Rush Move</label>
            <input id="pr_move" list="dl_moves" placeholder="Speed, Power, Swim…">
            <datalist id="dl_moves">
              <option>Speed</option><option>Power</option><option>Bull</option><option>Rip</option><option>Swim</option><option>Spin</option><option>Club</option><option>Inside</option><option>Counter</option><option>Stunt</option><option>Twist</option><option>Contain</option>
            </datalist>
          </div>
          <div><label>Pressure</label><select id="pr_pressure"><option>1</option><option selected>0</option></select></div>
          <div><label>QB Hit</label><select id="pr_hit"><option>1</option><option selected>0</option></select></div>
          <div><label>Sack</label><select id="pr_sack"><option>1</option><option selected>0</option></select></div>
        </div>
        <div class="row cols-3">
          <div><label>Hurry</label><select id="pr_hurry"><option>1</option><option selected>0</option></select></div>
          <div><label>Batted Pass</label><select id="pr_batted"><option>1</option><option selected>0</option></select></div>
          <div><label>Double Team Faced</label><select id="pr_double"><option>1</option><option selected>0</option></select></div>
        </div>
        <div class="row cols-2">
          <div><label>Double Win</label><select id="pr_double_win"><option>1</option><option selected>0</option></select></div>
          <div><label>Time to Pressure (sec)</label><input id="pr_ttp" type="number" step="0.01" placeholder="e.g. 2.45"/></div>
        </div>
        <div class="btnbar" style="margin-top:.6rem">
          <button class="btn subtle" id="saveRushBtn">Save Rush for Selected</button>
        </div>
      </section>

      <!-- ===== Penalties (DL) ===== -->
      <section class="card area-pen">
        <div class="section-title"><h2>Penalty (DL)</h2><span class="tiny">Writes to <strong>26_Fact_Penalties</strong></span></div>
        <div class="row cols-3">
          <div><label>Penalty Type</label><input id="pen_type" list="pen_types" placeholder="Offside, Holding…"><datalist id="pen_types"></datalist></div>
          <div><label>Penalty Yards</label><input id="pen_yards" type="number" step="1" placeholder="5 / 10 / 15"/></div>
          <div class="btnbar" style="align-items:end"><button class="btn warn" id="savePenaltyBtn">Save Penalty for Selected</button></div>
        </div>
      </section>

      <!-- ===== Log ===== -->
      <section class="card area-log">
        <div class="section-title"><h2>Log</h2><span class="tiny">Most recent first</span></div>
        <div id="log"></div>
      </section>
    </div>
  </main>

  <footer><p>&copy; 2025 Game Speed Data Systems</p></footer>

  <!-- === Shared plumbing === -->
  <script>
    // Configure GameContext auto-sync
    window.GSDS_API_BASE   = 'https://script.google.com/macros/s/AKfycbxQk6BgJLkZltXX7xijq9QKmTEfB51M65cHzrYCe6SCTykrSWnFDMecXfiLGRTd9iOCLg/exec';
    window.GSDS_SERVER_SYNC = true;
    window.GSDS_POLL_MS     = 1000;
  </script>
  <script src="../js/api.js"></script>
  <script src="../js/context.js"></script>
  <script src="../js/presence.js"></script>

  <!-- === Page logic === -->
  <script>
  (function(){
    // ---- Routes ----
    const ROUTE_TACKLES   = 'tackles';      // 32_Fact_Tackles
    const ROUTE_PASS_RUSH = 'pass_rush';    // 30_Fact_PassRush
    const ROUTE_RUN_DEF   = 'run_defense';  // 31_Fact_RunDefense
    const ROUTE_PEN       = 'penalties';    // 26_Fact_Penalties

    // ---- Roster source ----
    const ROSTER_SHEET_ID = '1oHO-5gM9l3PTSjUxwQlYzFaAMTtlco2VZj8l315Uk1c'; // MASTER_DATA_2025
    const ROSTER_TAB      = '00_Dim_Roster';
    const DL_POS = ['DL','DE','DT','NT','EDGE','IDL','LEO','END','TACKLE'];

    // Header safelists
    const TKL_HEADERS = [
      'timestamp','game_id','play_id','player_id','player_name','position','jersey_number',
      'solo_tackle','assist_tackle','missed_tackle','tfl','sack','ff','fr','fr_yards','fr_td',
      'safety','penalty','notes'
    ];
    const RUSH_HEADERS = [
      'timestamp','game_id','play_id','player_id','player_name','position','jersey_number',
      'rush_move','pressure','hit','hurry','sack','batted_pass','double_team_faced','double_team_win','time_to_pressure_sec','penalty','notes'
    ];
    const RUN_HEADERS = [
      'timestamp','game_id','play_id','player_id','player_name','position','jersey_number',
      'gap','integrity_maintained','run_stop','tfl','missed_tackle','yards_allowed','penalty','notes'
    ];
    const PEN_HEADERS = ['timestamp','game_id','play_id','player_id','player_name','position','jersey_number','Penalty Type','Penalty Yards','notes'];

    // ---- Elements & logging ----
    const $ = id => document.getElementById(id);
    const logBox = $('log');
    function log(msg, type=''){
      const row = document.createElement('div');
      if(type==='success') row.className='success';
      if(type==='error') row.className='error';
      row.textContent = '['+new Date().toLocaleTimeString()+'] '+msg;
      logBox.prepend(row);
      $('status').textContent = (type==='error'?'Error':'Ready');
    }

    // ---- Bind GameContext display ----
    GameContext.bindInputs({ game_id:$('ctx_game'), drive_id:$('ctx_drive'), play_id:$('ctx_play') });

    // ---- Roster ----
    let roster = [];
    const rosterById = new Map();
    const rosterByName = new Map();

    async function loadRoster(){
      try{
        const res = await apiGet({ action:'roster', sheet_id: ROSTER_SHEET_ID, sheet_name: ROSTER_TAB });
        if(!res.ok) throw new Error(res.error||'Roster fetch failed');
        const rows = res.roster || [];
        roster = rows
          .map(r=>({ id:r.player_id, name:r.player_name, pos:(r.position||'').toUpperCase(), num:r.jersey_number||'' }))
          .filter(p=>p.id && p.name && (DL_POS.includes(p.pos)));
        rosterById.clear(); rosterByName.clear(); $('dl_players').innerHTML='';
        roster.forEach(p=>{
          rosterById.set(p.id, p);
          rosterByName.set(p.name.toUpperCase(), p);
          const opt = document.createElement('option');
          opt.value = `${p.name} #${p.num} (${p.pos||''})`;
          $('dl_players').appendChild(opt);
        });
        log(`DL roster ready (${roster.length}).`, 'success');
      }catch(err){ log(String(err),'error'); }
    }

    function parsePlayerInput(s){
      const raw = String(s||'').trim();
      if(!raw) return null;
      const name = raw.replace(/\s+#\d+.*$/,'').trim();
      return roster.find(x=>x.name.toUpperCase()===name.toUpperCase()) ||
             roster.find(x=>name && x.name.toUpperCase().startsWith(name.toUpperCase())) || null;
    }

    // ---- Active chips / selection ----
    let active = [];
    let selected = new Set();

    function renderChips(){
      const wrap = $('active_chips'); wrap.innerHTML='';
      active.forEach((p,i)=>{
        const el = document.createElement('span');
        el.className = 'chipitem'+(selected.has(p.id)?' active':'');
        el.innerHTML = `<strong>#${p.num||'—'}</strong> ${p.name} <span class="tiny">${p.pos||''}</span> <button class="rm" aria-label="Remove" data-i="${i}">×</button>`;
        el.addEventListener('click', (ev)=>{
          if (ev.target.closest('button.rm')) return;
          if (selected.has(p.id)) selected.delete(p.id); else selected.add(p.id);
          renderChips(); updateSelCount();
        });
        wrap.appendChild(el);
      });
      wrap.querySelectorAll('.rm').forEach(btn=>{
        btn.addEventListener('click', (ev)=>{ ev.stopPropagation(); const i=Number(btn.dataset.i); const pid=active[i].id; active.splice(i,1); selected.delete(pid); renderChips(); updateSelCount(); buildTable(); });
      });
      $('activeCount').textContent = `${active.length} active`;
      buildTable();
    }
    function updateSelCount(){ $('selCount').textContent = `${selected.size || 0} selected`; }

    $('add_player').addEventListener('change', ()=>{
      const p = parsePlayerInput($('add_player').value);
      if(p && !active.some(x=>x.id===p.id)){ active.push(p); renderChips(); }
      $('add_player').value='';
    });

    $('presenceSetBtn').addEventListener('click', async ()=>{
      try{
        const ctx = GameContext.get();
        if(!ctx.game_id) throw new Error('Set a Game ID (Game Primary).');
        const players = active.map(p=>p.id);
        await presenceSet('DL', players, { unit:$('unit').value||'DL', package:$('pkg').value||'', source:'game-dl' });
        log(`Presence set for DL: ${players.length} players.`, 'success');
      }catch(err){ log(String(err),'error'); }
    });

    $('presenceLoadBtn').addEventListener('click', async ()=>{
      try{
        const ctx = GameContext.get();
        if(!ctx.game_id) throw new Error('Set a Game ID first.');
        const res = await apiGet({ action:'presence_get', game_id: ctx.game_id, group:'DL' });
        if(!res.ok) throw new Error(res.error||'presence_get failed');
        const arr = (res.data && res.data.players) || (res.presence && res.presence.players) || [];
        const found = arr.map(id=>rosterById.get(id)).filter(Boolean);
        active = found; selected.clear(); renderChips(); updateSelCount();
        log(`Loaded ${active.length} from presence.`, 'success');
      }catch(err){ log(String(err),'error'); }
    });

    // ---- Table model (tackles/takeaways) ----
    const zeroRow = () => ({
      solo:0, assist:0, missed:0, tfl:0, sack:0,
      ff:0, fr:0, fr_yards:'', fr_td:0, safety:0, penalty:'', notes:''
    });
    const tableState = new Map(); // player_id -> rowObj
    function ensureRow(pid){ if(!tableState.has(pid)) tableState.set(pid, zeroRow()); return tableState.get(pid); }

    function buildTable(){
      const tb = $('tbody'); tb.innerHTML='';
      active.forEach(p=>{
        const r = ensureRow(p.id);
        const tr = document.createElement('tr');
        tr.dataset.pid = p.id;
        tr.innerHTML = `
          <td><strong>#${p.num||'—'}</strong> ${p.name} <span class="tiny">${p.pos||''}</span></td>
          <td><input class="num" type="number" min="0" step="1" data-k="solo" value="${r.solo}"></td>
          <td><input class="num" type="number" min="0" step="1" data-k="assist" value="${r.assist}"></td>
          <td><input class="num" type="number" min="0" step="1" data-k="missed" value="${r.missed}"></td>
          <td><input class="num" type="number" min="0" step="1" data-k="tfl" value="${r.tfl}"></td>
          <td><input class="num" type="number" min="0" step="1" data-k="sack" value="${r.sack}"></td>
          <td><input class="num" type="number" min="0" step="1" data-k="ff" value="${r.ff}"></td>
          <td><input class="num" type="number" min="0" step="1" data-k="fr" value="${r.fr}"></td>
          <td><input class="num" type="number" step="1" data-k="fr_yards" value="${r.fr_yards}"></td>
          <td><select data-k="fr_td"><option ${r.fr_td? 'selected':''}>1</option><option ${r.fr_td? '':'selected'}>0</option></select></td>
          <td><select data-k="safety"><option ${r.safety? 'selected':''}>1</option><option ${r.safety? '':'selected'}>0</option></select></td>
          <td><input data-k="penalty" placeholder="Offside, Holding, —" value="${escapeHtml(r.penalty)}"></td>
          <td><input data-k="notes" placeholder="Notes" value="${escapeHtml(r.notes)}"></td>
        `;
        tb.appendChild(tr);
      });
      tb.querySelectorAll('input,select').forEach(inp=>{
        inp.addEventListener('change', ()=>{
          const tr = inp.closest('tr'); const pid = tr.dataset.pid;
          const k = inp.dataset.k; if(!k) return;
          const row = ensureRow(pid);
          row[k] = (inp.type==='number') ? (inp.value===''? '' : Number(inp.value)) :
                   (inp.tagName==='SELECT'? Number(inp.value) : inp.value);
        });
      });
    }

    // Quick events
    document.querySelectorAll('[data-ev]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const ev = btn.dataset.ev;
        const targets = selected.size ? active.filter(p=>selected.has(p.id)) : active;
        targets.forEach(p=>{
          const row = ensureRow(p.id);
          const map = { solo:'solo', assist:'assist', missed:'missed', tfl:'tfl', sack:'sack', ff:'ff', fr:'fr', safety:'safety' };
          const k = map[ev];
          if(k){ row[k] = Number(row[k]||0) + 1; }
        });
        buildTable();
      });
    });
    $('clearEventsBtn').addEventListener('click', ()=>{
      const targets = selected.size ? active.filter(p=>selected.has(p.id)) : active;
      targets.forEach(p=>tableState.set(p.id, zeroRow()));
      buildTable();
    });

    // ---- Save: TACKLES / TAKEAWAYS ----
    $('saveTacklesBtn').addEventListener('click', async ()=>{
      try{
        const ctx = GameContext.get();
        if(!ctx.game_id) throw new Error('Game ID is required.');
        if(!ctx.play_id) throw new Error('Play ID required.');
        const ops = [];
        active.forEach(p=>{
          const r = tableState.get(p.id);
          if(!r) return;
          const sum = (Number(r.solo)+Number(r.assist)+Number(r.missed)+Number(r.tfl)+Number(r.sack)+Number(r.ff)+Number(r.fr)+Number(r.safety)) || 0;
          const hasNotes = String(r.notes||'').trim() || String(r.penalty||'').trim();
          if (!sum && !hasNotes) return;
          const row = {
            game_id: ctx.game_id, play_id: ctx.play_id,
            player_id: p.id, player_name: p.name, position: p.pos||'', jersey_number: p.num||'',
            solo_tackle: numOr(r.solo), assist_tackle: numOr(r.assist), missed_tackle: numOr(r.missed),
            tfl: numOr(r.tfl), sack: numOr(r.sack),
            ff: numOr(r.ff), fr: numOr(r.fr), fr_yards: numOr(r.fr_yards), fr_td: numOr(r.fr_td),
            safety: numOr(r.safety),
            penalty: (r.penalty||'').trim(),
            notes: (r.notes||'').trim()
          };
          ops.push({ route: ROUTE_TACKLES, row, ensure_headers: TKL_HEADERS });
        });
        if (!ops.length) throw new Error('Nothing to save.');
        const res = await apiPost({ action:'batch', ops });
        if(!res.ok) throw new Error(res.error||'Save failed');
        log(`Saved ${ops.length} tackle/takeaway row(s).`, 'success');
      }catch(err){ log(String(err),'error'); }
    });

    // ---- Save: RUN DEFENSE ----
    $('saveRunDefBtn').addEventListener('click', async ()=>{
      try{
        const ctx = GameContext.get();
        if(!ctx.game_id) throw new Error('Game ID is required.');
        if(!ctx.play_id) throw new Error('Play ID required.');
        const targets = selected.size ? active.filter(p=>selected.has(p.id)) : active;
        if(!targets.length) throw new Error('Select at least one player or add actives.');

        const gap = $('rd_gap').value||'';
        const integ = $('rd_integrity').value==='Maintained' ? 1 : 0;
        const result = $('rd_result').value||'';
        const run_stop = (result==='Run Stop') ? 1 : 0;
        const tfl      = (result==='TFL') ? 1 : 0;
        const missed   = (result==='Missed Tackle') ? 1 : 0;

        const ops = targets.map(p=>({
          route: ROUTE_RUN_DEF,
          row: {
            game_id: ctx.game_id, play_id: ctx.play_id,
            player_id: p.id, player_name: p.name, position: p.pos||'', jersey_number: p.num||'',
            gap, integrity_maintained: integ, run_stop, tfl, missed_tackle: missed, yards_allowed:'', penalty:'', notes:''
          },
          ensure_headers: RUN_HEADERS
        }));
        const res = await apiPost({ action:'batch', ops });
        if(!res.ok) throw new Error(res.error||'Save failed');
        log(`Saved ${ops.length} run-defense row(s).`, 'success');
      }catch(err){ log(String(err),'error'); }
    });

    // ---- Save: PASS RUSH ----
    $('saveRushBtn').addEventListener('click', async ()=>{
      try{
        const ctx = GameContext.get();
        if(!ctx.game_id) throw new Error('Game ID is required.');
        if(!ctx.play_id) throw new Error('Play ID required.');
        const targets = selected.size ? active.filter(p=>selected.has(p.id)) : active;
        if(!targets.length) throw new Error('Select at least one player or add actives.');

        const move   = $('pr_move').value||'';
        const pressure = Number($('pr_pressure').value||0);
        const hit      = Number($('pr_hit').value||0);
        const hurry    = Number($('pr_hurry').value||0);
        const sack     = Number($('pr_sack').value||0);
        const batted   = Number($('pr_batted').value||0);
        const dbl      = Number($('pr_double').value||0);
        const dblw     = Number($('pr_double_win').value||0);
        const ttp      = $('pr_ttp').value==='' ? '' : Number($('pr_ttp').value);

        const ops = targets.map(p=>({
          route: ROUTE_PASS_RUSH,
          row: {
            game_id: ctx.game_id, play_id: ctx.play_id,
            player_id: p.id, player_name: p.name, position: p.pos||'', jersey_number: p.num||'',
            rush_move: move, pressure, hit, hurry, sack, batted_pass: batted,
            double_team_faced: dbl, double_team_win: dblw, time_to_pressure_sec: ttp,
            penalty:'', notes:'DL rush'
          },
          ensure_headers: RUSH_HEADERS
        }));
        const res = await apiPost({ action:'batch', ops });
        if(!res.ok) throw new Error(res.error||'Save failed');
        log(`Saved ${ops.length} pass-rush row(s).`, 'success');
      }catch(err){ log(String(err),'error'); }
    });

    // ---- Save: PENALTY ----
    $('savePenaltyBtn').addEventListener('click', async ()=>{
      try{
        const ctx = GameContext.get();
        if(!ctx.game_id) throw new Error('Game ID is required.');
        if(!ctx.play_id) throw new Error('Play ID required.');
        const targets = selected.size ? active.filter(p=>selected.has(p.id)) : active;
        if(!targets.length) throw new Error('Select at least one player or add actives.');

        const type = $('pen_type').value||'';
        const yds  = $('pen_yards').value==='' ? '' : Number($('pen_yards').value);

        const ops = targets.map(p=>({
          route: ROUTE_PEN,
          row: {
            game_id: ctx.game_id, play_id: ctx.play_id,
            player_id: p.id, player_name: p.name, position: p.pos||'', jersey_number: p.num||'',
            'Penalty Type': type, 'Penalty Yards': yds, notes:''
          },
          ensure_headers: PEN_HEADERS
        }));
        const res = await apiPost({ action:'batch', ops });
        if(!res.ok) throw new Error(res.error||'Save failed');
        log(`Saved ${ops.length} penalty row(s).`, 'success');
        $('pen_yards').value='';
      }catch(err){ log(String(err),'error'); }
    });

    // ---- Utils ----
    function numOr(v){ return (v===''||v==null) ? '' : Number(v); }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }

    // ---- Boot ----
    loadRoster();
  })();
  </script>
</body>
</html>
