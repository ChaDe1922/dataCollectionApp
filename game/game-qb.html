<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>QB Tracking – Football Data Tracker</title>

  <!-- Auth guard -->
  <script>
    (function(){
      const ok = localStorage.getItem('auth_ok')==='1' &&
                 Number(localStorage.getItem('auth_until')||0) > Date.now();
      if(!ok){ window.location.href = '../index.html#login'; }
    })();
    /* Shared API config (BEFORE loading /js/api.js) */
    window.GSDS_API_BASE   = 'https://script.google.com/macros/s/AKfycbxQk6BgJLkZltXX7xijq9QKmTEfB51M65cHzrYCe6SCTykrSWnFDMecXfiLGRTd9iOCLg/exec';
    window.GSDS_SERVER_SYNC = true;
    window.GSDS_POLL_MS      = 1000;
  </script>

  <!-- Fonts + site theme -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../style.css"/>

  <!-- Shared libs -->
  <script src="../js/api.js"></script>
  <script src="../js/context.js"></script>
  <script src="../js/presence.js"></script>

  <!-- Page styles: dark bg + light cards (match Primary page) -->
  <style>
    :root{
      --card-bg:#fff; --card-br:#E7E9F2; --ink:#0f172a; --ink-2:#334155; --muted:#64748b;
      --pill:#3a1660; --pill-2:#a36bff; --focus:#a36bff33; --accent:#43b581;
    }
    body.practice-page{ background:linear-gradient(180deg,#0f0b1a 0%, #130e22 55%, #0e0b18 100%); color:var(--ink); }
    .container{ max-width:1100px; margin:0 auto; padding:16px; display:grid; gap:16px;
      grid-template-columns: 1fr;
      grid-template-areas: "ctx" "ttt" "people" "throw" "help" }
    @media (min-width: 980px){
      .container{ gap:18px; grid-template-columns: 1fr 1fr;
        grid-template-areas: "ctx ttt" "people throw" "help help"; }
    }

    .card{ background:var(--card-bg); border:1px solid var(--card-br); border-radius:18px; padding:18px;
      box-shadow:0 10px 24px rgba(2,8,23,.06); color:var(--ink); }

    .area-ctx{grid-area:ctx}
    .area-ttt{grid-area:ttt}
    .area-people{grid-area:people}
    .area-throw{grid-area:throw}
    .area-help{grid-area:help}

    .section-title{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
    .section-title h2{margin:0;font-size:1.25rem;line-height:1.15}
    .tiny{font-size:.9rem;color:var(--muted)}
    .chip{display:inline-block;padding:.35rem .7rem;border-radius:999px;background:#f3f4f7;border:1px solid #e5e7ef;font-weight:600;color:#4b5563}

    /* Inputs */
    label{display:block;font-size:.95rem;color:var(--ink-2);margin:0 0 .35rem}
    input,select,textarea{ width:100%; padding:.72rem .85rem; border-radius:12px; border:2px solid #cfd6ea; background:#fff; color:var(--ink);
      box-shadow:0 1px 0 rgba(0,0,0,.02) inset; transition:border-color .15s, box-shadow .15s, background .15s; font-size:1rem; }
    input::placeholder, textarea::placeholder{ color:#9aa3b2 }
    input:focus,select:focus,textarea:focus{ outline:none; border-color:#a36bff; box-shadow:0 0 0 4px var(--focus); background:#fff; }
    input[type="number"]{-moz-appearance:textfield; border-color:#c0c9e3}
    input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }

    /* Row/grid utilities */
    .row{display:grid; gap:12px}
    .row.cols-2{grid-template-columns:1fr 1fr}
    .row.cols-3{grid-template-columns:repeat(3,1fr)}
    .row.cols-4{grid-template-columns:repeat(4,1fr)}
    @media (max-width:680px){ .row.cols-2,.row.cols-3,.row.cols-4{grid-template-columns:1fr} }

    /* Buttons */
    .btnbar{display:flex;gap:.5rem;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--pill);background:var(--pill);color:#fff;cursor:pointer;
      padding:.65rem 1rem;border-radius:999px;font-weight:700;transition:transform .15s, box-shadow .15s, background .15s, border-color .15s}
    .btn:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(163,107,255,.22) }
    .btn.subtle{ background:#fff; color:var(--pill); border-color:#e2d6ff }
    .btn.warn{ background:#fde9d6; color:#7a3b01; border-color:#f5c899 }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#071a12 }

    /* Chips, log, meta */
    #log{ max-height:260px; overflow:auto; background:#fbfbfe; border:1px solid #eef1f8; border-radius:12px; padding:10px; color:#1f2937 }
    .meta{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.4rem;margin-top:.6rem}
    .success{color:#0f7a43}.error{color:#b42318}

    /* Stopwatch + segmented controls + toggles */
    .stopwatch{font-variant-numeric:tabular-nums;font-size:1.8rem}
    .seg{display:flex;flex-wrap:wrap;gap:.5rem .55rem}
    .seg-btn{padding:.45rem .75rem;border-radius:999px;border:1px solid #d9e0f2;background:#fff;color:var(--ink);cursor:pointer}
    .seg-btn[aria-pressed="true"]{background:var(--accent);color:#071a12;border-color:var(--accent)}
    .stack-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:.5rem}
    .stack-4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:.5rem}

    .tgl{--w:44px; --h:24px; position:relative; width:var(--w); height:var(--h);
         border-radius:999px; background:#e5e7ef; border:1px solid #d7dbe8; cursor:pointer; display:inline-block}
    .tgl .knob{position:absolute; top:2px; left:2px; width:calc(var(--h) - 4px); height:calc(var(--h) - 4px); border-radius:999px; background:#fff; transition:transform .18s ease}
    .tgl[data-on="true"]{ background:var(--accent); border-color:var(--accent) }
    .tgl[data-on="true"] .knob{ transform:translateX(calc(var(--w) - var(--h))) }
    .field-inline{display:flex;align-items:center;gap:.6rem}

    .group{background:#fafbff;border:1px solid #eef1f8;border-radius:12px;padding:.9rem}
    .gh{font-size:.9rem;color:var(--ink-2);margin-bottom:.35rem}
    .subrow{display:grid;grid-template-columns:1fr auto;align-items:center;gap:.6rem;margin:.35rem 0}
    .group.is-disabled{opacity:.55;pointer-events:none}

    /* Throw layout */
    .throw-grid{display:grid;grid-template-columns:1.1fr 1.3fr 1.3fr;gap:1rem 1.2rem;align-items:start}
    @media (max-width:1120px){ .throw-grid{grid-template-columns:1fr 1fr} #path_target{grid-column:1 / -1} }
    @media (max-width:720px){ .throw-grid{grid-template-columns:1fr} }
    .throw-card{min-width:0;display:grid;grid-auto-rows:min-content;row-gap:.65rem}
  </style>
</head>

<body class="practice-page">
  <header class="page-header">
    <h1>QB Tracking</h1>
    <nav class="menu-actions">
      <a href="game-day.html" class="menu-btn">Game Day</a>
      <a href="game-primary.html" class="menu-btn">Primary / Drives</a>
      <a href="../index.html" class="menu-btn">Home</a>
    </nav>
  </header>

  <main>
    <div class="container">
      <!-- Live context banner like Primary -->
      <div id="ctxBanner" class="chip tiny" aria-live="polite" style="grid-column:1 / -1"></div>

      <!-- Game Context -->
      <section class="card area-ctx">
        <div class="section-title">
          <h2>Game Context</h2>
          <span id="status" class="tiny">Ready</span>
        </div>
        <div class="row cols-3">
          <div>
            <label>Game ID <span class="tiny" style="color:var(--muted)">(from schedule)</span></label>
            <input id="game_id" list="list_game_ids" placeholder="e.g. G2025-01"/>
            <datalist id="list_game_ids"></datalist>
          </div>
          <div>
            <label>Play ID <span class="tiny">(link pass to play)</span></label>
            <input id="play_id" placeholder="e.g. PLAY_000123"/>
          </div>
          <div>
            <label>Lookup Play (optional)</label>
            <div class="btnbar">
              <button class="btn subtle" id="lookupPlayBtn">Fetch from Plays</button>
              <button class="btn subtle" id="newPlayIdBtn">New Play ID</button>
            </div>
          </div>
        </div>
        <div id="game_meta" class="meta" style="display:none">
          <span class="chip" id="meta_date"></span>
          <span class="chip" id="meta_week"></span>
          <span class="chip" id="meta_opp"></span>
          <span class="chip" id="meta_ha"></span>
          <span class="chip" id="meta_weather"></span>
        </div>
      </section>

      <!-- TTT -->
      <section class="card area-ttt">
        <div class="section-title"><h2>Time to Throw (TTT)</h2><span class="tiny">Start at snap → stop at pass or sack</span></div>
        <div class="row cols-2">
          <div><label>Stopwatch</label><div class="stopwatch" id="ttt_display">0.00</div></div>
          <div><label>TTT (sec)</label><input id="ttt" type="number" step="0.01" placeholder="auto from stopwatch"/></div>
        </div>
        <div class="btnbar" style="margin-top:.4rem">
          <button class="btn primary" id="ttt_start">Start</button>
          <button class="btn subtle" id="ttt_stop">Stop → Field</button>
          <button class="btn warn" id="ttt_reset">Reset</button>
          <button class="btn subtle" data-ttt="1.80">1.80</button>
          <button class="btn subtle" data-ttt="2.30">2.30</button>
          <button class="btn subtle" data-ttt="2.70">2.70</button>
          <button class="btn subtle" data-ttt="3.20">3.20</button>
        </div>
      </section>

      <!-- Participants -->
      <section class="card area-people">
        <div class="section-title"><h2>Participants</h2><span class="tiny">Type to search roster (filtered)</span></div>
        <div class="row cols-2">
          <div><label>Passer (name) <span class="tiny chip">QB only</span></label><input id="passer_name" list="list_qb_names" placeholder="QB name…"/><datalist id="list_qb_names"></datalist></div>
          <div><label>Passer ID</label><input id="passer_id" placeholder="auto from name/roster"/></div>
          <div><label>Target (name) <span class="tiny chip">WR/TE/RB/FB</span></label><input id="target_name" list="list_rcv_names" placeholder="WR/TE/RB name…"/><datalist id="list_rcv_names"></datalist></div>
          <div><label>Target ID</label><input id="target_id" placeholder="auto from name/roster"/></div>
        </div>
        <div class="btnbar">
          <button class="btn subtle" id="loadRosterBtn">Reload Roster</button>
          <button class="btn subtle" id="setQBPresenceBtn">Set Presence (QB)</button>
          <button class="btn subtle" id="loadQBPresenceBtn">Load From Presence</button>
          <span class="chip tiny">Roster: 00_Dim_Roster • Presence group: “QB”</span>
        </div>
      </section>

      <!-- Throw Detail -->
      <section class="card area-throw">
        <div class="section-title"><h2>Throw Detail</h2><span class="tiny">Auto depth bucket from Air Yards</span></div>
        <div class="throw-grid">
          <!-- Outcome -->
          <div class="group throw-card" id="path_outcome">
            <div class="gh">Outcome path</div>
            <div class="subrow"><label>Sack</label><div class="field-inline"><button type="button" class="tgl" data-target="sack" role="switch" aria-checked="false"><span class="knob"></span></button><input type="hidden" id="sack" value="No"/></div></div>
            <div class="subrow"><label>Sack Yards</label><input id="sack_yards" type="number" step="1" placeholder="—"/></div>
            <div class="subrow"><label>Throwaway</label><div class="field-inline"><button type="button" class="tgl" data-target="throwaway" role="switch" aria-checked="false"><span class="knob"></span></button><input type="hidden" id="throwaway" value="No"/></div></div>
            <div class="subrow"><label>Spike</label><div class="field-inline"><button type="button" class="tgl" data-target="spike" role="switch" aria-checked="false"><span class="knob"></span></button><input type="hidden" id="spike" value="No"/></div></div>
          </div>

          <!-- Flight -->
          <div class="group throw-card" id="path_flight">
            <div class="gh">Ball flight</div>
            <div class="subrow"><label>Air Yards</label><input id="air_yards" type="number" step="1" placeholder="neg for behind LOS"/></div>
            <div class="subrow" id="depthBucketGroup">
              <label>Depth Bucket</label>
              <div class="seg stack-4" data-target="depth_bucket">
                <button type="button" class="seg-btn" data-val="Behind LOS" aria-pressed="true">Behind LOS</button>
                <button type="button" class="seg-btn" data-val="Short (1–9)" aria-pressed="false">Short (1–9)</button>
                <button type="button" class="seg-btn" data-val="Intermediate (10–19)" aria-pressed="false">Intermediate</button>
                <button type="button" class="seg-btn" data-val="Deep (20+)" aria-pressed="false">Deep (20+)</button>
              </div>
              <input type="hidden" id="depth_bucket" value="Behind LOS"/>
            </div>
            <div class="subrow">
              <label>Left/Middle/Right</label>
              <div class="seg stack-3" data-target="lmr">
                <button type="button" class="seg-btn" data-val="Left" aria-pressed="true">Left</button>
                <button type="button" class="seg-btn" data-val="Middle" aria-pressed="false">Middle</button>
                <button type="button" class="seg-btn" data-val="Right" aria-pressed="false">Right</button>
              </div>
              <input type="hidden" id="lmr" value="Left"/>
            </div>
            <div class="subrow"><label>Pressure Faced</label><div class="field-inline"><button type="button" class="tgl" data-target="pressure_faced_yn" role="switch" aria-checked="false"><span class="knob"></span></button><input type="hidden" id="pressure_faced_yn" value="No"/></div></div>
          </div>

          <!-- Target & result -->
          <div class="group throw-card" id="path_target">
            <div class="gh">Target &amp; result</div>
            <div class="subrow"><label>Catchable Target</label><div class="field-inline"><button type="button" class="tgl" data-target="catchable" role="switch" aria-checked="false"><span class="knob"></span></button><input type="hidden" id="catchable" value="No"/></div></div>
            <div class="subrow"><label>Contested Target</label><div class="field-inline"><button type="button" class="tgl" data-target="contested" role="switch" aria-checked="false"><span class="knob"></span></button><input type="hidden" id="contested" value="No"/></div></div>
            <div class="subrow"><label>Complete</label><div class="field-inline"><button type="button" class="tgl" data-target="complete" role="switch" aria-checked="false"><span class="knob"></span></button><input type="hidden" id="complete" value="No"/></div></div>
            <div class="subrow"><label>Drop</label><div class="field-inline"><button type="button" class="tgl" data-target="drop" role="switch" aria-checked="false"><span class="knob"></span></button><input type="hidden" id="drop" value="No"/></div></div>
            <div class="subrow"><label>YAC</label><input id="yac" type="number" step="1" placeholder="0"/></div>
            <div class="subrow"><label>Touchdown</label><div class="field-inline"><button type="button" class="tgl" data-target="td" role="switch" aria-checked="false"><span class="knob"></span></button><input type="hidden" id="td" value="No"/></div></div>
            <div class="subrow"><label>Interception</label><div class="field-inline"><button type="button" class="tgl" data-target="interception" role="switch" aria-checked="false"><span class="knob"></span></button><input type="hidden" id="interception" value="No"/></div></div>
          </div>
        </div>

        <div class="btnbar" style="margin-top:.6rem">
          <button class="btn primary" id="saveBtn">Save Pass Detail</button>
          <button class="btn subtle" id="clearBtn">Clear Fields</button>
        </div>
      </section>

      <!-- Help / Log -->
      <section class="card area-help">
        <div class="section-title"><h2>Quick Help</h2><span class="tiny">Rules & sanity</span></div>
        <ul class="tiny">
          <li><strong>Passer list = QBs</strong>. <strong>Target list = WR/TE/RB/FB.</strong></li>
          <li><strong>Interception ON</strong> → Complete OFF.</li>
          <li><strong>Sack ON</strong> → stamps TTT, sets Air Yds &amp; YAC to 0.</li>
          <li><strong>Spike ON</strong> → Catchable OFF, Complete OFF.</li>
          <li><strong>Depth Bucket</strong> auto from Air Yards (≤0 BL, 1–9 Short, 10–19 Intermediate, ≥20 Deep).</li>
        </ul>
        <div class="section-title" style="margin-top:.5rem"><h2>Log</h2><span class="tiny">Most recent first</span></div>
        <div id="log" class="tiny"></div>
      </section>
    </div>
  </main>

  <footer><p>&copy; 2025 Game Speed Data Systems</p></footer>

  <!-- Page logic -->
  <script>
  // Configure shared context + banner (same as Primary)
  GameContext.configure({ apiBase: window.GSDS_API_BASE, server: true, pollMs: window.GSDS_POLL_MS||1000 });
  GameContext.mountBanner('#ctxBanner');

  window.addEventListener('DOMContentLoaded', () => {
    /* ===== CONFIG (2025 master IDs) ===== */
    const SCHEDULE_SHEET_ID = '1oHO-5gM9l3PTSjUxwQlYzFaAMTtlco2VZj8l315Uk1c';
    const SCHEDULE_TAB      = '01_Dim_Schedule';
    const ROSTER_SHEET_ID   = '1oHO-5gM9l3PTSjUxwQlYzFaAMTtlco2VZj8l315Uk1c';
    const ROSTER_TAB        = '00_Dim_Roster';
    const ELIGIBLE_TARGET_POS = ['WR','TE','RB','FB','HB','TB','SB'];
    const ROUTE_PASS        = 'pass_detail';
    const ROUTE_PLAYS       = 'plays';

    /* ===== STATE + LOG ===== */
    const el = id => document.getElementById(id);
    const logBox = el('log');
    const log = (msg, type='')=>{
      const row = document.createElement('div');
      if(type==='success') row.className='success';
      if(type==='error') row.className='error';
      row.textContent = '['+new Date().toLocaleTimeString()+'] '+msg;
      logBox.prepend(row);
      const st = document.getElementById('status'); if (st) st.textContent = (type==='error'?'Error':'Ready');
    };

    let schedule=[], scheduleMap={};
    let roster=[];
    const playersById=new Map(), playersByName=new Map(), playersByNum=new Map();
    const qbs=[], receivers=[];
    let pendingGidFromCtx = null;
    const scheduleReady = () => Object.keys(scheduleMap).length > 0;

    /* ===== SCHEDULE ===== */
    function fillDatalist(id, arr){
      const dl = el(id); dl.innerHTML='';
      arr.forEach(v=>{ const o=document.createElement('option'); o.value=v; dl.appendChild(o); });
    }
    async function loadSchedule(){
      try{
        const res = await apiGet({ action:'table', sheet_id:SCHEDULE_SHEET_ID, sheet_name:SCHEDULE_TAB });
        if(!res.ok) throw new Error(res.error||'Schedule fetch failed');
        schedule = (res.rows||[]).filter(r=>r.game_id);
        scheduleMap = {};
        const ids = [];
        schedule.forEach(r=>{
          const gid = String(r.game_id).trim(); if(!gid) return;
          scheduleMap[gid]=r; ids.push(gid);
        });
        ids.sort((a,b)=>{
          const ra=scheduleMap[a], rb=scheduleMap[b];
          const da=(ra.date||''), db=(rb.date||'');
          if(da && db && da!==db) return da<db?-1:1;
          return (Number(ra.week||0)-Number(rb.week||0));
        });
        fillDatalist('list_game_ids', ids);
        log(`Schedule loaded (${ids.length} games).`, 'success');

        if (pendingGidFromCtx) {
          el('game_id').value = pendingGidFromCtx;
          el('game_id').dispatchEvent(new Event('change'));
          pendingGidFromCtx = null;
        } else {
          const ctx = window.GameContext?.get?.() || {};
          if (ctx.game_id && scheduleMap[ctx.game_id]) {
            el('game_id').value = ctx.game_id;
            el('game_id').dispatchEvent(new Event('change'));
          }
        }
      }catch(err){ log(err.message,'error'); }
    }
    function renderGameMeta(gid){
      const box = el('game_meta'), r = scheduleMap[gid];
      if(!r){ box.style.display='none'; return; }
      el('meta_date').textContent   = r.date ? `Date: ${r.date}` : 'Date: —';
      el('meta_week').textContent   = r.week ? `Week: ${r.week}` : 'Week: —';
      el('meta_opp').textContent    = r.opponent ? `Opponent: ${r.opponent}` : 'Opponent: —';
      el('meta_ha').textContent     = r.home_away ? `Venue: ${r.home_away}` : 'Venue: —';
      el('meta_weather').textContent= r.weather_conditions ? `Weather: ${r.weather_conditions}` : 'Weather: —';
      box.style.display='grid';
    }
    el('game_id').addEventListener('change',()=>{
      const gid = el('game_id').value.trim();
      if(!gid){ renderGameMeta(''); return; }
      if(!scheduleReady()){ pendingGidFromCtx = gid; return; }
      if(!scheduleMap[gid]){ log(`Game ID "${gid}" not found in schedule.`, 'error'); renderGameMeta(''); return; }
      renderGameMeta(gid);
      GameContext.setGame(gid);
    });

    /* ===== ROSTER (enhanced autofill) ===== */
    function pushOption(dlId, text){ const o=document.createElement('option'); o.value=text; el(dlId).appendChild(o); }

    let qbRecords=[], rcvRecords=[]; // for partial/number matching

    function buildRosterIndexes(rows){
      playersById.clear(); playersByName.clear(); playersByNum.clear();
      qbs.length=0; receivers.length=0; qbRecords=[]; rcvRecords=[];
      el('list_qb_names').innerHTML=''; el('list_rcv_names').innerHTML='';

      rows.forEach(r=>{
        const id=(r.player_id||r.id||'').toString().trim();
        const name=(r.player_name||r.name||'').toString().trim();
        const pos=(r.position||r.pos||'').toString().trim().toUpperCase();
        const num=(r.jersey_number||r.jersey||'').toString().trim();
        if(!id||!name) return;

        const rec = { id, name, pos, num };
        playersById.set(id.toUpperCase(), rec);
        playersByName.set(name.toUpperCase(), id);
        if(num) playersByNum.set(String(num), id);

        if(pos==='QB'){ qbs.push(name); qbRecords.push(rec); }
        if(ELIGIBLE_TARGET_POS.includes(pos)){ receivers.push(name); rcvRecords.push(rec); }
      });

      qbs.sort((a,b)=>a.localeCompare(b));
      receivers.sort((a,b)=>a.localeCompare(b));
      qbs.forEach(n=>pushOption('list_qb_names', n));
      receivers.forEach(n=>pushOption('list_rcv_names', n));
    }

    async function loadRoster(){
      try{
        const res = await apiGet({ action:'roster', sheet_id:ROSTER_SHEET_ID, sheet_name:ROSTER_TAB });
        if(!res.ok) throw new Error(res.error||'Roster fetch failed');
        roster = res.roster||[];
        buildRosterIndexes(roster);
        log(`Roster loaded (${roster.length} players).`, 'success');
      }catch(err){ log(err.message,'error'); }
    }

    /* ---------- Autofill helpers ---------- */
    const jerseyDigits = s => (s||'').toString().replace(/[^0-9]/g,'');
    function findByIdRaw(id){ return id ? playersById.get(id.toUpperCase()) : undefined; }

    function uniqueIdFromPartialName(q, pool){
      const U = (q||'').trim().toUpperCase();
      if(!U) return '';
      // exact match via name map
      const exactId = playersByName.get(U);
      if(exactId){
        const rec = findByIdRaw(exactId);
        if(rec && pool.some(p=>p.id===rec.id)) return rec.id;
      }
      // unique contains match within the given pool (QBs or eligible receivers)
      const matches = pool.filter(p => p.name.toUpperCase().includes(U));
      return matches.length===1 ? matches[0].id : '';
    }

    function idFromJersey(numLike, pool){
      const n = jerseyDigits(numLike);
      if(!n) return '';
      const matches = pool.filter(p => String(p.num||'')===n);
      if(matches.length===1) return matches[0].id;
      // fall back to global jersey map if unique there
      const global = playersByNum.get(n);
      return (global && pool.some(p=>p.id===global)) ? global : '';
    }

    function setNameAndId(which, id){
      const rec = findByIdRaw(id); if(!rec) return;
      if(which==='passer'){ if(el('passer_id').value!==rec.id) el('passer_id').value=rec.id;
                            if(el('passer_name').value.trim().toUpperCase()!==rec.name.toUpperCase()) el('passer_name').value=rec.name; }
      if(which==='target'){ if(el('target_id').value!==rec.id) el('target_id').value=rec.id;
                            if(el('target_name').value.trim().toUpperCase()!==rec.name.toUpperCase()) el('target_name').value=rec.name; }
    }

    function syncPasser(){
      const nameInput = el('passer_name').value;
      const idInput   = el('passer_id').value;
      // 1) ID typed → fill name
      let rec = findByIdRaw(idInput);
      if(rec && rec.pos==='QB'){ setNameAndId('passer', rec.id); return; }

      // 2) Name (exact or partial) → fill ID
      let id = uniqueIdFromPartialName(nameInput, qbRecords);
      if(!id) id = idFromJersey(nameInput, qbRecords);
      if(!id && idInput){ // ID looked invalid; try jersey in ID box
        const alt = idFromJersey(idInput, qbRecords); if(alt) id = alt;
      }
      if(id){ setNameAndId('passer', id); return; }
      // leave as-is if ambiguous; avoid stomping user text
    }

    function syncTarget(){
      const nameInput = el('target_name').value;
      const idInput   = el('target_id').value;
      // 1) ID typed → fill name
      let rec = findByIdRaw(idInput);
      if(rec && ELIGIBLE_TARGET_POS.includes(rec.pos)){ setNameAndId('target', rec.id); return; }

      // 2) Name (exact or partial) → fill ID
      let id = uniqueIdFromPartialName(nameInput, rcvRecords);
      if(!id) id = idFromJersey(nameInput, rcvRecords);
      if(!id && idInput){
        const alt = idFromJersey(idInput, rcvRecords); if(alt) id = alt;
      }
      if(id){ setNameAndId('target', id); return; }
    }

    // Wire events (both fields, live + on blur)
    [['passer_name', syncPasser], ['passer_id', syncPasser],
     ['target_name', syncTarget], ['target_id', syncTarget]]
      .forEach(([id,fn])=>{
        const node = el(id);
        node.addEventListener('input', fn);
        node.addEventListener('change', fn);
      });

    // Buttons already present
    el('loadRosterBtn').addEventListener('click', loadRoster);


    /* ===== Presence (QB) ===== */
    async function setQBPresence(){
      const gid = el('game_id').value.trim(); if(!gid) return log('Pick a Game ID first.','error');
      syncPlayerIds();
      const qb = el('passer_id').value.trim(); if(!qb) return log('Choose a passer first.','error');
      try{ await Presence.set(gid, 'QB', [qb], { unit:'offense', source:'game-qb' }); log(`Presence set (QB: ${qb}).`, 'success'); }
      catch(e){ log(e.message||String(e),'error'); }
    }
    async function loadQBPresence(){
      const gid = el('game_id').value.trim(); if(!gid) return log('Pick a Game ID first.','error');
      try{
        const data = await Presence.get(gid, 'QB');
        const arr = (data && (data.players || data.data?.players || data.presence?.players)) || [];
        const first = Array.isArray(arr) && arr[0];
        if(!first) return log('No QB in presence for this game.','error');
        el('passer_id').value = first;
        const rec = playersById.get(first.toUpperCase()); if(rec) el('passer_name').value = rec.name;
        log(`Loaded QB from presence (${first}).`,'success');
      }catch(e){ log(e.message||String(e),'error'); }
    }
    document.getElementById('setQBPresenceBtn').addEventListener('click', setQBPresence);
    document.getElementById('loadQBPresenceBtn').addEventListener('click', loadQBPresence);

    /* ===== Toggles & Segments ===== */
    function setToggle(id,on){
      const btn=document.querySelector(`.tgl[data-target="${id}"]`), hidden=el(id);
      if(!btn||!hidden) return; btn.dataset.on = on ? 'true':'false'; btn.setAttribute('aria-checked',String(on)); hidden.value = on?'Yes':'No';
    }
    function mountToggles(){
      document.querySelectorAll('.tgl[data-target]').forEach(btn=>{
        if (btn.dataset.wired === '1') return; btn.dataset.wired='1';
        btn.addEventListener('click', ()=>{
          const id=btn.dataset.target; const next = !(btn.dataset.on==='true'); setToggle(id,next);
          if(id==='interception' && next){ setToggle('complete', false); el('yac').value='0'; }
          if(id==='drop' && next){ setToggle('complete', false); }
          if(id==='spike' && next){ setToggle('catchable', false); setToggle('complete', false); el('yac').value='0'; el('air_yards').value='0'; setSegValue('depth_bucket','Behind LOS'); }
          if(id==='throwaway' && next){ setToggle('complete', false); setToggle('catchable', false); el('yac').value='0'; }
          if(id==='sack' && next){ tttStop(); el('air_yards').value='0'; el('yac').value='0'; setSegValue('depth_bucket','Behind LOS'); }
          if(id==='complete' && !next){ el('yac').value='0'; }
          refreshPathState();
        });
      });
      ['complete','interception','td','sack','throwaway','spike','catchable','drop','contested','pressure_faced_yn']
        .forEach(id=>setToggle(id,false));
    }
    function setSegValue(id,val){
      const hidden=el(id); hidden.value=val;
      const group=document.querySelector(`.seg[data-target="${id}"]`);
      if(!group) return;
      group.querySelectorAll('.seg-btn').forEach(b=>b.setAttribute('aria-pressed', String(b.dataset.val===val)));
    }
    function initSegGroups(){
      document.querySelectorAll('.seg[data-target]').forEach(group=>{
        if(group.dataset.wired==='1') return; group.dataset.wired='1';
        group.addEventListener('click', ev=>{
          const btn=ev.target.closest('.seg-btn'); if(!btn) return;
          setSegValue(group.dataset.target, btn.dataset.val);
        });
      });
    }

    /* ===== TTT Stopwatch ===== */
    let tttTimer=null, tttStartMs=0;
    function showTTT(sec){ el('ttt_display').textContent = sec.toFixed(2); }
    function tttStart(){ if(tttTimer) return; tttStartMs=performance.now(); tttTimer=setInterval(()=>{ showTTT((performance.now()-tttStartMs)/1000); },20); }
    function tttStop(){ if(!tttTimer) return; clearInterval(tttTimer); tttTimer=null; const s=(performance.now()-tttStartMs)/1000; el('ttt').value=s.toFixed(2); showTTT(s); }
    function tttReset(){ if(tttTimer){clearInterval(tttTimer); tttTimer=null;} showTTT(0); el('ttt').value=''; }
    document.getElementById('ttt_start').onclick=tttStart;
    document.getElementById('ttt_stop').onclick=tttStop;
    document.getElementById('ttt_reset').onclick=tttReset;
    document.querySelectorAll('button[data-ttt]').forEach(b=>b.addEventListener('click',()=>{ el('ttt').value=b.dataset.ttt; showTTT(Number(b.dataset.ttt)); }));

    /* ===== Throw helpers ===== */
    const numVal = v => (v===''||v==null ? '' : Number(v));
    const ynTo01 = v => v==='Yes'?1 : (v==='No'?0 : '');
    function autoDepthFromAir(){
      const ay = Number(el('air_yards').value);
      if(isNaN(ay)) return;
      if(ay <= 0) setSegValue('depth_bucket','Behind LOS');
      else if(ay <= 9) setSegValue('depth_bucket','Short (1–9)');
      else if(ay <= 19) setSegValue('depth_bucket','Intermediate (10–19)');
      else setSegValue('depth_bucket','Deep (20+)');
    }
    el('air_yards').addEventListener('change', autoDepthFromAir);

    function setGroupDisabled(id, disabled){
      const g = document.getElementById(id); if(!g) return; g.classList.toggle('is-disabled', !!disabled);
    }
    function refreshPathState(){
      const sackOn  = el('sack').value === 'Yes';
      const spikeOn = el('spike').value === 'Yes';
      const toOn    = el('throwaway').value === 'Yes';
      setGroupDisabled('path_flight', sackOn);
      setGroupDisabled('path_target', sackOn);
      if (sackOn){
        el('air_yards').value='0'; el('yac').value='0';
        setSegValue('depth_bucket','Behind LOS');
        setToggle('complete', false); setToggle('catchable', false); setToggle('drop', false); setToggle('td', false);
      }
      if (spikeOn || toOn){
        setToggle('complete', false); setToggle('catchable', false); el('yac').value='0';
        if (spikeOn){ el('air_yards').value='0'; setSegValue('depth_bucket','Behind LOS'); }
      }
    }

    /* ===== Optional: plays lookup ===== */
    async function lookupPlay(){
      try{
        const pid = el('play_id').value.trim(); if(!pid) throw new Error('Enter a Play ID first.');
        const res = await apiGet({ action:'table', route: ROUTE_PLAYS });
        if(!res.ok) throw new Error(res.error||'Fetch plays failed');
        const row = (res.rows||[]).find(r => String(r.play_id||'').trim() === pid);
        if(!row){ log(`Play ${pid} not found in plays.`, 'error'); return; }
        log(`Play ${pid} found (Q${row.quarter||'?'} @ ${row.clock||'??:??'})`, 'success');
      }catch(err){ log(err.message,'error'); }
    }
    document.getElementById('lookupPlayBtn').addEventListener('click', lookupPlay);
    document.getElementById('newPlayIdBtn').addEventListener('click', async ()=>{
      try{ const res = await apiGet({ action:'next_id', prefix:'PLAY' }); if(!res.ok) throw new Error(res.error||'ID failed'); el('play_id').value = res.id; log(`New Play ID: ${res.id}`,'success'); }
      catch(err){ log(err.message,'error'); }
    });

    /* ===== Save ===== */
    function ensureGameAndIds(){
      const game_id = el('game_id').value.trim(); if(!game_id) throw new Error('Pick a Game ID from schedule.');
      const play_id = el('play_id').value.trim(); if(!play_id) throw new Error('Enter a Play ID.');
      syncPlayerIds();
      const passer_id = el('passer_id').value.trim(); if(!passer_id) throw new Error('Set Passer (name or ID).');
      return { game_id, play_id, passer_id };
    }
    async function appendRow(route,row,ensure=[]){
      const res = await apiPost({ action:'append', route, row, ensure_headers: ensure });
      if(!res.ok) throw new Error(res.error||'Append failed'); return res;
    }
    document.getElementById('saveBtn').addEventListener('click', async ()=>{
      try{
        const { game_id, play_id, passer_id } = ensureGameAndIds();
        const target_id = el('target_id').value.trim();
        const row = {
          play_id, passer_id, target_id,
          Complete: ynTo01(el('complete').value),
          Interception: ynTo01(el('interception').value),
          Touchdown: ynTo01(el('td').value),
          'Air Yards': numVal(el('air_yards').value),
          YAC: numVal(el('yac').value),
          'Depth Bucket': el('depth_bucket').value || '',
          'L/M/R': el('lmr').value || '',
          'Time to Throw': numVal(el('ttt').value),
          'Sack flag': ynTo01(el('sack').value),
          'Sack Yards': numVal(el('sack_yards').value),
          Throwaway: ynTo01(el('throwaway').value),
          Spike: ynTo01(el('spike').value),
          'Catchable Target': ynTo01(el('catchable').value),
          Drop: ynTo01(el('drop').value),
          'Contested Target': ynTo01(el('contested').value),
          pressure_faced: ynTo01(el('pressure_faced_yn').value)
        };
        await appendRow(ROUTE_PASS, row, Object.keys(row));
        log(`Pass detail saved for ${play_id} (QB ${passer_id}).`, 'success');

        ['air_yards','yac','ttt','sack_yards'].forEach(id=>el(id).value='');
        ['complete','interception','td','sack','throwaway','spike','catchable','drop','contested','pressure_faced_yn']
          .forEach(id=>setToggle(id,false));
        refreshPathState();
      }catch(err){ log(err.message,'error'); }
    });
    document.getElementById('clearBtn').addEventListener('click', ()=>{
      document.querySelectorAll('input').forEach(n=>{
        if(['game_id','play_id','passer_id','passer_name','target_id','target_name','lmr','depth_bucket','pressure_faced_yn','complete','interception','td','sack','throwaway','spike','catchable','drop','contested'].includes(n.id)) return;
        n.value='';
      });
      ['complete','interception','td','sack','throwaway','spike','catchable','drop','contested','pressure_faced_yn'].forEach(id=>setToggle(id,false));
      setSegValue('lmr','Left'); setSegValue('depth_bucket','Behind LOS'); tttReset(); refreshPathState();
    });

    /* ===== Init ===== */
    initSegGroups(); mountToggles(); refreshPathState(); loadSchedule(); loadRoster();

    if (window.GameContext){
      GameContext.subscribe(ctx=>{
        if(ctx.game_id){
          if (scheduleReady()){
            el('game_id').value = ctx.game_id;
            el('game_id').dispatchEvent(new Event('change'));
          } else {
            pendingGidFromCtx = ctx.game_id;
          }
        }
        if(ctx.play_id && !el('play_id').value){ el('play_id').value = ctx.play_id; }
      });
    }
  });
  </script>
</body>
</html>
