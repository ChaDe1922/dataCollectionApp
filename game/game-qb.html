<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QB Tracking – Football Data Tracker</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../js/game-context.js"></script>
  <style>
    .container{max-width:1200px;margin:0 auto;padding:1rem}
    .grid{display:grid;gap:1rem}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .card{background:var(--panel-bg,rgba(255,255,255,.04));border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:1rem}
    .card h2{margin:0 0 .5rem 0;font-size:1.1rem}
    .row{display:flex;gap:.75rem;flex-wrap:wrap}
    .row > *{flex:1 1 160px}
    label{display:block;font-size:.85rem;opacity:.9;margin-bottom:.25rem}
    input,select,textarea{width:100%;padding:.6rem .7rem;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.2);color:#fff}
    .btnbar{display:flex;gap:.5rem;flex-wrap:wrap}
    .btn{padding:.6rem .9rem;border-radius:999px;border:1px solid transparent;cursor:pointer}
    .btn.primary{background:#43b581;color:#071a12}
    .btn.subtle{background:transparent;border-color:rgba(255,255,255,.25);color:#fff}
    .btn.warn{background:#ffa142;color:#2a1800}
    .chip{display:inline-block;padding:.25rem .6rem;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);font-size:.8rem}
    .tiny{font-size:.8rem;opacity:.85}
    .success{color:#7CFC98}.error{color:#ff6b6b}
    .section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:.35rem}
    .meta{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:.5rem;margin-top:.5rem}
    .meta .chip{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .stopwatch{font-variant-numeric:tabular-nums;font-size:1.8rem}

    /* Choice pills (non-binary) */
    .seg{display:inline-flex;gap:.35rem;flex-wrap:wrap}
    .seg-btn{
      padding:.45rem .8rem;border-radius:999px;border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.06);color:#fff;cursor:pointer;user-select:none
    }
    .seg-btn[aria-pressed="true"]{background:#43b581;color:#071a12;border-color:transparent}
    .stack-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:.5rem}
    .stack-4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:.5rem}

    /* Compact toggle switch (Yes/No) */
    .tgl{
      --w:44px; --h:24px;
      position:relative; width:var(--w); height:var(--h);
      border-radius:999px; background:rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.25); cursor:pointer;
      display:inline-block; vertical-align:middle;
    }
    .tgl .knob{
      position:absolute; top:2px; left:2px;
      width:calc(var(--h) - 4px); height:calc(var(--h) - 4px);
      border-radius:999px; background:#fff; transition:transform .18s ease;
    }
    .tgl[data-on="true"]{ background:#43b581; border-color:transparent }
    .tgl[data-on="true"] .knob{ transform:translateX(calc(var(--w) - var(--h))); }
    .field-inline{display:flex;align-items:center;gap:.6rem}

    .group{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:.75rem}
    .gh{font-size:.85rem;opacity:.8;margin-bottom:.35rem}
    .subrow{display:grid;grid-template-columns:1fr auto;align-items:center;gap:.6rem;margin:.3rem 0}
    .group.is-disabled{opacity:.45;pointer-events:none}

    /* —— Throw Detail layout fix —— */
    .throw-grid{
      display:grid;
      grid-template-columns: 1.1fr 1.3fr 1.3fr; /* left a bit narrower */
      gap: 1rem 1.2rem;
      align-items:start;
    }

    /* Responsive: collapse to 2 cols, then 1 */
    @media (max-width: 1120px){
      .throw-grid{ grid-template-columns: 1fr 1fr; }
      #path_target{ grid-column: 1 / -1; } /* span full width */
    }
    @media (max-width: 720px){
      .throw-grid{ grid-template-columns: 1fr; }
    }

    /* Each throw “card” box */
    .throw-card{
      background: var(--panel-bg, rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: .9rem;
      min-width: 0;                /* allow children to shrink inside grid cell */
      display: grid;
      grid-auto-rows: min-content; /* stack neatly */
      row-gap: .65rem;
    }

    /* Label + control blocks stack cleanly */
    .throw-card .field{
      display: grid;
      grid-template-columns: 1fr;  /* keep label then control vertically */
      row-gap: .35rem;
    }

    /* Inputs inside cards */
    .throw-card input[type="text"],
    .throw-card input[type="number"]{
      width: 100%;
    }

    /* Segmented pill groups */
    .seg{
      display:flex;
      flex-wrap: wrap;             /* WRAP! */
      gap: .5rem .55rem;
      min-width: 0;                /* fix flex overflow in grid cell */
    }

    .seg-btn{
      padding: .45rem .75rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: transparent;
      line-height: 1;
      cursor: pointer;
      flex: 0 0 auto;              /* don’t stretch; just wrap to next line */
      white-space: nowrap;         /* each pill doesn’t break mid-word */
    }
    .seg-btn[aria-pressed="true"]{
      background: #43b581;
      color: #071a12;
      border-color: transparent;
    }

    /* Toggle row spacing inside the left/right/target columns */
    .toggle-row{
      display:grid;
      grid-template-columns: auto 1fr; /* label, then control */
      align-items:center;
      gap:.5rem .75rem;
    }

    /* Give the long “Depth Bucket” area breathing room */
    #depthBucketGroup{ margin-top: .25rem; }

    /* Avoid any accidental overlap with following blocks */
    #depthBucketGroup + .field{ margin-top: .35rem; }

    /* Make sure nothing visually spills outside the card */
    .throw-card{ overflow: hidden; } /* with wrap above, this just guards animations */

    /* Slightly smaller helper subtitle so it doesn’t collide with content */
    .card .tiny.helper{
      display:block;
      margin-top:-.25rem;
      margin-bottom:.25rem;
      opacity:.8;
    }


  </style>
</head>

<body class="practice-page">
  <header class="page-header">
    <h1>QB Tracking</h1>
    <nav class="menu-actions">
      <a href="game-day.html" class="menu-btn">Game Day</a>
      <a href="game-primary.html" class="menu-btn">Primary / Drives</a>
      <a href="../index.html" class="menu-btn">Home</a>
    </nav>
  </header>

  <main>
    <div class="container grid grid-2">
      <!-- ===== Game Context ===== -->
      <section class="card">
        <div class="section-title">
          <h2>Game Context</h2>
          <span id="status" class="tiny">Ready</span>
        </div>
        <div class="row">
          <div>
            <label>Game ID <span class="tiny">(from schedule)</span></label>
            <input id="game_id" list="list_game_ids" placeholder="Pick game…"/>
            <datalist id="list_game_ids"></datalist>
          </div>
          <div>
            <label>Play ID <span class="tiny">(link pass to play)</span></label>
            <input id="play_id" placeholder="e.g. PLAY_000123"/>
          </div>
          <div>
            <label>Lookup Play (optional)</label>
            <div class="btnbar">
              <button class="btn subtle" id="lookupPlayBtn">Fetch from Plays</button>
              <button class="btn subtle" id="newPlayIdBtn">New Play ID</button>
            </div>
          </div>
        </div>
        <div id="game_meta" class="meta" style="display:none">
          <span class="chip" id="meta_date"></span>
          <span class="chip" id="meta_week"></span>
          <span class="chip" id="meta_opp"></span>
          <span class="chip" id="meta_ha"></span>
          <span class="chip" id="meta_weather"></span>
        </div>
      </section>

      <!-- ===== TTT Stopwatch ===== -->
      <section class="card">
        <div class="section-title">
          <h2>Time to Throw (TTT)</h2>
          <span class="tiny">Start at snap → stop at pass or sack</span>
        </div>
        <div class="row">
          <div>
            <label>Stopwatch</label>
            <div class="stopwatch" id="ttt_display">0.00</div>
          </div>
          <div>
            <label>TTT (sec)</label>
            <input id="ttt" type="number" step="0.01" placeholder="auto from stopwatch"/>
          </div>
        </div>
        <div class="btnbar" style="margin-top:.4rem">
          <button class="btn primary" id="ttt_start">Start</button>
          <button class="btn subtle" id="ttt_stop">Stop → Field</button>
          <button class="btn warn" id="ttt_reset">Reset</button>
          <button class="btn subtle" data-ttt="1.80">1.80</button>
          <button class="btn subtle" data-ttt="2.30">2.30</button>
          <button class="btn subtle" data-ttt="2.70">2.70</button>
          <button class="btn subtle" data-ttt="3.20">3.20</button>
        </div>
      </section>

      <!-- ===== Participants (filtered by position) ===== -->
      <section class="card">
        <div class="section-title">
          <h2>Participants</h2>
          <span class="tiny">Type to search roster (filtered)</span>
        </div>
        <div class="row">
          <div>
            <label>Passer (name) <span class="tiny chip">QB only</span></label>
            <input id="passer_name" list="list_qb_names" placeholder="QB name…"/>
            <datalist id="list_qb_names"></datalist>
          </div>
          <div>
            <label>Passer ID</label>
            <input id="passer_id" placeholder="auto from name/roster"/>
          </div>
          <div>
            <label>Target (name) <span class="tiny chip">WR/TE/RB/FB</span></label>
            <input id="target_name" list="list_rcv_names" placeholder="WR/TE/RB name…"/>
            <datalist id="list_rcv_names"></datalist>
          </div>
          <div>
            <label>Target ID</label>
            <input id="target_id" placeholder="auto from name/roster"/>
          </div>
        </div>
        <div class="btnbar">
          <button class="btn subtle" id="loadRosterBtn">Reload Roster</button>
          <span class="chip tiny">Roster from 00_Dim_Roster</span>
        </div>
      </section>

      <!-- ===== Throw Detail (ordered by play action) ===== -->
      <section class="card">
        <div class="section-title">
          <h2>Throw Detail</h2>
          <span class="tiny">Auto depth bucket from Air Yards</span>
        </div>

        <div class="throw-grid">
          <!-- 1) Outcome path -->
          <div class="group" id="path_outcome">
            <div class="gh">Outcome path</div>

            <div class="subrow">
              <label>Sack</label>
              <div class="field-inline">
                <button type="button" class="tgl" data-target="sack" role="switch" aria-checked="false" aria-label="Sack"><span class="knob"></span></button>
                <input type="hidden" id="sack" value="No"/>
              </div>
            </div>

            <div class="subrow">
              <label>Sack Yards</label>
              <input id="sack_yards" type="number" step="1" placeholder="—"/>
            </div>

            <div class="subrow">
              <label>Throwaway</label>
              <div class="field-inline">
                <button type="button" class="tgl" data-target="throwaway" role="switch" aria-checked="false" aria-label="Throwaway"><span class="knob"></span></button>
                <input type="hidden" id="throwaway" value="No"/>
              </div>
            </div>

            <div class="subrow">
              <label>Spike</label>
              <div class="field-inline">
                <button type="button" class="tgl" data-target="spike" role="switch" aria-checked="false" aria-label="Spike"><span class="knob"></span></button>
                <input type="hidden" id="spike" value="No"/>
              </div>
            </div>
          </div>

          <!-- 2) Ball flight -->
          <div class="group" id="path_flight">
            <div class="gh">Ball flight</div>

            <div class="subrow">
              <label>Air Yards</label>
              <input id="air_yards" type="number" step="1" placeholder="neg for behind LOS"/>
            </div>

            <div class="subrow">
              <label>Depth Bucket</label>
              <div class="seg stack-4" data-target="depth_bucket">
                <button type="button" class="seg-btn" data-val="Behind LOS" aria-pressed="true">Behind LOS</button>
                <button type="button" class="seg-btn" data-val="Short (1–9)" aria-pressed="false">Short (1–9)</button>
                <button type="button" class="seg-btn" data-val="Intermediate (10–19)" aria-pressed="false">Intermediate</button>
                <button type="button" class="seg-btn" data-val="Deep (20+)" aria-pressed="false">Deep (20+)</button>
              </div>
              <input type="hidden" id="depth_bucket" value="Behind LOS"/>
            </div>

            <div class="subrow">
              <label>Left/Middle/Right</label>
              <div class="seg stack-3" data-target="lmr">
                <button type="button" class="seg-btn" data-val="Left" aria-pressed="true">Left</button>
                <button type="button" class="seg-btn" data-val="Middle" aria-pressed="false">Middle</button>
                <button type="button" class="seg-btn" data-val="Right" aria-pressed="false">Right</button>
              </div>
              <input type="hidden" id="lmr" value="Left"/>
            </div>

            <div class="subrow">
              <label>Pressure Faced</label>
              <div class="field-inline">
                <button type="button" class="tgl" data-target="pressure_faced_yn" role="switch" aria-checked="false" aria-label="Pressure faced"><span class="knob"></span></button>
                <input type="hidden" id="pressure_faced_yn" value="No"/>
              </div>
            </div>
          </div>

          <!-- 3) Target & result -->
          <div class="group" id="path_target">
            <div class="gh">Target &amp; result</div>

            <div class="subrow">
              <label>Catchable Target</label>
              <div class="field-inline">
                <button type="button" class="tgl" data-target="catchable" role="switch" aria-checked="false" aria-label="Catchable target"><span class="knob"></span></button>
                <input type="hidden" id="catchable" value="No"/>
              </div>
            </div>

            <div class="subrow">
              <label>Contested Target</label>
              <div class="field-inline">
                <button type="button" class="tgl" data-target="contested" role="switch" aria-checked="false" aria-label="Contested target"><span class="knob"></span></button>
                <input type="hidden" id="contested" value="No"/>
              </div>
            </div>

            <div class="subrow">
              <label>Complete</label>
              <div class="field-inline">
                <button type="button" class="tgl" data-target="complete" role="switch" aria-checked="false" aria-label="Complete"><span class="knob"></span></button>
                <input type="hidden" id="complete" value="No"/>
              </div>
            </div>

            <div class="subrow">
              <label>Drop</label>
              <div class="field-inline">
                <button type="button" class="tgl" data-target="drop" role="switch" aria-checked="false" aria-label="Drop"><span class="knob"></span></button>
                <input type="hidden" id="drop" value="No"/>
              </div>
            </div>

            <div class="subrow">
              <label>YAC</label>
              <input id="yac" type="number" step="1" placeholder="0"/>
            </div>

            <div class="subrow">
              <label>Touchdown</label>
              <div class="field-inline">
                <button type="button" class="tgl" data-target="td" role="switch" aria-checked="false" aria-label="Touchdown"><span class="knob"></span></button>
                <input type="hidden" id="td" value="No"/>
              </div>
            </div>

            <div class="subrow">
              <label>Interception</label>
              <div class="field-inline">
                <button type="button" class="tgl" data-target="interception" role="switch" aria-checked="false" aria-label="Interception"><span class="knob"></span></button>
                <input type="hidden" id="interception" value="No"/>
              </div>
            </div>
          </div>
        </div>

        <div class="btnbar" style="margin-top:.6rem">
          <button class="btn primary" id="saveBtn">Save Pass Detail</button>
          <button class="btn subtle" id="clearBtn">Clear Fields</button>
        </div>
      </section>


      <!-- ===== Quick Help / Log ===== -->
      <section class="card">
        <div class="section-title">
          <h2>Quick Help</h2>
          <span class="tiny">Rules & sanity</span>
        </div>
        <ul class="tiny">
          <li><strong>Passer list = QBs</strong>. <strong>Target list = WR/TE/RB/FB.</strong></li>
          <li><strong>Interception ON</strong> → Complete OFF.</li>
          <li><strong>Sack ON</strong> → stamps TTT, sets Air Yds &amp; YAC to 0.</li>
          <li><strong>Spike ON</strong> → Catchable OFF, Complete OFF.</li>
          <li><strong>Depth Bucket</strong> auto from Air Yards (≤0: Behind LOS; 1–9: Short; 10–19: Intermediate; ≥20: Deep).</li>
        </ul>
        <div class="section-title" style="margin-top:.5rem">
          <h2>Log</h2><span class="tiny">Most recent first</span>
        </div>
        <div id="log" class="tiny" style="max-height:260px;overflow:auto"></div>
      </section>
    </div>
  </main>

  <footer><p>&copy; 2025 Game Speed Data Systems</p></footer>

  <script>
    /* =======================
    * CONFIG
    * ======================= */
    const API_BASE = 'https://script.google.com/macros/s/AKfycbxQk6BgJLkZltXX7xijq9QKmTEfB51M65cHzrYCe6SCTykrSWnFDMecXfiLGRTd9iOCLg/exec';

    // Schedule (for Game ID picklist)
    const SCHEDULE_SHEET_ID = '1_PXbtnooI9gRxKF6h7BnjQdSVbnQV6D2gwX0zURqtlI';
    const SCHEDULE_TAB = '01_Dim_Schedule';

    // Roster (filtered)
    const ROSTER_SHEET_ID = '1_PXbtnooI9gRxKF6h7BnjQdSVbnQV6D2gwX0zURqtlI';
    const ROSTER_TAB = '00_Dim_Roster';
    const ELIGIBLE_TARGET_POS = ['WR','TE','RB','FB','HB','TB','SB'];

    // Routes
    const ROUTE_PASS = 'pass_detail';

    /* =======================
    * STATE + LOG
    * ======================= */
    const el = id => document.getElementById(id);
    const logBox = el('log');
    const log = (msg, type='')=>{
      const row = document.createElement('div');
      if(type==='success') row.className='success';
      if(type==='error') row.className='error';
      row.textContent = '['+new Date().toLocaleTimeString()+'] '+msg;
      logBox.prepend(row);
      el('status').textContent = (type==='error'?'Error':'Ready');
    };

    let schedule = [], scheduleMap = {};
    let roster = [];
    const playersById = new Map();
    const playersByName = new Map(); // UPPER name -> id
    const playersByNum  = new Map(); // jersey string -> id
    const qbs = [];
    const receivers = [];

    /* =======================
    * API helpers
    * ======================= */
    async function apiGet(params){
      const url = new URL(API_BASE);
      Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
      const r = await fetch(url);
      return r.json();
    }
    async function apiPost(payload){
      const r = await fetch(API_BASE,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      return r.json();
    }
    async function appendRow(route,row,ensure=[]){
      const res = await apiPost({ action:'append', route, row, ensure_headers: ensure });
      if(!res.ok) throw new Error(res.error||'Append failed');
      return res;
    }
    async function nextId(prefix){
      const res = await apiGet({ action:'next_id', prefix });
      if(!res.ok) throw new Error(res.error||'ID failed');
      return res.id;
    }

    /* =======================
    * SCHEDULE
    * ======================= */
    function fillDatalist(id, arr){
      const dl = el(id); dl.innerHTML='';
      arr.forEach(v=>{ const o=document.createElement('option'); o.value=v; dl.appendChild(o); });
    }
    async function loadSchedule(){
      try{
        const res = await apiGet({ action:'table', sheet_id: SCHEDULE_SHEET_ID, sheet_name: SCHEDULE_TAB });
        if(!res.ok) throw new Error(res.error||'Schedule fetch failed');
        schedule = (res.rows||[]).filter(r=>r.game_id);
        scheduleMap = {};
        const ids = [];
        schedule.forEach(r=>{
          const gid = String(r.game_id).trim();
          if(!gid) return;
          scheduleMap[gid]=r; ids.push(gid);
        });
        ids.sort((a,b)=>{
          const ra=scheduleMap[a], rb=scheduleMap[b];
          const da=(ra.date||''), db=(rb.date||'');
          if(da && db && da!==db) return da<db?-1:1;
          return (Number(ra.week||0) - Number(rb.week||0));
        });
        fillDatalist('list_game_ids', ids);
        log(`Schedule loaded (${ids.length} games).`, 'success');
      }catch(err){ log(err.message,'error'); }
    }
    function renderGameMeta(gid){
      const box = el('game_meta');
      const r = scheduleMap[gid];
      if(!r){ box.style.display='none'; return; }
      el('meta_date').textContent   = r.date ? `Date: ${r.date}` : 'Date: —';
      el('meta_week').textContent   = r.week ? `Week: ${r.week}` : 'Week: —';
      el('meta_opp').textContent    = r.opponent ? `Opponent: ${r.opponent}` : 'Opponent: —';
      el('meta_ha').textContent     = r.home_away ? `Venue: ${r.home_away}` : 'Venue: —';
      el('meta_weather').textContent= r.weather_conditions ? `Weather: ${r.weather_conditions}` : 'Weather: —';
      box.style.display='grid';
    }
    el('game_id').addEventListener('change',()=>{
      const gid = el('game_id').value.trim();
      if(!gid){ renderGameMeta(''); return; }
      if(!scheduleMap[gid]){ log(`Game ID "${gid}" not found in schedule.`, 'error'); renderGameMeta(''); return; }
      renderGameMeta(gid);
    });

    /* =======================
    * ROSTER (filtered)
    * ======================= */
    function pushOption(dlId, text){
      const o = document.createElement('option'); o.value = text; el(dlId).appendChild(o);
    }
    function buildRosterIndexes(rows){
      playersById.clear(); playersByName.clear(); playersByNum.clear();
      qbs.length=0; receivers.length=0;
      const qbDL = el('list_qb_names'); const rcvDL = el('list_rcv_names');
      if (qbDL) qbDL.innerHTML=''; if (rcvDL) rcvDL.innerHTML='';

      rows.forEach(r=>{
        const id = (r.player_id||r.id||'').toString().trim();
        const name = (r.player_name||r.name||'').toString().trim();
        const pos = (r.position||r.pos||'').toString().trim().toUpperCase();
        const num = (r.jersey_number||r.jersey||'').toString().trim();
        if(!id || !name) return;

        playersById.set(id.toUpperCase(), {id,name,pos,num});
        playersByName.set(name.toUpperCase(), id);
        if(num) playersByNum.set(String(num), id);

        if(pos==='QB'){ qbs.push(name); }
        if(ELIGIBLE_TARGET_POS.includes(pos)){ receivers.push(name); }
      });

      qbs.sort((a,b)=>a.localeCompare(b));
      receivers.sort((a,b)=>a.localeCompare(b));
      qbs.forEach(n=>pushOption('list_qb_names', n));
      receivers.forEach(n=>pushOption('list_rcv_names', n));
    }
    async function loadRoster(){
      try{
        const res = await apiGet({ action:'roster', sheet_id: ROSTER_SHEET_ID, sheet_name: ROSTER_TAB });
        if(!res.ok) throw new Error(res.error||'Roster fetch failed');
        roster = res.roster||[];
        buildRosterIndexes(roster);
        log(`Roster loaded (${roster.length} players).`, 'success');
      }catch(err){ log(err.message,'error'); }
    }

    function resolvePlayerId(s){
      const t = (s||'').toString().trim();
      if(!t) return '';
      if(playersById.has(t.toUpperCase())) return t; // already an ID
      if(playersByName.has(t.toUpperCase())) return playersByName.get(t.toUpperCase());
      const num = t.replace(/[^0-9]/g,'');
      if(num && playersByNum.has(num)) return playersByNum.get(num);
      return '';
    }
    function syncPlayerIds(){
      const pid = resolvePlayerId(el('passer_name').value) || resolvePlayerId(el('passer_id').value);
      if(pid) el('passer_id').value = pid;
      const tid = resolvePlayerId(el('target_name').value) || resolvePlayerId(el('target_id').value);
      if(tid) el('target_id').value = tid;
    }
    el('loadRosterBtn').addEventListener('click', loadRoster);
    el('passer_name').addEventListener('change', syncPlayerIds);
    el('target_name').addEventListener('change', syncPlayerIds);

    /* =======================
    * Toggle helpers (Yes/No)
    * ======================= */
    function setToggle(id, on){
      const btn = document.querySelector(`.tgl[data-target="${id}"]`);
      const hidden = el(id);
      if(!btn || !hidden) return;
      btn.dataset.on = on ? 'true' : 'false';
      btn.setAttribute('aria-checked', String(on));
      hidden.value = on ? 'Yes' : 'No';
    }
    function mountToggles(){
      document.querySelectorAll('.tgl[data-target]').forEach(btn=>{
        if (btn.dataset.wired === '1') return;
        btn.dataset.wired = '1';
        btn.addEventListener('click', ()=>{
          const id = btn.dataset.target;
          const next = !(btn.dataset.on === 'true');
          setToggle(id, next);

          // sanity ties
          if(id==='interception' && next){ setToggle('complete', false); el('yac').value='0'; }
          if(id==='drop' && next){ setToggle('complete', false); }
          if(id==='spike' && next){ setToggle('catchable', false); setToggle('complete', false); el('yac').value='0'; el('air_yards').value='0'; setSegValue('depth_bucket','Behind LOS'); }
          if(id==='throwaway' && next){ setToggle('complete', false); setToggle('catchable', false); el('yac').value='0'; }
          if(id==='sack' && next){
            tttStop();
            el('air_yards').value='0'; el('yac').value='0';
            setSegValue('depth_bucket','Behind LOS');
          }
          if(id==='complete' && !next){ el('yac').value='0'; }

          refreshPathState();
        });
      });

      // defaults
      ['complete','interception','td','sack','throwaway','spike','catchable','drop','contested','pressure_faced_yn']
        .forEach(id=>setToggle(id,false));
    }

    /* =======================
    * Segmented groups (Depth & L/M/R)
    * ======================= */
    function setSegValue(id, val){
      const hidden = el(id);
      hidden.value = val;
      const group = document.querySelector(`.seg[data-target="${id}"]`);
      if(!group) return;
      group.querySelectorAll('.seg-btn').forEach(btn=>{
        const isActive = btn.dataset.val === val;
        btn.setAttribute('aria-pressed', String(isActive));
      });
    }
    function initSegGroups(){
      document.querySelectorAll('.seg[data-target]').forEach(group=>{
        if (group.dataset.wired === '1') return;
        group.dataset.wired = '1';
        group.addEventListener('click', ev=>{
          const btn = ev.target.closest('.seg-btn'); if(!btn) return;
          const id = group.dataset.target;
          setSegValue(id, btn.dataset.val);
        });
      });
    }

    /* =======================
    * TTT Stopwatch
    * ======================= */
    let tttTimer=null, tttStartMs=0;
    function showTTT(sec){ el('ttt_display').textContent = sec.toFixed(2); }
    function tttStart(){ if(tttTimer) return; tttStartMs = performance.now(); tttTimer = setInterval(()=>{ showTTT((performance.now()-tttStartMs)/1000); }, 20); }
    function tttStop(){ if(!tttTimer) return; clearInterval(tttTimer); tttTimer=null; const s=(performance.now()-tttStartMs)/1000; el('ttt').value=s.toFixed(2); showTTT(s); }
    function tttReset(){ if(tttTimer){clearInterval(tttTimer); tttTimer=null;} showTTT(0); el('ttt').value=''; }
    el('ttt_start').onclick = tttStart;
    el('ttt_stop').onclick  = tttStop;
    el('ttt_reset').onclick = tttReset;
    document.querySelectorAll('button[data-ttt]').forEach(b=>{
      b.addEventListener('click',()=>{ el('ttt').value=b.dataset.ttt; showTTT(Number(b.dataset.ttt)); });
    });

    /* =======================
    * Throw logic helpers
    * ======================= */
    const numVal = v => (v===''||v==null ? '' : Number(v));
    const ynTo01 = v => v==='Yes'?1 : (v==='No'?0 : '');
    function autoDepthFromAir(){
      const ay = Number(el('air_yards').value);
      if(isNaN(ay)) return;
      if(ay <= 0) setSegValue('depth_bucket','Behind LOS');
      else if(ay <= 9) setSegValue('depth_bucket','Short (1–9)');
      else if(ay <= 19) setSegValue('depth_bucket','Intermediate (10–19)');
      else setSegValue('depth_bucket','Deep (20+)');
    }
    el('air_yards').addEventListener('change', autoDepthFromAir);

    // --- path state: enable/disable groups based on outcome ---
    function setGroupDisabled(id, disabled){
      const g = document.getElementById(id);
      if(!g) return;
      g.classList.toggle('is-disabled', !!disabled);
    }

    function refreshPathState(){
      const sackOn  = el('sack').value === 'Yes';
      const spikeOn = el('spike').value === 'Yes';
      const toOn    = el('throwaway').value === 'Yes';

      // Sack → skip flight/target
      setGroupDisabled('path_flight', sackOn);
      setGroupDisabled('path_target', sackOn);

      if (sackOn){
        el('air_yards').value = '0';
        el('yac').value = '0';
        setSegValue('depth_bucket','Behind LOS');
        setToggle('complete', false);
        setToggle('catchable', false);
        setToggle('drop', false);
        setToggle('td', false);
        // leave INT off by default
      }

      // Spike / Throwaway imply no catchable & no completion
      if (spikeOn || toOn){
        setToggle('complete', false);
        setToggle('catchable', false);
        el('yac').value = '0';
        if (spikeOn){
          el('air_yards').value = '0';
          setSegValue('depth_bucket','Behind LOS');
        }
      }
    }

    function wireOutcomeLogic(){
      // Guard against double-binding
      document.querySelectorAll('.tgl[data-target]').forEach(btn=>{
        if (btn.dataset.wiredOutcome === '1') return;
        btn.dataset.wiredOutcome = '1';
        btn.addEventListener('click', ()=>{
          const id = btn.dataset.target;
          if(id==='interception' && btn.getAttribute('aria-checked')==='true'){ setToggle('complete', false); el('yac').value='0'; }
          if(id==='drop' && btn.getAttribute('aria-checked')==='true'){ setToggle('complete', false); }
          refreshPathState();
        });
      });

      el('air_yards').addEventListener('change', autoDepthFromAir);
    }

    /* =======================
    * Plays lookup (optional)
    * ======================= */
    async function lookupPlay(){
      try{
        const pid = el('play_id').value.trim();
        if(!pid) throw new Error('Enter a Play ID first.');
        const res = await apiGet({ action:'table', sheet_id: SCHEDULE_SHEET_ID, sheet_name: '20_Fact_Plays' });
        if(!res.ok) throw new Error(res.error||'Fetch plays failed');
        const row = (res.rows||[]).find(r => String(r.play_id||'').trim() === pid);
        if(!row){ log(`Play ${pid} not found in 20_Fact_Plays`, 'error'); return; }
        log(`Play ${pid} found (Q${row.quarter||'?'} @ ${row.clock||'??:??'})`, 'success');
      }catch(err){ log(err.message,'error'); }
    }
    el('lookupPlayBtn').addEventListener('click', lookupPlay);
    el('newPlayIdBtn').addEventListener('click', async ()=>{
      try{ const id = await nextId('PLAY'); el('play_id').value = id; log(`New Play ID: ${id}`,'success'); }
      catch(err){ log(err.message,'error'); }
    });

    /* =======================
    * SAVE
    * ======================= */
    function ensureGameAndIds(){
      const game_id = el('game_id').value.trim();
      if(!game_id) throw new Error('Pick a Game ID from schedule.');
      if(!scheduleMap[game_id]) throw new Error('Game ID not found in schedule.');
      const play_id = el('play_id').value.trim();
      if(!play_id) throw new Error('Enter a Play ID.');
      syncPlayerIds();
      const passer_id = el('passer_id').value.trim();
      if(!passer_id) throw new Error('Set Passer (name or ID).');
      return { game_id, play_id, passer_id };
    }

    el('saveBtn').addEventListener('click', async ()=>{
      try{
        const { game_id, play_id, passer_id } = ensureGameAndIds();
        const target_id = el('target_id').value.trim();

        const row = {
          play_id,
          passer_id,
          target_id,
          Complete: ynTo01(el('complete').value),
          Interception: ynTo01(el('interception').value),
          Touchdown: ynTo01(el('td').value),
          'Air Yards': numVal(el('air_yards').value),
          YAC: numVal(el('yac').value),
          'Depth Bucket': el('depth_bucket').value || '',
          'L/M/R': el('lmr').value || '',
          'Time to Throw': numVal(el('ttt').value),
          'Sack flag': ynTo01(el('sack').value),
          'Sack Yards': numVal(el('sack_yards').value),
          Throwaway: ynTo01(el('throwaway').value),
          Spike: ynTo01(el('spike').value),
          'Catchable Target': ynTo01(el('catchable').value),
          Drop: ynTo01(el('drop').value),
          'Contested Target': ynTo01(el('contested').value),
          pressure_faced: ynTo01(el('pressure_faced_yn').value)
        };

        await appendRow(ROUTE_PASS, row, Object.keys(row));
        log(`Pass detail saved for ${play_id} (QB ${passer_id}).`, 'success');

        // quick clear (keep IDs + pills)
        ['air_yards','yac','ttt','sack_yards'].forEach(id=>el(id).value='');
        ['complete','interception','td','sack','throwaway','spike','catchable','drop','contested','pressure_faced_yn']
          .forEach(id=>setToggle(id,false));
        refreshPathState();
      }catch(err){ log(err.message,'error'); }
    });

    el('clearBtn').addEventListener('click', ()=>{
      document.querySelectorAll('input').forEach(n=>{
        if(['game_id','play_id','passer_id','passer_name','target_id','target_name','lmr','depth_bucket','pressure_faced_yn','complete','interception','td','sack','throwaway','spike','catchable','drop','contested'].includes(n.id)) return;
        n.value='';
      });
      // toggles & pills defaults
      ['complete','interception','td','sack','throwaway','spike','catchable','drop','contested','pressure_faced_yn'].forEach(id=>setToggle(id,false));
      setSegValue('lmr','Left');
      setSegValue('depth_bucket','Behind LOS');
      tttReset();
      refreshPathState();
    });

    /* =======================
    * INIT
    * ======================= */
    initSegGroups();
    mountToggles();
    refreshPathState();
    wireOutcomeLogic();
    loadSchedule();
    loadRoster();

    // Follow context from Primary/Drives if open on same device
    if (window.GameContext){
      GameContext.subscribe(ctx=>{
        if(ctx.game_id && el('game_id').value!==ctx.game_id){ el('game_id').value=ctx.game_id; el('game_id').dispatchEvent(new Event('change')); }
        if(ctx.play_id && !el('play_id').value){ el('play_id').value = ctx.play_id; }
      });
    }
  </script>

</body>
</html>
