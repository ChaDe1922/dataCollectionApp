<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script>
  (function(){
    const ok = localStorage.getItem('auth_ok')==='1' &&
              Number(localStorage.getItem('auth_until')||0) > Date.now();
    if(!ok){ window.location.href = '../index.html#login'; }
  })();
  </script>
  <title>Practice Attendance – Football Data Tracker</title>

  <!-- Fonts + shared theme -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../style.css"/>

  <style>
    :root{
      --page-bg:#f5f7fb; --tile:#fff; --tile-bd:#e6e9f2; --tile-shadow:0 10px 22px rgba(9,14,34,.08);
      --text:#1f2937; --text-strong:#111827; --text-subtle:#6b7280;
      --accent:#7C4DFF; --accent2:#8B5CF6;
      --late:#F59E0B; --present:#22C55E; --excused:#3B82F6; --exlate:#8B5CF6;
      --chip-bg:#f3f4f6; --chip-bd:#e5e7eb; --focus-ring:0 0 0 3px rgba(124,77,255,.25);
      --border:#e6e9f2;
    }

    body{ background:var(--page-bg); color:var(--text); font-family:Manrope,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
    .page-header{ display:flex;align-items:center;justify-content:space-between; padding:14px 16px 0; max-width:1100px; margin:0 auto; }
    .page-header h1{ margin:0; font-weight:800; color:var(--text-strong) }
    .menu-actions{display:flex;gap:.5rem}
    .menu-btn{ display:inline-flex;align-items:center;gap:.4rem;padding:.55rem .85rem;border-radius:10px;background:#fff;border:1px solid var(--tile-bd);box-shadow:var(--tile-shadow);color:var(--text-strong);text-decoration:none;font-weight:700 }

    /* Layout – mobile first */
    .container{
      max-width:1100px;margin:0 auto;padding:16px;
      display:grid;gap:16px;
      grid-template-columns:1fr;
      grid-template-areas:
        "setup"
        "tools"
        "roster"
        "notchecked"
        "log";
    }
    @media (min-width:980px){
      .container{
        grid-template-columns:2fr 1fr;
        grid-template-areas:
          "setup      tools"
          "roster     notchecked"
          "log        log";
      }
    }

    /* Cards */
    .card{ background:var(--tile); border:1px solid var(--tile-bd); border-radius:16px; padding:16px; color:var(--text); box-shadow:var(--tile-shadow) }
    .section-title{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
    .section-title h2{margin:0;font-size:1.15rem;color:var(--text-strong)}
    .tiny{font-size:.9rem;color:var(--text-subtle)}

    /* Inputs */
    label{display:block;font-size:.9rem;color:var(--text-subtle);margin:0 0 .35rem}
    input,select{
      width:100%;padding:.7rem .85rem;border-radius:12px;border:1px solid #d1d5db;background:#fff;color:var(--text);font-size:1rem;
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    input:focus,select:focus{ outline:none;border-color:#a78bfa;box-shadow:var(--focus-ring);background:#fff; }

    /* Make number inputs (Grace) match style; remove spinners */
    input[type="number"]{ appearance:textfield; -moz-appearance:textfield; background:#fff; border:1px solid #d1d5db; border-radius:12px; padding:.7rem .85rem; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    #prac_grace{ background:#fff; border:1px solid #d1d5db; border-radius:12px; }

    .row{display:grid;gap:12px}
    .row.cols-3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:680px){ .row.cols-3{grid-template-columns:1fr} }

    /* Buttons */
    .btnbar{display:flex;gap:.5rem;flex-wrap:wrap}
    .btn{ padding:.65rem 1rem;border-radius:999px;border:1px solid transparent;cursor:pointer;
      background:linear-gradient(135deg,var(--accent) 0%, var(--accent2) 100%);color:#fff;font-weight:800;
      box-shadow:0 10px 24px rgba(124,77,255,.25); transition:transform .15s ease,filter .15s ease; }
    .btn:hover{transform:translateY(-2px);filter:saturate(1.05)}
    .btn.subtle{ background:#fff;border-color:#d1d5db;color:var(--text-strong);box-shadow:var(--tile-shadow) }
    .btn.warn{ background:#F59E0B;color:#1f1300;border-color:#a66b07 }
    .btn.neutral{ background:#2b2f3a; color:#fff; border:1px solid rgba(255,255,255,.35) }

    /* Player grid */
    .toolbar{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;margin-bottom:.6rem}
    .search{flex:1 1 240px}
    .player-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:.6rem}
    .plyr{
      position:relative;border:1px solid #e5e7eb;border-radius:12px;padding:.72rem .8rem;background:#ffffff;cursor:pointer;
      display:flex;gap:.65rem;align-items:center;min-height:58px;user-select:none;color:var(--text);box-shadow:var(--tile-shadow);
      transition:transform .06s ease, border-color .06s ease, background .06s ease, box-shadow .06s ease;
    }
    .plyr:hover{transform:translateY(-1px);border-color:#d1d5db}
    .num{width:36px;height:36px;border-radius:9px;background:#f3f4f6;display:grid;place-items:center;font-weight:800;color:var(--text-strong)}
    .plyr .name{min-width:0}
    .plyr .name > div:first-child{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:800;letter-spacing:.2px;color:var(--text-strong)}
    .plyr .pos{color:var(--text-subtle)}
    .stamp{font-variant-numeric:tabular-nums;font-size:.82rem;color:#455a64;margin-left:auto}
    .status{position:absolute;right:8px;top:8px;font-size:.72rem;padding:.16rem .48rem;border-radius:999px;border:1px solid var(--chip-bd);background:var(--chip-bg);color:var(--text-strong)}
    .saved::after{content:'✓';position:absolute;left:-6px;top:-6px;width:18px;height:18px;border-radius:50%;background:#22c55e;color:#052e1a;font-size:.75rem;display:grid;place-items:center;border:1px solid #0a7a3a;}
    .plyr.state-on  { background:#f0fdf4; border-color:rgba(34,197,94,.4) }
    .plyr.state-late{ background:#fffbeb; border-color:rgba(245,158,11,.5) }
    .plyr.state-exc { background:#eff6ff; border-color:rgba(59,130,246,.45) }
    .plyr.state-excl{ background:#f5f3ff; border-color:rgba(139,92,246,.5) }

    /* Chips + filters */
    .chip{display:inline-block;padding:.3rem .6rem;border-radius:999px;background:var(--chip-bg);border:1px solid var(--chip-bd);font-size:.85rem;color:var(--text)}
    .chipbar{display:flex;gap:.4rem;overflow:auto;padding:.2rem 0;-webkit-overflow-scrolling:touch}
    .filter-chip{cursor:pointer;user-select:none;white-space:nowrap;background:var(--chip-bg);border:1px solid var(--chip-bd);color:var(--text);font-weight:800;border-radius:999px;padding:.42rem .8rem;transition:background .15s ease,border-color .15s ease,box-shadow .15s ease,transform .15s ease}
    .filter-chip[aria-pressed="true"]{ background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#fff;border-color:transparent;box-shadow:0 8px 18px rgba(139,92,246,.28) }

    /* Right column list (Not Checked In) */
    .mini{display:flex;flex-direction:column;gap:8px}
    .mini .mrow{display:grid;grid-template-columns:64px 1fr 90px;gap:8px;align-items:center;background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px;box-shadow:var(--tile-shadow)}

    /* Log */
    #log{max-height:260px;overflow:auto;background:#fff;border:1px solid var(--tile-bd);border-radius:12px;padding:10px;color:var(--text);box-shadow:var(--tile-shadow)}

    /* Popover */
    .popover{
      position:fixed;z-index:50;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:.4rem;box-shadow:0 12px 34px rgba(0,0,0,.12)
    }
    .popover button{display:block;width:100%;text-align:left;padding:.5rem .7rem;border-radius:8px;border:1px solid transparent;background:transparent;color:var(--text)}
    .popover button:hover{background:#f3f4f6;border-color:#e5e7eb}
    .hidden{ display:none !important; } /* keep menu hidden until opened */

    /* Busy / Loading */
    .loading-overlay{ position:absolute; inset:44px 10px 10px 10px; display:none; align-items:center; justify-content:center;
      background:rgba(7,9,18,.10); border:1px dashed #ccd2e4; border-radius:12px; }
    .loading-overlay.active{ display:flex; }
    .spinner{width:22px;height:22px;border-radius:50%;border:3px solid rgba(0,0,0,.18);border-top-color:#7C4DFF;animation:spin .8s linear infinite;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .busy{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#141a28;border:1px solid rgba(255,255,255,.18);color:#fff;padding:8px 10px;border-radius:10px;display:none;z-index:1000;align-items:center}
    .busy.active{display:flex}
    .busy .spinner{border-color:rgba(255,255,255,.28);border-top-color:#9b87f5}

    /* Mobile tweaks */
    @media (max-width:700px){
      .player-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:.5rem}
      .plyr{padding:.6rem .65rem;min-height:56px;border-radius:10px}
      .num{width:32px;height:32px;border-radius:8px;font-size:.9rem}
      .status{right:6px;top:6px;font-size:.68rem;padding:.1rem .4rem}
      .stamp{display:none}
    }
    @media (max-width:420px){
      .player-grid{grid-template-columns:repeat(2,minmax(0,1fr));gap:.45rem}
      .plyr{padding:.55rem .6rem;gap:.5rem}
      .num{width:30px;height:30px;border-radius:8px}
    }
  </style>
</head>

<body class="practice-page">
  <header class="page-header">
    <h1>Practice Attendance</h1>
    <nav class="menu-actions">
      <a href="../index.html" class="menu-btn">Home</a>
      <a href="practice.html" class="menu-btn">Practice</a>
    </nav>
  </header>

  <main>
    <div class="container">
      <!-- Setup -->
      <section class="card" style="grid-area:setup">
        <div class="section-title">
          <h2>Practice Setup</h2>
          <span id="status" class="tiny">Ready</span>
        </div>

        <div class="row cols-3">
          <div><label>Date</label><input id="prac_date" type="date"/></div>
          <div><label>Start Time</label><input id="prac_time" type="time" step="60"/></div>
          <div><label>Grace (min)</label><input id="prac_grace" type="number" step="1" value="0"/></div>
        </div>

        <div class="btnbar" style="margin-top:.6rem">
          <button class="btn subtle" id="setNowBtn">Set start = now</button>
          <label class="chip tiny" style="margin-left:auto;display:flex;align-items:center;gap:.5rem">
            <input type="checkbox" id="autosave" checked style="accent-color:#7C4DFF; width:16px; height:16px"> Autosave on click
          </label>
        </div>
      </section>

      <!-- Tools -->
      <section class="card" style="grid-area:tools">
        <div class="section-title">
          <h2>Controls</h2>
          <span class="tiny">Save & finalize</span>
        </div>
        <div class="btnbar">
          <button class="btn" id="saveAllBtn">Save all unsaved</button>
          <button class="btn warn" id="finalizeBtn">Finalize: mark remaining Absent</button>
          <button class="btn subtle" id="reloadRosterBtn">Reload Roster</button>
          <button class="btn neutral" id="clearSelectedBtn">Clear Selected</button>
        </div>
        <div class="tiny" style="margin-top:.5rem;">
          Tip: tap = On time/Late (auto). Long-press or right-click a card for <strong>Excused</strong> or <strong>Excused Late</strong>.
        </div>
      </section>

      <!-- Roster -->
      <section class="card" style="grid-area:roster; position:relative;">
        <div class="section-title">
          <h2>Roster</h2>
          <div class="toolbar">
            <input id="search" class="search" placeholder="Search by name/number/position…"/>
            <span class="chip tiny" id="graceBadge">Grace: 0m</span>
            <span class="chip tiny" id="countBadge">0 players</span>
          </div>
        </div>

        <div class="chipbar" id="groupChips" role="tablist" aria-label="Groups">
          <button class="chip filter-chip" data-group="ALL" aria-pressed="true">All</button>
          <button class="chip filter-chip" data-group="OFF">Offense</button>
          <button class="chip filter-chip" data-group="DEF">Defense</button>
          <button class="chip filter-chip" data-group="ST">Special Teams</button>
          <button class="chip filter-chip" data-group="COACH">Coaches</button>
        </div>
        <div class="chipbar" id="posChips" aria-label="Positions"></div>

        <div id="grid" class="player-grid" aria-live="polite"></div>

        <!-- Loading overlay -->
        <div id="gridLoading" class="loading-overlay" aria-live="polite">
          <div class="spinner" role="progressbar" aria-label="Loading"></div>
          <div>Loading roster…</div>
        </div>
      </section>

      <!-- Not Checked In -->
      <section class="card" style="grid-area:notchecked">
        <div class="section-title">
          <h2>Not Checked In</h2>
        </div>
        <div class="tiny" style="margin-bottom:.4rem">Updates live as you mark arrivals.</div>
        <div id="notCheckedList" class="mini"></div>
      </section>

      <!-- Log -->
      <section class="card" style="grid-area:log">
        <div class="section-title"><h2>Log</h2><span class="tiny">Most recent first</span></div>
        <div id="log" class="tiny"></div>
      </section>
    </div>
  </main>

  <!-- Status popover -->
  <div id="statusMenu" class="popover hidden" role="menu" aria-hidden="true">
    <button data-action="on">On time</button>
    <button data-action="late">Late</button>
    <button data-action="excused">Excused</button>
    <button data-action="excused_late">Excused Late</button>
    <hr style="border:none;border-top:1px solid #e5e7eb;margin:.3rem 0"/>
    <button data-action="clear">Clear</button>
  </div>

  <!-- Global busy indicator -->
  <div id="busy" class="busy" aria-live="polite">
    <div class="spinner" role="progressbar" aria-label="Working"></div>
    <div class="busy-text">Working…</div>
  </div>

  <footer class="site-footer" style="max-width:1100px;margin:24px auto;padding:0 16px;">
    <p class="tiny">&copy; 2025 Game Speed Data Systems</p>
  </footer>

  <!-- JS -->
  <script>
    /* =======================
     * CONFIG
     * ======================= */
    const API_BASE = 'https://script.google.com/macros/s/AKfycbxQk6BgJLkZltXX7xijq9QKmTEfB51M65cHzrYCe6SCTykrSWnFDMecXfiLGRTd9iOCLg/exec';
    const ROSTER_SHEET_ID = '1_PXbtnooI9gRxKF6h7BnjQdSVbnQV6D2gwX0zURqtlI';
    const ROSTER_TAB = '00_Dim_Roster';
    const ATTEND_SHEET_ID = '1pT-7cXhfzJB5mjswsXayvjt_qC2hIp9WflWggIAyh8g';
    const ATTEND_TAB = '60_Fact_PracticeAttendance';

    const ATTEND_HEADERS = ['timestamp','date','practice_start','grace_minutes','player_id','player_name','position','jersey_number','status','arrived_at','minutes_late'];

    /* =======================
     * STATE + LOG
     * ======================= */
    const el = id => document.getElementById(id);
    const logBox = el('log');
    const log = (msg, type='')=>{
      const row = document.createElement('div');
      if(type==='success') row.style.color='#047857';
      if(type==='error') row.style.color='#b91c1c';
      row.textContent = '['+new Date().toLocaleTimeString()+'] '+msg;
      logBox.prepend(row);
      const st = document.getElementById('status'); if(st) st.textContent = (type==='error'?'Error':'Ready');
    };

    // Busy helpers (bottom toast + grid overlay)
    const busy = { count:0 };
    function setBusy(on, label){
      busy.count += on ? 1 : -1;
      busy.count = Math.max(0, busy.count);
      const b = el('busy');
      if(!b) return;
      if(label) b.querySelector('.busy-text').textContent = label;
      b.classList.toggle('active', busy.count>0);
    }
    function setGridLoading(on){ el('gridLoading')?.classList.toggle('active', !!on); }

    let roster = [];
    const playersById = new Map();
    const attendance = new Map();

    // Session persistence
    const SESSION_KEY = 'ATTEND_SESS_V1';
    function sessionSnapshot(){
      const att = {}; attendance.forEach((v, k)=>{ att[k] = v; });
      return {
        date: el('prac_date').value || '',
        time: el('prac_time').value || '',
        grace: Number(el('prac_grace').value||0),
        autosave: !!el('autosave').checked,
        attendance: att,
        ts: Date.now(),
        finalized: false
      };
    }
    function saveSession(){ try { localStorage.setItem(SESSION_KEY, JSON.stringify(sessionSnapshot())); } catch(e){} }
    function clearSession(){ try { localStorage.removeItem(SESSION_KEY); } catch(e){} }
    function loadSession(){
      try { const raw = localStorage.getItem(SESSION_KEY); if(!raw) return null; const data = JSON.parse(raw); return (data && typeof data==='object') ? data : null; }
      catch(e){ return null; }
    }

    // Filters
    const filterState = { group: 'ALL', positions: new Set() };
    let groupChipsWired = false;

    const menu = document.getElementById('statusMenu');
    let menuTargetId = null;

    /* =======================
     * API helpers
     * ======================= */
    async function apiGet(params){
      const url = new URL(API_BASE);
      Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
      const r = await fetch(url);
      return r.json();
    }
    async function apiPost(payload){
      const r = await fetch(API_BASE, { method:'POST', headers:{ 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }
    async function appendRowTable(sheet_id, sheet_name, row, ensure=[]){
      const res = await apiPost({ action:'append', sheet_id, sheet_name, row, ensure_headers: ensure });
      if(!res.ok) throw new Error(res.error||'Append failed');
      return res;
    }
    async function batchAppend(ops){
      const res = await apiPost({ action:'batch', ops });
      if(!res.ok) throw new Error(res.error||'Batch failed');
      return res;
    }

    /* =======================
     * ROSTER
     * ======================= */
    function isCoachId(id){ return /^CO/i.test(String(id||'')); }
    function normalizeRoster(rows){
      return rows.map(r=>{
        const id  = (r.player_id||r.id||'').toString().trim();
        const pos = (r.position||r.pos||'').toString().trim().toUpperCase();
        const name= (r.player_name||r.name||'').toString().trim();
        const num = (r.jersey_number||r.jersey||'').toString().trim();
        const role = isCoachId(id) ? 'Coach' : 'Player';
        return { id, name, pos, num, role };
      }).filter(p=>p.id && p.name);
    }
    async function loadRoster(){
      try{
        setGridLoading(true); setBusy(true,'Loading roster…');
        const res = await apiGet({ action:'roster', sheet_id: ROSTER_SHEET_ID, sheet_name: ROSTER_TAB });
        if(!res.ok) throw new Error(res.error||'Roster fetch failed');
        roster = normalizeRoster(res.roster||[]);
        playersById.clear(); roster.forEach(p=>playersById.set(p.id,p));
        buildPosChips(); wireGroupChips();
        restoreFromSession();
        renderGrid();
        log(`Roster loaded (${roster.length} people).`, 'success');
      }catch(err){ log(err.message,'error'); }
      finally{ setGridLoading(false); setBusy(false); }
    }

    /* =======================
     * FILTER HELPERS
     * ======================= */
    function inGroup(pos, group, role){
      const p = (pos||'').toUpperCase();
      if(group==='ALL') return true;
      if(group==='COACH') return role === 'Coach';
      const OFF = ['QB','RB','WR','TE','OL','FB','HB','TB','OT','OG','OC','C','LT','RT','LG','RG','OFF'];
      const DEF = ['DL','DE','DT','NT','LB','ILB','OLB','MLB','CB','DB','S','FS','SS','NB','DEF'];
      const ST  = ['K','P','LS','KR','PR','PK','K/P','ST'];
      const hasPrefix = arr => arr.some(k => p===k || p.startsWith(k));
      if(group==='OFF') return hasPrefix(OFF);
      if(group==='DEF') return hasPrefix(DEF);
      if(group==='ST')  return hasPrefix(ST);
      return true;
    }
    function wireGroupChips(){
      if(groupChipsWired) return;
      const wrap = document.getElementById('groupChips'); if(!wrap) return;
      wrap.querySelectorAll('.filter-chip').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          wrap.querySelectorAll('.filter-chip').forEach(b=>b.setAttribute('aria-pressed','false'));
          btn.setAttribute('aria-pressed','true');
          filterState.group = btn.dataset.group;
          renderGrid();
        });
      });
      groupChipsWired = true;
    }
    function buildPosChips(){
      const holder = document.getElementById('posChips'); if(!holder) return;
      const all = Array.from(new Set(roster.map(r=>(r.pos||'').toUpperCase())))
        .filter(x => x)
        .sort((a,b)=>a.localeCompare(b));
      holder.innerHTML = [
        `<button class="chip filter-chip" data-clear="1" aria-pressed="false">Clear</button>`,
        ...all.map(p => `<button class="chip filter-chip" data-pos="${p}" aria-pressed="${filterState.positions.has(p) ? 'true' : 'false'}">${p}</button>`)
      ].join('');
      holder.querySelector('[data-clear]').addEventListener('click', ()=>{
        filterState.positions.clear();
        holder.querySelectorAll('[data-pos]').forEach(b=>b.setAttribute('aria-pressed','false'));
        renderGrid();
      });
      holder.querySelectorAll('[data-pos]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const pos = btn.dataset.pos;
          if(filterState.positions.has(pos)){ filterState.positions.delete(pos); btn.setAttribute('aria-pressed','false'); }
          else { filterState.positions.add(pos); btn.setAttribute('aria-pressed','true'); }
          renderGrid();
        });
      });
    }

    /* =======================
     * TIME + BADGES
     * ======================= */
    function practiceStartMs(){
      const d = el('prac_date').value, t = el('prac_time').value;
      if(!d || !t) return null;
      const [yy,mm,dd] = d.split('-').map(Number);
      const [h,mi] = t.split(':').map(Number);
      return new Date(yy, mm-1, dd, h, mi, 0, 0).getTime();
    }
    function toLocalT(dt){ const d = (dt instanceof Date) ? dt : new Date(dt); return d.toLocaleString('sv-SE').replace(' ','T'); }
    function classifyArrival(arriveMs){
      const start = practiceStartMs();
      if(!start) return { status:'On time', minutesLate:0 };
      const grace = Number(el('prac_grace').value||0);
      const lateBy = Math.max(0, Math.round((arriveMs - start)/60000) - grace);
      return { status: lateBy > 0 ? 'Late' : 'On time', minutesLate: Math.max(0,lateBy) };
    }
    function setNowAsStart(){
      const now = new Date();
      el('prac_date').value = now.toISOString().slice(0,10);
      el('prac_time').value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
      saveSession(); updateGraceBadge();
    }
    function updateGraceBadge(){
      const g = Number(el('prac_grace').value||0);
      const b = el('graceBadge'); if(b) b.textContent = `Grace: ${g}m`;
    }

    /* =======================
     * UI: GRID + NOT CHECKED LIST
     * ======================= */
    function statusChip(rec){
      if(!rec) return '';
      let base = 'on';
      if(rec.status==='Late') base = 'late';
      else if(rec.status==='Excused') base = 'exc';
      else if(rec.status==='Excused Late') base = 'excl';
      const extra = rec.minutesLate?` (+${rec.minutesLate})`:'';
      return `<span class="status ${base}">${rec.status}${extra}</span>`;
    }
    function playerCard(p){
      const rec = attendance.get(p.id);
      const clsSaved = rec?.saved ? 'saved' : '';
      let stateCls = '';
      if(rec){
        stateCls =
          rec.status==='Excused'      ? 'state-exc'  :
          rec.status==='Excused Late' ? 'state-excl' :
          rec.status==='Late'         ? 'state-late' : 'state-on';
      }
      const stamp = rec?.arrivedAt ? new Date(rec.arrivedAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
      const leftBox = (p.role === 'Coach') ? `<div class="num" title="Coach">CO</div>` : `<div class="num">#${p.num||'—'}</div>`;
      const coachBadge = p.role === 'Coach' ? `<span class="chip tiny" style="margin-left:.4rem">Coach</span>` : '';
      return `
        <button class="plyr ${clsSaved} ${stateCls}" data-id="${p.id}" aria-pressed="${rec?'true':'false'}">
          ${leftBox}
          <div class="name">
            <div>${p.name} ${coachBadge}</div>
            <div class="pos tiny">${p.pos||''}</div>
          </div>
          <div class="stamp">${stamp}</div>
          ${statusChip(rec)}
        </button>
      `;
    }
    function renderNotChecked(){
      const notChecked = roster.filter(p=>!attendance.has(p.id));
      const list = el('notCheckedList'); list.innerHTML = '';
      notChecked.sort((a,b)=> (parseInt(a.num||'9999',10) - parseInt(b.num||'9999',10)) || a.name.localeCompare(b.name))
        .forEach(p=>{
          const row = document.createElement('div');
          row.className = 'mrow';
          row.innerHTML = `<div style="font-variant-numeric:tabular-nums;text-align:right;font-weight:800">#${p.num||'—'}</div>
                           <div>${p.name}</div>
                           <div style="color:#6b7280">${p.pos||''}</div>`;
          list.appendChild(row);
        });
    }
    function renderGrid(){
      const q = el('search').value.trim().toUpperCase();
      const textMatch = p => !q || p.name.toUpperCase().includes(q) || (p.num||'').toString().includes(q) || (p.pos||'').toUpperCase().includes(q);

      const posMatch = (pos) => {
        const up = (pos||'').toUpperCase();
        if(filterState.positions.size > 0){ return filterState.positions.has(up); }
        return true;
      };
      const byFilters = p => inGroup(p.pos, filterState.group, p.role) && posMatch(p.pos);

      const numKey = p => { const n = parseInt((p.num||'').toString(), 10); return Number.isFinite(n) ? n : Number.POSITIVE_INFINITY; };
      const sortByNum = (a,b) => (numKey(a) - numKey(b)) || a.name.localeCompare(b.name);

      const main = roster.filter(p=> textMatch(p) && byFilters(p)).sort(sortByNum);
      el('grid').innerHTML = main.map(playerCard).join('');
      el('countBadge').textContent = `${main.length} players`;

      renderNotChecked();
      updateGraceBadge();
    }

    /* =======================
     * SAVE HELPERS
     * ======================= */
    function buildRow(p, rec){
      const startLocal = (()=>{ const ms=practiceStartMs(); return ms? toLocalT(ms) : ''; })();
      return {
        timestamp: toLocalT(new Date()),
        date: el('prac_date').value || '',
        practice_start: startLocal,
        grace_minutes: Number(el('prac_grace').value||0),
        player_id: p.id, player_name: p.name, position: p.pos||'', jersey_number: p.num||'',
        status: rec.status,
        arrived_at: rec.arrivedAt ? toLocalT(rec.arrivedAt) : '',
        minutes_late: (rec.status==='Late' || rec.status==='Excused Late') ? rec.minutesLate : ''
      };
    }
    async function saveOne(pId){
      const rec = attendance.get(pId); if(!rec || rec.saved) return;
      const p = playersById.get(pId);
      const row = buildRow(p, rec);
      await appendRowTable(ATTEND_SHEET_ID, ATTEND_TAB, row, ATTEND_HEADERS);
      rec.saved = true; attendance.set(pId, rec);
      saveSession(); renderGrid();
    }
    function maybeAutosave(id, action){
      if (!el('autosave').checked) return;
      if (action === 'clear') return;
      if (!attendance.has(id)) return;
      setBusy(true,'Saving…');
      saveOne(id).catch(err=>log(String(err),'error')).finally(()=>setBusy(false));
    }
    async function saveAllUnsaved(){
      setBusy(true,'Saving all…');
      const ops = [];
      attendance.forEach((rec, pId)=>{
        if(rec.saved) return;
        const p = playersById.get(pId);
        ops.push({ sheet_id: ATTEND_SHEET_ID, sheet_name: ATTEND_TAB, row: buildRow(p, rec), ensure_headers: ATTEND_HEADERS });
      });
      if(!ops.length){ log('Nothing to save (all up to date).'); setBusy(false); return; }
      try{
        await batchAppend(ops);
        attendance.forEach((rec)=>{ if(!rec.saved) rec.saved=true; });
        saveSession(); renderGrid();
        log(`Saved ${ops.length} attendance rows.`, 'success');
      }catch(e){ log(String(e),'error'); }
      finally{ setBusy(false); }
    }
    function resetSetupToNow(){
      const now = new Date();
      el('prac_date').value = now.toISOString().slice(0,10);
      el('prac_time').value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
      el('prac_grace').value = 0; saveSession(); updateGraceBadge();
    }
    async function finalizeAbsent(){
      setBusy(true,'Finalizing…');
      try{
        const absentees = roster.filter(p=>!attendance.has(p.id));
        if(!absentees.length){ log('No absentees to mark.'); }
        else{
          const ops = absentees.map(p=>({
            sheet_id: ATTEND_SHEET_ID, sheet_name: ATTEND_TAB,
            row: {
              timestamp: toLocalT(new Date()),
              date: el('prac_date').value || '',
              practice_start: (()=>{ const ms=practiceStartMs(); return ms? toLocalT(ms) : '';})(),
              grace_minutes: Number(el('prac_grace').value||0),
              player_id: p.id, player_name: p.name, position: p.pos||'', jersey_number: p.num||'',
              status: 'Absent', arrived_at: '', minutes_late: ''
            },
            ensure_headers: ATTEND_HEADERS
          }));
          await batchAppend(ops);
          log(`Finalized: marked ${ops.length} absent.`, 'success');
        }
        clearSession(); attendance.clear(); resetSetupToNow(); renderGrid();
      }catch(e){ log(String(e),'error'); }
      finally{ setBusy(false); }
    }

    /* =======================
     * STATUS UX
     * ======================= */
    function presentNow(id){
      const now = Date.now();
      const {status, minutesLate} = classifyArrival(now);
      attendance.set(id, { arrivedAt: now, status, minutesLate, saved: false });
      saveSession();
    }
    function setStatus(id, type){
      if(type==='on'){
        presentNow(id);
      } else if(type==='late'){
        const now = Date.now();
        const base = classifyArrival(now);
        const minutesLate = Math.max(1, base.minutesLate || 1);
        attendance.set(id, { arrivedAt: now, status:'Late', minutesLate, saved:false });
        saveSession();
      } else if(type==='excused'){
        attendance.set(id, { arrivedAt: null, status:'Excused', minutesLate:'', saved:false });
        saveSession();
      } else if(type==='excused_late'){
        const now = Date.now();
        const base = classifyArrival(now);
        const minutesLate = Math.max(1, base.minutesLate || 1);
        attendance.set(id, { arrivedAt: null, status:'Excused Late', minutesLate, saved:false });
        saveSession();
      } else if(type==='clear'){
        attendance.delete(id); saveSession();
      }
      renderGrid(); hideMenu();
    }
    function showMenu(id, x, y){
      menuTargetId = id;
      menu.style.left = Math.max(8, x-8)+'px';
      menu.style.top = Math.max(8, y-8)+'px';
      menu.classList.remove('hidden');
      menu.setAttribute('aria-hidden','false');
    }
    function hideMenu(){
      menu.classList.add('hidden');
      menu.setAttribute('aria-hidden','true');
      menuTargetId = null;
    }
    function clickPlayer(ev){
      const btn = ev.target.closest('.plyr'); if(!btn) return;
      const id = btn.dataset.id;
      const rec = attendance.get(id);

      if (rec && (rec.status==='Excused' || rec.status==='Excused Late')){
        presentNow(id); renderGrid(); maybeAutosave(id, 'on'); return;
      }
      if (rec){
        attendance.delete(id); saveSession(); renderGrid(); return; // no autosave on clear
      }
      presentNow(id); renderGrid(); maybeAutosave(id, 'on');
    }
    let longTimer=null;
    function gridPointerDown(e){
      const btn = e.target.closest('.plyr'); if(!btn) return;
      const id = btn.dataset.id;
      const pt = ('touches' in e && e.touches.length) ? e.touches[0] : e;
      longTimer = setTimeout(()=>showMenu(id, pt.clientX, pt.clientY), 450);
    }
    function gridPointerUp(){ if(longTimer){ clearTimeout(longTimer); longTimer=null; } }
    function gridContextMenu(e){
      const btn = e.target.closest('.plyr'); if(!btn) return;
      e.preventDefault(); showMenu(btn.dataset.id, e.clientX, e.clientY);
    }
    menu.addEventListener('pointerup', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      e.preventDefault(); e.stopPropagation();
      const act = btn.dataset.action;
      if(!menuTargetId) return;
      setStatus(menuTargetId, act);
      maybeAutosave(menuTargetId, act);
    });
    document.addEventListener('click', (e)=>{ if(!e.target.closest('#statusMenu')) hideMenu(); });

    /* =======================
     * CLEAR / SESSION / INIT
     * ======================= */
    function restoreFromSession(){
      const ss = loadSession(); if(!ss || ss.finalized) return;
      if(ss.date) el('prac_date').value = ss.date;
      if(ss.time) el('prac_time').value = ss.time;
      if(typeof ss.grace === 'number') el('prac_grace').value = ss.grace;
      if(typeof ss.autosave === 'boolean') el('autosave').checked = ss.autosave;
      attendance.clear();
      if(ss.attendance && typeof ss.attendance === 'object'){
        Object.keys(ss.attendance).forEach(pid=>{
          const rec = ss.attendance[pid];
          if(rec && typeof rec==='object' && ('status' in rec)){ attendance.set(pid, rec); }
        });
      }
      updateGraceBadge();
    }
    function clearSelected(){
      if(!attendance.size){ log('Nothing to clear.'); return; }
      attendance.clear(); saveSession(); renderGrid(); log('Cleared selected attendance state.');
    }

    (function seedStart(){
      const now = new Date();
      if(!loadSession()){
        el('prac_date').value = now.toISOString().slice(0,10);
        el('prac_time').value = '16:00';
      }
    })();

    // Persist setup inputs on change
    el('prac_date').addEventListener('change', ()=>{ saveSession(); });
    el('prac_time').addEventListener('change', ()=>{ saveSession(); });
    el('prac_grace').addEventListener('change', ()=>{ saveSession(); updateGraceBadge(); });

    el('setNowBtn').addEventListener('click', setNowAsStart);
    el('reloadRosterBtn').addEventListener('click', loadRoster);
    el('saveAllBtn').addEventListener('click', ()=>saveAllUnsaved().catch(e=>log(String(e),'error')));
    el('finalizeBtn').addEventListener('click', ()=>finalizeAbsent().catch(e=>log(String(e),'error')));
    el('clearSelectedBtn').addEventListener('click', clearSelected);
    el('search').addEventListener('input', renderGrid);

    ['grid'].forEach(id=>{
      const root = el(id);
      if(!root) return;
      root.addEventListener('click', clickPlayer);
      root.addEventListener('mousedown', gridPointerDown);
      root.addEventListener('touchstart', gridPointerDown, {passive:true});
      root.addEventListener('contextmenu', gridContextMenu);
    });
    document.addEventListener('mouseup', gridPointerUp);
    document.addEventListener('touchend', gridPointerUp);
    document.addEventListener('pointercancel', gridPointerUp);

    // Load
    loadRoster();
  </script>
</body>
</html>
