<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Practice Attendance – Football Data Tracker</title>
  <link rel="stylesheet" href="../style.css"/>
  <style>
    :root{
      --panel-bg: rgba(255,255,255,.04);
      --bd: rgba(255,255,255,.12);
      --subtle: rgba(255,255,255,.18);
      --chip-bg: rgba(255,255,255,.08);
      --chip-bd: rgba(255,255,255,.18);
      --accent: #43b581;
      --late: #ffa142;
      --present: #3ddc97;
      --excused: #6aa9ff;
      --text-on-dark: #eaeaea;
    }
    .container{max-width:1200px;margin:0 auto;padding:1rem}
    .grid{display:grid;gap:1rem}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .card{background:var(--panel-bg);border:1px solid var(--bd);border-radius:14px;padding:1rem}
    .card h2{margin:0 0 .5rem 0;font-size:1.1rem}
    .card h3{ margin:0; font-size:1rem; font-weight:600; }
    .row{display:flex;gap:.75rem;flex-wrap:wrap}
    .row > *{flex:1 1 160px}
    label{display:block;font-size:.85rem;opacity:.9;margin-bottom:.25rem}
    input,select,textarea{width:100%;padding:.6rem .7rem;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.2);color:#fff}
    .btnbar{display:flex;gap:.5rem;flex-wrap:wrap}
    .btn{padding:.6rem .9rem;border-radius:999px;border:1px solid transparent;cursor:pointer}
    .btn.primary{background:var(--accent);color:#071a12}
    .btn.subtle{background:transparent;border-color:rgba(255,255,255,.25);color:#fff}
    .btn.warn{background:#ffa142;color:#2a1800}
    .chip{display:inline-block;padding:.25rem .6rem;border-radius:999px;background:var(--chip-bg);border:1px solid var(--chip-bd);font-size:.8rem}
    .tiny{font-size:.8rem;opacity:.85}
    .success{color:#7CFC98}.error{color:#ff6b6b}
    .section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:.35rem}

    /* roster buttons */
    .toolbar{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;margin-bottom:.6rem}
    .search{flex:1 1 240px}
    .player-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:.6rem}
    .plyr{
      position:relative; border:1px solid var(--subtle); border-radius:12px; padding:.7rem .8rem;
      background:rgba(255,255,255,.04); cursor:pointer; display:flex; gap:.6rem; align-items:center; min-height:56px;
      transition:transform .06s ease, border-color .06s ease, background .06s ease;
      user-select:none;
    }
    .plyr:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.34)}
    .num{width:36px;height:36px;border-radius:9px;background:rgba(255,255,255,.08);display:grid;place-items:center;font-weight:700}
    .plyr .name > div:first-child{ color: var(--text-on-dark); font-weight:600; letter-spacing:.2px; }
    .plyr .pos{ color:#cfd3d8; opacity:.9; }
    .stamp{font-variant-numeric:tabular-nums;font-size:.78rem;opacity:.85}
    .status{position:absolute;right:8px;top:8px;font-size:.7rem;padding:.15rem .45rem;border-radius:999px;border:1px solid var(--chip-bd)}
    .on{background:rgba(61,220,151,.16);color:#c8ffe7;border-color:#3ddc97}
    .late{background:rgba(255,161,66,.13);color:#ffe1c3;border-color:#ffa142}
    .exc{background:rgba(106,169,255,.16);color:#e4eaff;border-color:#6aa9ff}
    .saved::after{
      content:'✓'; position:absolute; left:-6px; top:-6px; width:18px; height:18px; border-radius:50%;
      background:#35c48a;color:#061d14;font-size:.75rem;display:grid;place-items:center; border:1px solid #0b6546;
    }

    /* Card color by status */
    .plyr.state-on  { background: rgba(61,220,151,.12); border-color: rgba(61,220,151,.55); }
    .plyr.state-late{ background: rgba(255,161,66,.12); border-color: rgba(255,161,66,.55); }
    .plyr.state-exc { background: rgba(106,169,255,.12); border-color: rgba(106,169,255,.55); }

    .plyr.state-on  .num{ background: rgba(61,220,151,.20); }
    .plyr.state-late .num{ background: rgba(255,161,66,.20); }
    .plyr.state-exc  .num{ background: rgba(106,169,255,.20); }

    .legend{display:flex;gap:.5rem;align-items:center}
    .legend .dot{width:12px;height:12px;border-radius:50%}
    .dot.on{background:var(--present)} .dot.late{background:var(--late)} .dot.exc{background:var(--excused)}

    .logbox{max-height:240px;overflow:auto}

    /* Popover menu for status */
    .popover{position:fixed; z-index:50; background:#121316; border:1px solid var(--bd); border-radius:12px; padding:.4rem; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .popover button{display:block;width:100%;text-align:left;padding:.5rem .7rem;border-radius:8px;border:1px solid transparent;background:transparent;color:#fff}
    .popover button:hover{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.15)}
    .hidden{display:none}

    /* Modal add player (hidden by default) */

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.5);
      backdrop-filter:saturate(120%) blur(4px);
      display:none;                 /* <-- hidden by default */
      align-items:center;
      justify-content:center;
      z-index:60;
    }

    .modal-backdrop.open{           /* <-- shown when .open is added */
      display:flex;

    }

    .modal{
      background:#15161a;
      border:1px solid var(--bd);
      border-radius:14px;
      padding:1rem;
      max-width:520px;
      width:92%;
    }

    .modal h3{margin:.2rem 0 .6rem 0}
    .row-tight{display:flex;gap:.6rem;flex-wrap:wrap}
    .row-tight > *{flex:1 1 160px}

    .modal-backdrop.hidden{ display:none !important; }

    /* ===== Mobile-friendly roster cards ===== */

    /* Let text truncate instead of spilling */
    .plyr .name { min-width: 0; }
    .plyr .name > div:first-child{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Slightly roomier default grid; scales down with breakpoints */
    .player-grid{
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: .6rem;
    }

    /* Make the two top cards stack on tablets/phones */
    @media (max-width: 900px){
      .grid-2{ grid-template-columns: 1fr; }
    }

    /* Tablet-ish: tighten spacing, hide timestamp to avoid overlap */
    @media (max-width: 700px){
      .container{ padding: .75rem; }
      .player-grid{
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: .5rem;
      }
      .plyr{ padding: .65rem .7rem; min-height: 58px; border-radius: 10px; }
      .num{ width: 32px; height: 32px; border-radius: 8px; font-size: .9rem; }
      .status{ right: 6px; top: 6px; font-size: .68rem; padding: .1rem .4rem; }
      .stamp{ display: none; } /* hide time to keep cards clean */
    }

    /* Small phones: force two columns and scale typography */
    @media (max-width: 420px){
      .player-grid{
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: .45rem;
      }
      .plyr{ padding: .55rem .6rem; gap: .5rem; }
      .num{ width: 30px; height: 30px; border-radius: 8px; }
      .plyr .name > div:first-child{ font-size: .92rem; }
      .plyr .pos{ font-size: .72rem; }
      .chip.tiny{ font-size: .75rem; padding: .15rem .5rem; }
      .btnbar, .toolbar{ gap: .4rem; }
      .modal{ max-width: 96%; }
      .row-tight > *{ flex: 1 1 100%; } /* modal fields stack */
    }

    /* Ensure PV grid inherits the same responsive rules */
    #pvGroup .player-grid{ grid-template-columns: inherit; gap: inherit; }

    /* Timestamp color */
    :root { --stamp-color: #E8F3FF; } /* pick any light color */
    .stamp{
      color: var(--stamp-color);
      opacity: 1;              /* was .85 – make fully opaque */
    }

  </style>
</head>

<body class="practice-page">
  <header class="page-header">
    <h1>Practice Attendance</h1>
    <nav class="menu-actions">
      <a href="../index.html" class="menu-btn">Home</a>
      <a href="practice.html" class="menu-btn secondary">Practice</a>
    </nav>
  </header>

  <main>
    <div class="container grid grid-2">
      <!-- Setup -->
      <section class="card">
        <div class="section-title">
          <h2>Practice Setup</h2>
          <span id="status" class="tiny">Ready</span>
        </div>
        <div class="row">
          <div><label>Date</label><input id="prac_date" type="date"/></div>
          <div><label>Start Time</label><input id="prac_time" type="time" step="60"/></div>
          <div><label>Grace (min)</label><input id="prac_grace" type="number" step="1" value="0"/></div>
        </div>
        <div class="btnbar" style="margin-top:.4rem">
          <button class="btn subtle" id="setNowBtn">Set start = now</button>
          <label class="tiny" style="display:flex;align-items:center;gap:.4rem">
            <input type="checkbox" id="autosave" checked/> Autosave on click
          </label>
          <span class="chip tiny legend">
            <span class="dot on"></span> On time
            <span class="dot late" style="margin-left:.5rem"></span> Late
            <span class="dot exc" style="margin-left:.5rem"></span> Excused
          </span>
        </div>
      </section>

      <!-- Tools -->
      <section class="card">
        <div class="section-title">
          <h2>Controls</h2>
          <span class="tiny">Save & finalize</span>
        </div>
        <div class="btnbar">
          <button class="btn primary" id="saveAllBtn">Save all unsaved</button>
          <button class="btn warn" id="finalizeBtn">Finalize: mark remaining Absent</button>
          <button class="btn subtle" id="reloadRosterBtn">Reload Roster</button>
          <button class="btn subtle" id="addPlayerBtn">Add to Roster</button>
        </div>
        <div class="tiny" style="margin-top:.5rem;opacity:.8">
          Tip: tap = On time/Late (auto). Long-press or right-click a card for <strong>Excused</strong> or to switch status.
        </div>
      </section>
    </div>

    <!-- Roster -->
    <div class="container">
      <section class="card">
        <div class="section-title">
          <h2>Roster</h2>
          <div class="toolbar">
            <input id="search" class="search" placeholder="Search by name/number/position…"/>
            <span class="chip tiny" id="countBadge">0 players</span>
          </div>
        </div>
        <div id="grid" class="player-grid" aria-live="polite"></div>
      </section>
    </div>

    <!-- Log -->
    <div class="container">
      <section class="card">
        <div class="section-title"><h2>Log</h2><span class="tiny">Most recent first</span></div>
        <div id="log" class="tiny logbox"></div>
      </section>
    </div>

    <!-- PV subgroup (hidden when empty) -->
    <div id="pvGroup" class="subgroup" style="margin-top:1rem; display:none">
      <div class="section-title">
        <h3>PV / Special</h3>
        <span class="chip tiny" id="countBadgePV">0 PV</span>
      </div>
      <div id="grid_pv" class="player-grid" aria-live="polite"></div>
    </div>

  </main>

  <!-- Status popover -->
  <div id="statusMenu" class="popover hidden" role="menu" aria-hidden="true">
    <button data-action="on">On time</button>
    <button data-action="late">Late</button>
    <button data-action="excused">Excused</button>
    <hr style="border:none;border-top:1px solid var(--bd);margin:.3rem 0"/>
    <button data-action="clear">Clear</button>
  </div>

  <!-- Add Player modal (hidden until opened) -->
  <div id="modalBackdrop" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="newPlayerTitle" tabindex="-1">
      <h3 id="newPlayerTitle">Add to Roster</h3>
      <div class="row-tight">
        <div><label>Player Name</label><input id="np_name" placeholder="Full name"/></div>
        <div><label>Position</label><input id="np_pos" placeholder="e.g., WR, RB, OL"/></div>
      </div>
      <div class="row-tight" style="margin-top:.6rem">
        <div><label>Jersey #</label><input id="np_num" placeholder="e.g., 12"/></div>
        <div><label>Player ID (optional)</label><input id="np_pid" placeholder="auto if blank"/></div>
      </div>
      <div class="btnbar" style="margin-top:.8rem">
        <button class="btn primary" id="np_save">Save to Roster</button>
        <button class="btn subtle" id="np_cancel">Cancel</button>
      </div>
      <div class="tiny" style="opacity:.8;margin-top:.4rem">
        Writes to your roster sheet (adds headers if needed): <code>player_id, player_name, position, jersey_number</code>.
      </div>
    </div>
  </div>

  <footer><p>&copy; 2025 Game Speed Data Systems</p></footer>

  <script>
    /* =======================
     * CONFIG
     * ======================= */
    const API_BASE = 'https://script.google.com/macros/s/AKfycbxQk6BgJLkZltXX7xijq9QKmTEfB51M65cHzrYCe6SCTykrSWnFDMecXfiLGRTd9iOCLg/exec';

    // Roster source (pulls from this sheet)
    const ROSTER_SHEET_ID = '1_PXbtnooI9gRxKF6h7BnjQdSVbnQV6D2gwX0zURqtlI';
    const ROSTER_TAB = '00_Dim_Roster';

    // Attendance destination
    const ATTEND_SHEET_ID = '1pT-7cXhfzJB5mjswsXayvjt_qC2hIp9WflWggIAyh8g'; // PLAYER_DEVELOPMENT_2025
    const ATTEND_TAB = '60_Fact_PracticeAttendance';

    // Headers to ensure on first write
    const ATTEND_HEADERS = [
      'timestamp','date','practice_start','grace_minutes',
      'player_id','player_name','position','jersey_number',
      'status','arrived_at','minutes_late'
    ];

    // Roster fields for Add Player
    const ROSTER_HEADERS = ['player_id','player_name','position','jersey_number'];

    /* =======================
     * STATE + LOG
     * ======================= */
    const el = id => document.getElementById(id);
    const logBox = el('log');
    const log = (msg, type='')=>{
      const row = document.createElement('div');
      if(type==='success') row.className='success';
      if(type==='error') row.className='error';
      row.textContent = '['+new Date().toLocaleTimeString()+'] '+msg;
      logBox.prepend(row);
      el('status').textContent = (type==='error'?'Error':'Ready');
    };

    let roster = [];            // [{id,name,pos,num}]
    const playersById = new Map();
    const attendance = new Map(); // id -> {arrivedAt, status:'On time'|'Late'|'Excused', minutesLate, saved}

    // popover state
    const menu = el('statusMenu');
    let menuTargetId = null;

    /* =======================
     * API helpers
     * ======================= */
    async function apiGet(params){
      const url = new URL(API_BASE);
      Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
      const r = await fetch(url);
      return r.json();
    }
    async function apiPost(payload){
      const r = await fetch(API_BASE, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // no preflight
        body: JSON.stringify(payload)
      });
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }

    async function appendRowTable(sheet_id, sheet_name, row, ensure=[]){
      const res = await apiPost({ action:'append', sheet_id, sheet_name, row, ensure_headers: ensure });
      if(!res.ok) throw new Error(res.error||'Append failed');
      return res;
    }
    async function appendRowWithId(sheet_id, sheet_name, row, idPrefix, idField, ensure=[]){
      const res = await apiPost({ action:'append', sheet_id, sheet_name, row, id_prefix:idPrefix, id_field:idField, ensure_headers: ensure });
      if(!res.ok) throw new Error(res.error||'Append failed');
      return res;
    }
    async function batchAppend(ops){
      const res = await apiPost({ action:'batch', ops });
      if(!res.ok) throw new Error(res.error||'Batch failed');
      return res;
    }

    /* =======================
     * ROSTER
     * ======================= */
    function normalizeRoster(rows){
      return rows.map(r=>{
        return {
          id: (r.player_id||r.id||'').toString().trim(),
          name: (r.player_name||r.name||'').toString().trim(),
          pos: (r.position||r.pos||'').toString().trim().toUpperCase(),
          num: (r.jersey_number||r.jersey||'').toString().trim()
        }
      }).filter(p=>p.id && p.name);
    }
    async function loadRoster(){
      try{
        const res = await apiGet({ action:'roster', sheet_id: ROSTER_SHEET_ID, sheet_name: ROSTER_TAB });
        if(!res.ok) throw new Error(res.error||'Roster fetch failed');
        roster = normalizeRoster(res.roster||[]);
        playersById.clear();
        roster.forEach(p=>playersById.set(p.id,p));
        renderGrid();
        log(`Roster loaded (${roster.length} players).`, 'success');
      }catch(err){ log(err.message,'error'); }
    }

    /* =======================
     * TIME HELPERS
     * ======================= */
    function practiceStartMs(){
      const d = el('prac_date').value;
      const t = el('prac_time').value;
      if(!d || !t) return null;
      const [yy,mm,dd] = d.split('-').map(Number);
      const [h,mi] = t.split(':').map(Number);
      return new Date(yy, mm-1, dd, h, mi, 0, 0).getTime();
    }
    function classifyArrival(arriveMs){
      const start = practiceStartMs();
      if(!start) return { status:'On time', minutesLate:0 };
      const grace = Number(el('prac_grace').value||0);
      const lateBy = Math.max(0, Math.round((arriveMs - start)/60000) - grace);
      return { status: lateBy > 0 ? 'Late' : 'On time', minutesLate: Math.max(0,lateBy) };
    }
    function setNowAsStart(){
      const now = new Date();
      el('prac_date').value = now.toISOString().slice(0,10);
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      el('prac_time').value = `${hh}:${mm}`;
    }

    /* =======================
     * UI: GRID
     * ======================= */
    function statusChip(rec){
      if(!rec) return '';
      const base = rec.status==='Excused'?'exc':(rec.status==='Late'?'late':'on');
      const extra = rec.minutesLate?` (+${rec.minutesLate})`:'';
      return `<span class="status ${base}">${rec.status}${extra}</span>`;
    }
    function playerCard(p){
      const rec = attendance.get(p.id);
      const clsSaved = rec?.saved ? 'saved' : '';
      const stateCls = rec
        ? (rec.status==='Excused' ? 'state-exc' : (rec.status==='Late' ? 'state-late' : 'state-on'))
        : '';
      const stamp = rec?.arrivedAt ? new Date(rec.arrivedAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
      return `
        <button class="plyr ${clsSaved} ${stateCls}" data-id="${p.id}" aria-pressed="${rec?'true':'false'}">
          <div class="num">#${p.num||'—'}</div>
          <div class="name">
            <div>${p.name}</div>
            <div class="pos tiny">${p.pos||''}</div>
          </div>
          <div class="stamp">${stamp}</div>
          ${statusChip(rec)}
        </button>
      `;
    }

    function renderGrid(){
      const q = el('search').value.trim().toUpperCase();
      const match = p => !q ||
        p.name.toUpperCase().includes(q) ||
        (p.num||'').toString().includes(q) ||
        (p.pos||'').toUpperCase().includes(q);

      const numKey = p => {
        const n = parseInt((p.num||'').toString(), 10);
        return Number.isFinite(n) ? n : Number.POSITIVE_INFINITY;
      };
      const sortByNum = (a,b) => (numKey(a) - numKey(b)) || a.name.localeCompare(b.name);

      const isPV = p => (p.pos||'').toUpperCase() === 'PV';

      // Split + filter + sort
      const main = roster.filter(p => !isPV(p) && match(p)).sort(sortByNum);
      const pv   = roster.filter(p =>  isPV(p) && match(p)).sort(sortByNum);

      // Render
      el('grid').innerHTML = main.map(playerCard).join('');
      el('countBadge').textContent = `${main.length} players`;

      el('grid_pv').innerHTML = pv.map(playerCard).join('');
      el('countBadgePV').textContent = `${pv.length} PV`;
      el('pvGroup').style.display = pv.length ? '' : 'none';
    }


    /* =======================
     * SAVE HELPERS
     * ======================= */
    function buildRow(p, rec){
      const startISO = (()=>{ const ms=practiceStartMs(); return ms? new Date(ms).toISOString() : '';})();
      return {
        timestamp: new Date(),
        date: el('prac_date').value || '',
        practice_start: startISO,
        grace_minutes: Number(el('prac_grace').value||0),

        player_id: p.id,
        player_name: p.name,
        position: p.pos||'',
        jersey_number: p.num||'',

        status: rec.status,
        arrived_at: rec.arrivedAt ? new Date(rec.arrivedAt).toISOString() : '',
        minutes_late: rec.status==='Late' ? rec.minutesLate : ''
      };
    }

    async function saveOne(pId){
      const rec = attendance.get(pId); if(!rec || rec.saved) return;
      const p = playersById.get(pId);
      const row = buildRow(p, rec);
      await appendRowTable(ATTEND_SHEET_ID, ATTEND_TAB, row, ATTEND_HEADERS);
      rec.saved = true; attendance.set(pId, rec);
      renderGrid();
    }

    async function saveAllUnsaved(){
      const ops = [];
      attendance.forEach((rec, pId)=>{
        if(rec.saved) return;
        const p = playersById.get(pId);
        ops.push({ sheet_id: ATTEND_SHEET_ID, sheet_name: ATTEND_TAB, row: buildRow(p, rec), ensure_headers: ATTEND_HEADERS });
      });
      if(!ops.length){ log('Nothing to save (all up to date).'); return; }
      await batchAppend(ops);
      attendance.forEach((rec)=>{ if(!rec.saved) rec.saved=true; });
      renderGrid();
      log(`Saved ${ops.length} attendance rows.`, 'success');
    }

    async function finalizeAbsent(){
      // anyone not in attendance map becomes Absent (Excused stays as-is)
      const absentees = roster.filter(p=>!attendance.has(p.id));
      if(!absentees.length){ log('No absentees to mark.'); return; }
      const ops = absentees.map(p=>({
        sheet_id: ATTEND_SHEET_ID, sheet_name: ATTEND_TAB,
        row: {
          timestamp: new Date(),
          date: el('prac_date').value || '',
          practice_start: (()=>{ const ms=practiceStartMs(); return ms? new Date(ms).toISOString() : '';})(),
          grace_minutes: Number(el('prac_grace').value||0),

          player_id: p.id, player_name: p.name, position: p.pos||'', jersey_number: p.num||'',
          status: 'Absent', arrived_at: '', minutes_late: ''
        },
        ensure_headers: ATTEND_HEADERS
      }));
      await batchAppend(ops);
      log(`Finalized: marked ${ops.length} absent.`, 'success');
    }

    /* =======================
     * STATUS UX
     * ======================= */
    function presentNow(id){
      const now = Date.now();
      const {status, minutesLate} = classifyArrival(now);
      attendance.set(id, { arrivedAt: now, status, minutesLate, saved: false });
    }
    function setStatus(id, type){
      if(type==='on'){ presentNow(id); }
      else if(type==='late'){
        const now = Date.now();
        const base = classifyArrival(now);
        const minutesLate = Math.max(1, base.minutesLate || 1);
        attendance.set(id, { arrivedAt: now, status:'Late', minutesLate, saved:false });
      } else if(type==='excused'){
        attendance.set(id, { arrivedAt: null, status:'Excused', minutesLate:'', saved:false });
      } else if(type==='clear'){
        attendance.delete(id);
      }
      renderGrid();
      hideMenu();
    }

    function showMenu(id, x, y){
      menuTargetId = id;
      menu.style.left = Math.max(8, x-8)+'px';
      menu.style.top = Math.max(8, y-8)+'px';
      menu.classList.remove('hidden');
      menu.setAttribute('aria-hidden','false');
    }
    function hideMenu(){
      menu.classList.add('hidden');
      menu.setAttribute('aria-hidden','true');
      menuTargetId = null;
    }

    // click = present toggle; if already present -> clear; if excused -> mark present
    function clickPlayer(ev){
      const btn = ev.target.closest('.plyr'); if(!btn) return;
      const id = btn.dataset.id; const rec = attendance.get(id);

      if(rec && rec.status==='Excused'){
        presentNow(id);
      } else if(rec){
        attendance.delete(id);
      } else {
        presentNow(id);
      }
      renderGrid();

      if(el('autosave').checked){
        saveOne(id).catch(err=>log(String(err),'error'));
      }
    }

    // long press / right-click to open status picker
    let longTimer=null;
    function gridPointerDown(e){
      const btn = e.target.closest('.plyr'); if(!btn) return;
      const id = btn.dataset.id;
      const pt = ('touches' in e && e.touches.length) ? e.touches[0] : e;
      longTimer = setTimeout(()=>showMenu(id, pt.clientX, pt.clientY), 450);
    }
    function gridPointerUp(){ if(longTimer){ clearTimeout(longTimer); longTimer=null; } }
    function gridContextMenu(e){
      const btn = e.target.closest('.plyr'); if(!btn) return;
      e.preventDefault();
      showMenu(btn.dataset.id, e.clientX, e.clientY);
    }

    menu.addEventListener('click', (e)=>{
      const act = e.target.closest('button')?.dataset.action; if(!act) return;
      if(!menuTargetId) return;
      setStatus(menuTargetId, act);
      if(el('autosave').checked && act!=='clear'){
        saveOne(menuTargetId).catch(err=>log(String(err),'error'));
      }
    });
    document.addEventListener('click', (e)=>{ if(!e.target.closest('#statusMenu')) hideMenu(); });

    /* =======================
     * ADD PLAYER (roster)
     * ======================= */
    const backdrop = el('modalBackdrop');

    function openAddPlayer(){
      backdrop.classList.add('open');
      backdrop.classList.remove('hidden');
      backdrop.setAttribute('aria-hidden','false');
      setTimeout(()=>document.getElementById('np_name')?.focus(), 0);
    }

    function closeAddPlayer(){
      backdrop.classList.remove('open');
      backdrop.classList.add('hidden');
      backdrop.setAttribute('aria-hidden','true');
      ['np_name','np_pos','np_num','np_pid'].forEach(i=>el(i).value='');
    }


    async function saveNewPlayer(){
      const name = el('np_name').value.trim();
      const pos  = el('np_pos').value.trim().toUpperCase();
      const num  = el('np_num').value.trim();
      const pid  = el('np_pid').value.trim(); // optional

      if(!name){ log('Player name required','error'); return; }

      const row = {
        player_id: pid || '', // server generates if id_prefix provided
        player_name: name,
        position: pos,
        jersey_number: num
      };
      await appendRowWithId(ROSTER_SHEET_ID, ROSTER_TAB, row, 'PLYR', 'player_id', ROSTER_HEADERS);
      log(`Added ${name} to roster.`, 'success');
      closeAddPlayer();
      await loadRoster(); // refresh grid
    }

    // Close modal on backdrop click or Esc
    backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) closeAddPlayer(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && !backdrop.classList.contains('hidden')) closeAddPlayer(); });

    /* =======================
     * INIT
     * ======================= */
    // default practice start = today 16:00 local
    (function seedStart(){
      const now = new Date();
      el('prac_date').value = now.toISOString().slice(0,10);
      el('prac_time').value = '16:00';
    })();

    el('setNowBtn').addEventListener('click', setNowAsStart);
    el('reloadRosterBtn').addEventListener('click', loadRoster);
    el('saveAllBtn').addEventListener('click', ()=>saveAllUnsaved().catch(e=>log(String(e),'error')));
    el('finalizeBtn').addEventListener('click', ()=>finalizeAbsent().catch(e=>log(String(e),'error')));
    el('search').addEventListener('input', renderGrid);

    ['grid','grid_pv'].forEach(id=>{
      const root = el(id);
      if(!root) return;                   // safe if PV section isn't on this page
      root.addEventListener('click', clickPlayer);
      root.addEventListener('mousedown', gridPointerDown);
      root.addEventListener('touchstart', gridPointerDown, {passive:true});
      root.addEventListener('contextmenu', gridContextMenu);
    });

    // keep these document-level listeners as-is (they work for both grids)
    document.addEventListener('mouseup', gridPointerUp);
    document.addEventListener('touchend', gridPointerUp);
    document.addEventListener('pointercancel', gridPointerUp);

    el('addPlayerBtn').addEventListener('click', openAddPlayer);
    el('np_cancel').addEventListener('click', closeAddPlayer);
    el('np_save').addEventListener('click', ()=>saveNewPlayer().catch(e=>log(String(e),'error')));

    // go
    loadRoster();
  </script>
</body>
</html>
