<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="gsds-api-base" content="https://script.google.com/macros/s/AKfycbxCHO9P5zOf_LjEztGUPalzGRweBAr_Y3U9v4iVn9jHir1pB0yueLp22_ltGSTFc6qzfA/exec">
  <title>Team 7v7 — Tryouts</title>

  <script>
    (function(){
      const ok = localStorage.getItem('auth_ok')==='1' &&
                 Number(localStorage.getItem('auth_until')||0) > Date.now();
      if(!ok){ window.location.href = '../index.html#login'; }
    })();
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../style.css"/>

  <style>
    .container{ max-width:1200px; margin:0 auto; padding:16px; }
    .stack{ display:flex; flex-direction:column; gap:12px; }
    .card{ background: rgba(255,255,255,.05); border:1px solid var(--border);
           border-radius:16px; padding:16px; box-shadow: var(--shadow-soft, 0 8px 24px rgba(0,0,0,.18)); }
    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
           border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06); font-weight:700; }
    .chip.badge{ background:linear-gradient(135deg,#7C4DFF,#8B5CF6); color:#071018; border:0; }
    .chip.ghost{ background:transparent; }
    .chip.tiny{ font-size:.8rem; padding:4px 8px; }

    .label{ font-weight:800; font-size:.95rem; opacity:.9; margin-bottom:6px; display:block; }
    .form-input, .form-select{ width:100%; padding:.65rem .8rem; border-radius:10px; border:1px solid rgba(255,255,255,.28);
      background:rgba(255,255,255,.08); color:#fff; }

    .seg{ display:inline-flex; border:1px solid rgba(255,255,255,.18); border-radius:10px; overflow:hidden; }
    .seg button{ appearance:none; border:0; padding:8px 14px; font-weight:800; color:#fff; background:rgba(255,255,255,.06); cursor:pointer; border-right:1px solid rgba(255,255,255,.18); }
    .seg button:last-child{ border-right:0; }
    .seg button.active{ background:linear-gradient(135deg,#7C4DFF,#8B5CF6); color:#071018; }

    .row{ display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
    @media (max-width:768px){ .row{ grid-template-columns: 1fr; } }

    .btn{ appearance:none; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.08); color:#fff;
          padding:.55rem .8rem; border-radius:10px; font-weight:800; cursor:pointer; transition:.2s ease; }
    .btn.success{ background:linear-gradient(135deg,#16A34A,#10B981); color:#061710; border:0; }
    .btn.ghost{ background:transparent; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    
    /* Loading spinner */
    .btn.loading{ position:relative; pointer-events:none; }
    .btn.loading .spin{ width:14px; height:14px; border:2px solid rgba(255,255,255,.45);
                        border-top-color:#fff; border-radius:50%; display:inline-block;
                        margin-right:8px; vertical-align:-2px; animation:spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .lineup{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .player-tag{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:8px; background:rgba(139,92,246,.15); border:1px solid rgba(139,92,246,.3); }
    .player-tag .remove{ cursor:pointer; opacity:.6; }

    .status{ margin-top:8px; font-weight:700; }
    .status.ok{ color:#34D399; } .status.err{ color:#F87171; } .status.warn{ color:#F59E0B; }

    .play-log{ margin-top:12px; }
    .play-row{ padding:8px; border-radius:8px; background:rgba(255,255,255,.06); margin-bottom:6px; font-size:.9rem; }

    .muted{ opacity:.7; }
    .small{ font-size:.85rem; }

    /* Roster cards grid */
    .roster-cards{ display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; margin-top:12px; }
    @media (max-width:900px){ .roster-cards{ grid-template-columns: repeat(4, 1fr); } }
    @media (max-width:768px){ .roster-cards{ grid-template-columns: repeat(3, 1fr); } }
    @media (max-width:480px){ .roster-cards{ grid-template-columns: repeat(2, 1fr); } }

    .roster-card{ padding:10px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); border-radius:8px; cursor:pointer; transition:all .2s; text-align:center; }
    .roster-card:hover{ background:rgba(139,92,246,.2); border-color:rgba(139,92,246,.4); }
    .roster-card .num{ font-weight:900; font-size:1.1rem; }
    .roster-card .name{ font-size:.8rem; opacity:.8; margin-top:2px; }
    .roster-card .pos{ font-size:.7rem; opacity:.6; }

    .roster-filters{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .filter-btn{ padding:6px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.06); color:#fff; font-weight:800; cursor:pointer; transition:all .2s; }
    .filter-btn.active{ background:linear-gradient(135deg,#7C4DFF,#8B5CF6); border-color:#8B5CF6; color:#071018; }

    .pager{ display:flex; gap:8px; justify-content:center; align-items:center; margin-top:12px; }
    .pager button{ padding:6px 10px; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.06); color:#fff; border-radius:8px; cursor:pointer; }
    .pager button:disabled{ opacity:.4; cursor:not-allowed; }
    .pager .info{ font-size:.9rem; opacity:.8; }

    /* Loading overlay for roster */
    .loading-overlay{ position:absolute; inset:0; background:rgba(0,0,0,.3); display:flex; align-items:center; justify-content:center; border-radius:8px; }
    .loading-overlay .spinner{ width:32px; height:32px; border:3px solid rgba(255,255,255,.3); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite; }
  </style>
</head>

<body class="theme-atl practice-page">
  <header class="page-header">
    <h1>Team 7v7</h1>
    <nav class="menu-actions">
      <a class="menu-btn" href="../index.html">Home</a>
      <a class="menu-btn" href="../tryout/index.html">Tryout Hub</a>
    </nav>
  </header>

  <main>
    <div class="container stack">
      <div id="ctxBanner" class="chip tiny" aria-live="polite">Loading context…</div>

      <!-- Drill Selection -->
      <section class="card">
        <div class="toolbar">
          <span class="chip">Station: <strong>TEAM 7v7</strong></span>
          <div style="min-width:240px">
            <label class="label">Drill</label>
            <select id="drillSelect" class="form-select"></select>
            <div id="drillHint" class="small muted" style="margin-top:6px"></div>
          </div>
          <span id="drillBadge" class="chip badge">Drill: —</span>
        </div>
      </section>

      <!-- Side Selection -->
      <section class="card">
        <div class="toolbar">
          <div>
            <label class="label">Select Side to Add Players</label>
            <div class="seg" role="group">
              <button id="sideOff" class="active">Offense</button>
              <button id="sideDef">Defense</button>
            </div>
          </div>
          <span id="selectedHint" class="small muted" style="margin-left:auto">Click player cards to add to Offense</span>
        </div>
      </section>

      <!-- Roster Cards with Pagination -->
      <section class="card" style="position:relative">
        <div id="rosterLoadingOverlay" class="loading-overlay" style="display:none">
          <div class="spinner"></div>
        </div>
        <div class="toolbar">
          <span class="chip tiny">Available Players</span>
          <span id="pageInfo" class="small muted" style="margin-left:auto"></span>
        </div>
        
        <div class="roster-filters" id="filterButtons"></div>
        <div class="roster-cards" id="rosterCards"></div>
        <div class="pager">
          <button id="prevPage" class="btn ghost">← Prev</button>
          <span class="info" id="pageCounter"></span>
          <button id="nextPage" class="btn ghost">Next →</button>
        </div>
      </section>

      <!-- Lineups Display -->
      <section class="card">
        <div class="row" style="margin-bottom:12px">
          <div>
            <span class="chip badge">Offense</span>
            <div id="offenseLineup" class="lineup"></div>
          </div>
          <div>
            <span class="chip badge" style="background:linear-gradient(135deg,#EF4444,#DC2626);">Defense</span>
            <div id="defenseLineup" class="lineup"></div>
          </div>
        </div>
      </section>

      <!-- Play Recording -->
      <section class="card">
        <div class="toolbar" style="margin-bottom:12px">
          <span class="chip">Record Play</span>
        </div>

        <div class="row">
          <div>
            <label class="label">Play Type</label>
            <div class="seg" role="group">
              <button id="typePass" class="active">Pass</button>
              <button id="typeRun">Run</button>
            </div>
          </div>
          <div>
            <label class="label">QB</label>
            <select id="qbSelect" class="form-select">
              <option value="">Select QB</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px" id="passInputs">
          <div>
            <label class="label">Target (Pass only)</label>
            <select id="targetSelect" class="form-select">
              <option value="">Select Target</option>
            </select>
          </div>
          <div>
            <label class="label">Pass Result</label>
            <div class="seg" role="group">
              <button id="outcomeSuccess" class="active">Catch</button>
              <button id="outcomeFail">Incomplete</button>
            </div>
          </div>
        </div>

        <div id="passDefenseInputs" style="margin-top:12px">
          <div class="row">
            <div>
              <label class="label">Defender (optional)</label>
              <select id="defenderSelect" class="form-select">
                <option value="">Select Defender</option>
              </select>
            </div>
            <div>
              <label class="label">Defensive Action</label>
              <div class="seg" role="group">
                <button id="defNone" data-action="none" class="active">None</button>
                <button id="defPBU" data-action="pbu">PBU</button>
                <button id="defINT" data-action="int">INT</button>
              </div>
            </div>
          </div>
        </div>

        <div id="runInputs" style="display:none">
          <div class="row" style="margin-top:12px">
            <div>
              <label class="label">Ball Carrier (Run only)</label>
              <select id="ballCarrier" class="form-select">
                <option value="">Select Ball Carrier</option>
              </select>
            </div>
            <div>
              <label class="label">Gain/Loss Yards</label>
              <input id="gainYards" class="form-input" type="number" placeholder="0" step="0.5"/>
            </div>
          </div>

          <div class="row" style="margin-top:12px" id="runDefenseInputs">
            <div>
              <label class="label">Tackler (optional)</label>
              <select id="tacklerSelect" class="form-select">
                <option value="">Select Tackler</option>
              </select>
            </div>
            <div>
              <label class="label">Tackle Type</label>
              <div class="seg" role="group">
                <button id="tklNone" data-tackle="none" class="active">None</button>
                <button id="tklTFL" data-tackle="tfl">TFL</button>
                <button id="tklMissed" data-tackle="missed">Missed</button>
              </div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label class="label">Notes (optional)</label>
            <input id="playNotes" class="form-input" placeholder="coverage, pursuit, etc."/>
          </div>
          <div>
            <label class="label">Attempt</label>
            <input id="playAttempt" class="form-input" type="number" value="1" min="1" max="10"/>
          </div>
        </div>

        <button id="savePlay" class="btn success" style="margin-top:12px" disabled>Save Play</button>
        <div id="playStatus" class="status"></div>
      </section>

      <!-- Play Log -->
      <section class="card">
        <span class="chip tiny">Recent Plays</span>
        <div id="playLog" class="play-log"></div>
      </section>
    </div>
  </main>

  <footer class="site-footer"><p>&copy; 2025 Game Speed Data Systems</p></footer>

  <script src="../js/api.js"></script>
  <script src="../js/rules.js"></script>
  <script src="../js/context.js"></script>
  <script src="../js/tryout-ui.js"></script>

  <script>
    (function(){
      const meta = document.querySelector('meta[name="gsds-api-base"]');
      window.API_BASE = (meta && meta.content || '').trim();
    })();
    GameContext.configure({ apiBase: window.API_BASE, server: true, pollMs: 1000 });
    GameContext.mountBanner('#ctxBanner');

    const CARDS_PER_PAGE = 10;
    let roster = [];
    let filteredRoster = [];
    let currentPage = 0;
    let selectedPlayer = null;
    let selectedSide = 'OFF';
    let playType = 'PASS';
    let passOutcome = 'CATCH';
    let defenseAction = 'none'; // pbu, int, or none
    let tackleType = 'none'; // tfl, missed, or none
    let drills = [];
    let currentDrill = null;
    const offense = [];
    const defense = [];
    const plays = [];
    let selectedGroup = null;

    const qs = (s,p=document) => p.querySelector(s);
    const qsa = (s,p=document) => [...p.querySelectorAll(s)];
    const ctx = () => GameContext.get ? GameContext.get() : {};

    function fmtPlayer(r) {
      return `${r.tryout_num||''} • ${r.display_name||r.player_id}`;
    }

    function setLoading(isLoading, type = 'roster') {
      if (type === 'roster') {
        qs('#rosterLoadingOverlay').style.display = isLoading ? 'flex' : 'none';
      }
    }

    function setSaving(isSaving) {
      const btn = qs('#savePlay');
      if (!btn.dataset.label) btn.dataset.label = btn.textContent;
      
      if (isSaving) {
        btn.classList.add('loading');
        btn.disabled = true;
        btn.innerHTML = '<span class="spin"></span>Saving…';
      } else {
        btn.classList.remove('loading');
        btn.textContent = btn.dataset.label || 'Save Play';
        refreshSaveEnabled();
      }
    }

    async function loadRoster(){
      setLoading(true, 'roster');
      try {
        const res = await API.tryout.read.roster();
        if(res?.ok) {
          roster = (res.roster||[]).map(r=>({
            player_id: r.player_id || '',
            display_name: r.display_name || r.player_name || '',
            primary_pos: r.primary_pos || r.position || '',
            tryout_num: String(r.tryout_num||r.jersey_number||'').padStart(3,'0'),
            group_code: r.group_code || r.primary_pos || '',
            tryout_id: r.tryout_id || ''
          })).sort((a,b)=> (parseInt(a.tryout_num,10)||0) - (parseInt(b.tryout_num,10)||0));
          filterByGroup(null);
        }
      }catch(e){ 
        console.error(e); 
        qs('#pageInfo').textContent = 'Error loading roster';
      } finally {
        setLoading(false, 'roster');
      }
    }

    async function loadDrills(){
      try {
        const res = await API.tryout.read.drills();
        if(res?.ok){
          const all = res.drills || res.rows || [];
          drills = all.filter(d => {
            const st = String(d.station_id||'').toUpperCase();
            return st === 'TEAM';
          });
        }
      }catch(e){ console.error(e); }

      if (!drills.length) {
        drills = [
          { drill_id:'TM01', drill_name:'7v7', station_id:'TEAM', success_threshold:'>=65', failure_threshold:'<=40' },
          { drill_id:'TM02', drill_name:'Inside Run', station_id:'TEAM', success_threshold:'>=55', failure_threshold:'<=35' }
        ];
      }

      const sel = qs('#drillSelect');
      sel.innerHTML = drills.map(d => `<option value="${d.drill_id}">${d.drill_name || d.name || d.drill_id}</option>`).join('');
      if (drills[0]) sel.value = drills[0].drill_id;
      updateDrillUI();
    }

    function updateDrillUI(){
      const id = qs('#drillSelect').value;
      currentDrill = drills.find(d => d.drill_id === id);
      if(!currentDrill) return;

      qs('#drillBadge').textContent = `Drill: ${currentDrill.drill_name || currentDrill.drill_id}`;
      const parts = [];
      if(currentDrill.success_threshold) parts.push(`Above Avg: ${currentDrill.success_threshold}`);
      if(currentDrill.failure_threshold) parts.push(`Below Avg: ${currentDrill.failure_threshold}`);
      qs('#drillHint').textContent = parts.join(' • ');
    }

    function getUniqueGroups(){
      const groups = new Set();
      roster.forEach(r => {
        if(r.group_code) groups.add(r.group_code);
      });
      return Array.from(groups).sort();
    }

    function renderFilterButtons(){
      const groups = getUniqueGroups();
      const btnContainer = qs('#filterButtons');
      btnContainer.innerHTML = '<button class="filter-btn active" data-group="CLEAR">Clear</button>' +
        groups.map(g => `<button class="filter-btn" data-group="${g}">${g}</button>`).join('');

      qsa('#filterButtons .filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const group = btn.dataset.group === 'CLEAR' ? null : btn.dataset.group;
          filterByGroup(group);
          qsa('#filterButtons .filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
      });
    }

    function filterByGroup(group){
      selectedGroup = group;
      filteredRoster = group ? roster.filter(r => r.group_code === group) : roster;
      currentPage = 0;
      renderRosterCards();
      updatePager();
    }

    function renderRosterCards(){
      const start = currentPage * CARDS_PER_PAGE;
      const end = start + CARDS_PER_PAGE;
      const pageRoster = filteredRoster.slice(start, end);

      const cardsHtml = pageRoster.map(r => `
        <div class="roster-card" onclick="selectPlayerCard('${r.player_id}', '${r.display_name}', '${r.primary_pos}', '${r.tryout_num}')">
          <div class="num">${r.tryout_num}</div>
          <div class="name">${r.display_name}</div>
          <div class="pos">${r.primary_pos}</div>
        </div>
      `).join('');

      qs('#rosterCards').innerHTML = cardsHtml;
      qs('#pageInfo').textContent = `Showing ${pageRoster.length} of ${filteredRoster.length}`;
    }

    function updatePager(){
      const totalPages = Math.ceil(filteredRoster.length / CARDS_PER_PAGE);
      qs('#prevPage').disabled = currentPage === 0;
      qs('#nextPage').disabled = currentPage >= totalPages - 1;
      qs('#pageCounter').textContent = `Page ${currentPage + 1} of ${Math.max(1, totalPages)}`;
    }

    window.selectPlayerCard = function(pid, name, pos, num){
      const rec = { player_id: pid, display_name: name, primary_pos: pos, tryout_num: num };
      const arr = selectedSide === 'OFF' ? offense : defense;
      if(arr.find(r => r.player_id === pid)) return;
      arr.push(rec);
      renderLineup();
    };

    function renderLineup(){
      qs('#offenseLineup').innerHTML = offense.map(r => `
        <div class="player-tag">
          ${fmtPlayer(r)} <span class="remove" onclick="removePlayer('${r.player_id}','OFF')">✕</span>
        </div>
      `).join('');
      qs('#defenseLineup').innerHTML = defense.map(r => `
        <div class="player-tag">
          ${fmtPlayer(r)} <span class="remove" onclick="removePlayer('${r.player_id}','DEF')">✕</span>
        </div>
      `).join('');
      updateQBAndCarrierSelects();
      refreshSaveEnabled();
    }

    window.removePlayer = function(pid, side){
      const arr = side === 'OFF' ? offense : defense;
      const idx = arr.findIndex(r => r.player_id === pid);
      if(idx > -1) arr.splice(idx, 1);
      renderLineup();
    };

    function updateQBAndCarrierSelects(){
      const qbs = offense.filter(r => (r.primary_pos||'').toUpperCase() === 'QB');
      const carriers = offense.filter(r => ['RB','WR','TE'].includes((r.primary_pos||'').toUpperCase()));
      const targets = offense.filter(r => ['WR','TE','RB'].includes((r.primary_pos||'').toUpperCase()));
      const defenders = defense; // All defense players can be defenders
      const tacklers = defense; // All defense players can be tacklers
      
      qs('#qbSelect').innerHTML = '<option value="">Select QB</option>' + qbs.map(r => `<option value="${r.player_id}">${fmtPlayer(r)}</option>`).join('');
      qs('#ballCarrier').innerHTML = '<option value="">Select Ball Carrier</option>' + carriers.map(r => `<option value="${r.player_id}">${fmtPlayer(r)}</option>`).join('');
      qs('#targetSelect').innerHTML = '<option value="">Select Target</option>' + targets.map(r => `<option value="${r.player_id}">${fmtPlayer(r)}</option>`).join('');
      qs('#defenderSelect').innerHTML = '<option value="">Select Defender</option>' + defenders.map(r => `<option value="${r.player_id}">${fmtPlayer(r)}</option>`).join('');
      qs('#tacklerSelect').innerHTML = '<option value="">Select Tackler</option>' + tacklers.map(r => `<option value="${r.player_id}">${fmtPlayer(r)}</option>`).join('');
    }

    function refreshSaveEnabled(){
      const ok = offense.length > 0 && defense.length > 0;
      qs('#savePlay').disabled = !ok;
    }

    function addToLog(summary){
      plays.unshift({ts:new Date(), summary});
      plays.splice(30);
      const pad = n => String(n).padStart(2,'0');
      const fmt = d => `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      qs('#playLog').innerHTML = plays.map(p => `<div class="play-row"><strong>${fmt(p.ts)}</strong> — ${p.summary}</div>`).join('');
    }

    async function savePlay(){
      const status = qs('#playStatus');
      status.textContent = '';
      const c = ctx();

      if(!c.tryout_id){ status.textContent='Set Tryout ID'; status.className='status warn'; return; }
      if(offense.length===0 || defense.length===0){ status.textContent='Need both offense & defense'; status.className='status warn'; return; }

      const qbId = qs('#qbSelect').value;
      const carrierId = qs('#ballCarrier').value;
      const targetId = qs('#targetSelect').value;
      const defenderId = qs('#defenderSelect').value;
      const tacklerId = qs('#tacklerSelect').value;
      const gainYards = parseFloat(qs('#gainYards').value) || 0;
      
      const outcome = playType === 'PASS' ? passOutcome : 'RUN';
      const success = (playType === 'PASS' && passOutcome === 'CATCH') ? 1 : (playType === 'RUN' && gainYards > 0) ? 1 : 0;
      const notes = (qs('#playNotes').value||'').trim();
      const attempt = Number(qs('#playAttempt').value||1);

      if(playType === 'PASS' && !qbId){ status.textContent='Select QB for pass play'; status.className='status warn'; return; }
      if(playType === 'RUN' && !carrierId){ status.textContent='Select ball carrier for run play'; status.className='status warn'; return; }

      setSaving(true);

      let rows = [];
      const timestamp = new Date().toISOString();
      const rep_id = `${c.tryout_id}_${attempt}_${Date.now()}`;

      // Build rows for offense
      offense.forEach(p => {
        const isQB = p.player_id === qbId;
        const isCarrier = p.player_id === carrierId;
        const isTarget = p.player_id === targetId && playType === 'PASS';

        rows.push({
          timestamp,
          tryout_id: c.tryout_id,
          period_code: c.period_code || '',
          player_id: p.player_id,
          tryout_num: p.tryout_num,
          group_code: p.primary_pos || p.group_code || '',
          station_id: 'TEAM',
          rep_id,
          unit: playType,
          qb_id: isQB ? qbId : '',
          runner_id: isCarrier ? carrierId : '',
          receiver_id: isTarget ? targetId : '',
          offense_group: p.primary_pos || p.group_code || '',
          defense_group: '',
          result: success,
          catch: isTarget ? (passOutcome === 'CATCH' ? 1 : 0) : '',
          pbu: '',
          int: '',
          tfl: '',
          missed_tkl: '',
          gain_yards: isCarrier ? gainYards : '',
          notes
        });
      });

      // Build rows for defense
      defense.forEach(p => {
        const isDefender = p.player_id === defenderId;
        const isTackler = p.player_id === tacklerId;
        
        rows.push({
          timestamp,
          tryout_id: c.tryout_id,
          period_code: c.period_code || '',
          player_id: p.player_id,
          tryout_num: p.tryout_num,
          group_code: p.primary_pos || p.group_code || '',
          station_id: 'TEAM',
          rep_id,
          unit: playType,
          qb_id: '',
          runner_id: '',
          receiver_id: '',
          offense_group: '',
          defense_group: p.primary_pos || p.group_code || '',
          result: success ? 0 : 1,
          catch: '',
          pbu: (isDefender && defenseAction === 'pbu') ? 1 : '',
          int: (isDefender && defenseAction === 'int') ? 1 : '',
          tfl: (isTackler && tackleType === 'tfl') ? 1 : '',
          missed_tkl: (isTackler && tackleType === 'missed') ? 1 : '',
          gain_yards: '',
          notes
        });
      });

      let ok = true, err = '';
      
      // Save to 73_Fact_Tryout_Team sheet using the correct API route
      try {
        for(const row of rows) {
          const res = await API.tryout.write.team(row);
          
          if(!res?.ok){ 
            ok = false; 
            err = res?.error || 'Save failed'; 
            break; 
          }
        }
      } catch(e) { 
        ok = false; 
        err = e?.message || 'Save failed'; 
      }

      setSaving(false);

      if(!ok){ 
        status.textContent = err; 
        status.className = 'status err'; 
        return; 
      }

      status.textContent = `Saved ✔ — ${rows.length} lines recorded to 73_Fact_Tryout_Team`; 
      status.className = 'status ok';
      
      const defStats = [];
      if(defenderId && defenseAction !== 'none') defStats.push(defenseAction.toUpperCase());
      if(tacklerId && tackleType !== 'none') defStats.push(tackleType.toUpperCase());
      const defSummary = defStats.length ? ` | DEF: ${defStats.join(', ')}` : '';
      const yardSummary = playType === 'RUN' && gainYards !== 0 ? ` | ${gainYards > 0 ? '+' : ''}${gainYards} yds` : '';
      
      addToLog(`${playType} → ${passOutcome || 'RUN'}${yardSummary}${defSummary} (${offense.length} OFF, ${defense.length} DEF)`);

      const next = Math.min(attempt % 10 + 1, 10);
      qs('#playAttempt').value = next;
      
      // Reset defensive action and tackle type
      defenseAction = 'none';
      tackleType = 'none';
      qs('#defNone').classList.add('active');
      qs('#defPBU').classList.remove('active');
      qs('#defINT').classList.remove('active');
      qs('#tklNone').classList.add('active');
      qs('#tklTFL').classList.remove('active');
      qs('#tklMissed').classList.remove('active');
      qs('#gainYards').value = '';
    }

    // Event wiring
    qs('#drillSelect').addEventListener('change', updateDrillUI);

    qs('#sideOff').addEventListener('click', function(){ selectedSide='OFF'; this.classList.add('active'); qs('#sideDef').classList.remove('active'); qs('#selectedHint').textContent = 'Click cards to add to Offense'; });
    qs('#sideDef').addEventListener('click', function(){ selectedSide='DEF'; this.classList.add('active'); qs('#sideOff').classList.remove('active'); qs('#selectedHint').textContent = 'Click cards to add to Defense'; });

    qs('#typePass').addEventListener('click', function(){ 
      playType='PASS'; 
      this.classList.add('active'); 
      qs('#typeRun').classList.remove('active'); 
      qs('#passInputs').style.display='block'; 
      qs('#passDefenseInputs').style.display='block'; 
      qs('#runInputs').style.display='none'; 
    });
    qs('#typeRun').addEventListener('click', function(){ 
      playType='RUN'; 
      this.classList.add('active'); 
      qs('#typePass').classList.remove('active'); 
      qs('#passInputs').style.display='none'; 
      qs('#passDefenseInputs').style.display='none'; 
      qs('#runInputs').style.display='block'; 
    });

    qs('#outcomeSuccess').addEventListener('click', function(){ passOutcome='CATCH'; this.classList.add('active'); qs('#outcomeFail').classList.remove('active'); });
    qs('#outcomeFail').addEventListener('click', function(){ passOutcome='INCOMPLETE'; this.classList.add('active'); qs('#outcomeSuccess').classList.remove('active'); });

    // Defense actions for passes
    qs('#defPBU').addEventListener('click', function(){ defenseAction='pbu'; this.classList.add('active'); qs('#defINT').classList.remove('active'); qs('#defNone').classList.remove('active'); });
    qs('#defINT').addEventListener('click', function(){ defenseAction='int'; this.classList.add('active'); qs('#defPBU').classList.remove('active'); qs('#defNone').classList.remove('active'); });
    qs('#defNone').addEventListener('click', function(){ defenseAction='none'; this.classList.add('active'); qs('#defPBU').classList.remove('active'); qs('#defINT').classList.remove('active'); });

    // Tackle types for runs
    qs('#tklTFL').addEventListener('click', function(){ tackleType='tfl'; this.classList.add('active'); qs('#tklMissed').classList.remove('active'); qs('#tklNone').classList.remove('active'); });
    qs('#tklMissed').addEventListener('click', function(){ tackleType='missed'; this.classList.add('active'); qs('#tklTFL').classList.remove('active'); qs('#tklNone').classList.remove('active'); });
    qs('#tklNone').addEventListener('click', function(){ tackleType='none'; this.classList.add('active'); qs('#tklTFL').classList.remove('active'); qs('#tklMissed').classList.remove('active'); });

    qs('#prevPage').addEventListener('click', () => { if(currentPage > 0) { currentPage--; renderRosterCards(); updatePager(); } });
    qs('#nextPage').addEventListener('click', () => { const maxPage = Math.ceil(filteredRoster.length / CARDS_PER_PAGE) - 1; if(currentPage < maxPage) { currentPage++; renderRosterCards(); updatePager(); } });

    qs('#savePlay').addEventListener('click', savePlay);

    (async function init(){
      await Promise.all([loadRoster(), loadDrills()]);
      renderFilterButtons();
      qs('#selectedHint').textContent = 'Click cards to add to Offense';
    })();
  </script>
</body>
</html>