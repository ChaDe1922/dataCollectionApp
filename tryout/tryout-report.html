<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Apps Script base -->
  <meta name="gsds-api-base" content="https://script.google.com/macros/s/AKfycbz2m5h4t5O5x9XdvNnMVMFWAZHBHdo4TnTy0W22e1jYF6jkzOHKc9vnwWCu7Q5a8HLOPg/exec">

  <title>Coaches Corner — Tryouts</title>

  <!-- Auth guard -->
  <script>
    (function () {
      const ok = localStorage.getItem('auth_ok') === '1' &&
                 Number(localStorage.getItem('auth_until') || 0) > Date.now();
      if (!ok) location.href = '../index.html#login';
    })();
  </script>

  <!-- Theme + fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../style.css"/>

  <style>
    :root { --gap:12px; }
    .container{ max-width:1100px; margin:0 auto; padding:16px; }
    .stack{ display:flex; flex-direction:column; gap:var(--gap); }
    .card{ background: rgba(255,255,255,.05); border:1px solid var(--border);
           border-radius:16px; padding:14px; box-shadow: var(--shadow-soft, 0 8px 24px rgba(0,0,0,.18)); }
    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
           border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06); font-weight:700; }
    .chip.badge{ background:linear-gradient(135deg,#7C4DFF,#8B5CF6); color:#071018; border:0; }
    .chip.tiny{ font-size:.8rem; padding:4px 8px; }
    .label{ font-weight:800; font-size:.95rem; opacity:.9; margin-bottom:6px; display:block; }
    .form-input, .form-select{ width:100%; padding:.68rem .8rem; border-radius:12px; border:1px solid rgba(255,255,255,.28);
      background:rgba(255,255,255,.08); color:#fff; }
    .row{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width:760px){ .row{ grid-template-columns: repeat(3, 1fr); } }

    .grid-4{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width:900px){ .grid-4{ grid-template-columns:1fr 1fr; } }

    .lane-title{ display:flex; align-items:center; justify-content:space-between; gap:10px; font-weight:900; letter-spacing:.04em; opacity:.9; }
    .lane-chip{ display:inline-flex; align-items:center; gap:8px; padding:4px 8px; border-radius:999px;
                border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08); font-weight:800; font-size:.9rem; }
    .lane-chip .x{ opacity:.7; cursor:pointer; padding:0 .25rem; }
    .lane-card{ transition: box-shadow .15s ease, border-color .15s ease; }
    .lane-card.lane-active{ border-color:#8B5CF6; box-shadow:0 0 0 2px rgba(139,92,246,.35) inset; }

    /* 4-lane segmented switch */
    .seg{ display:inline-flex; border:1px solid rgba(255,255,255,.18); border-radius:12px; overflow:hidden; }
    .seg .seg-btn{
      appearance:none; border:0; background:rgba(255,255,255,.06); color:#fff;
      padding:.5rem .8rem; font-weight:800; cursor:pointer;
      border-right:1px solid rgba(255,255,255,.18);
    }
    .seg .seg-btn:last-child{ border-right:0; }
    .seg .seg-btn.is-active{ background:linear-gradient(135deg,#7C4DFF,#8B5CF6); color:#071018; }

    /* ===== 1–5 rating buttons ===== */
    .crit{ display:grid; grid-template-columns: 1fr auto auto; gap:10px; align-items:center; }
    .crit label{ font-weight:800; font-size:.95rem; }
    .crit .val{ width:40px; text-align:right; font-variant-numeric:tabular-nums; font-weight:900; opacity:.9; }
    .rating-group{ display:flex; gap:10px; }
    .rating-btn{
      width:52px; height:52px; border-radius:12px; border:1px solid rgba(255,255,255,.28);
      background:rgba(255,255,255,.08); color:#fff; font-weight:900; font-size:1.05rem; line-height:1;
      cursor:pointer; user-select:none; display:inline-flex; align-items:center; justify-content:center;
      transition:transform .06s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;
    }
    .rating-btn:active{ transform:scale(.96); }
    .rating-btn:focus-visible{ outline:2px solid #8B5CF6; outline-offset:2px; }
    .rating-btn[aria-pressed="true"]{
      background:linear-gradient(135deg,#7C4DFF,#8B5CF6); color:#071018; border-color:transparent;
      box-shadow:0 0 0 2px rgba(139,92,246,.35) inset;
    }

    .btn{ appearance:none; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.08); color:#fff;
          padding:.55rem .8rem; border-radius:10px; font-weight:800; cursor:pointer; transition:.2s ease; }
    .btn.success{ background:linear-gradient(135deg,#16A34A,#10B981); color:#061710; border:0; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    /* Spinner overlay */
    .shared-wrap{ position:relative; }
    .tu-loading{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      gap:10px; background:rgba(0,0,0,.35); border:1px solid var(--border); border-radius:14px;
      z-index:10; font-weight:800; letter-spacing:.02em;
    }
    .tu-loading .ring{ width:28px; height:28px; border:3px solid rgba(255,255,255,.35);
      border-top-color:#fff; border-radius:50%; animation:spin .9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Pagination + done visuals */
    .cc-pager{ display:flex; gap:8px; justify-content:flex-end; align-items:center; margin-top:10px; }
    .cc-pager .cc-btn{ padding:.35rem .6rem; border:1px solid rgba(255,255,255,.25); border-radius:8px; background:rgba(255,255,255,.08); color:#fff; font-weight:800; }
    .cc-pager .cc-btn:disabled{ opacity:.45; cursor:not-allowed; }
    .cc-pager .cc-meta{ font-weight:800; opacity:.9; }

    .tu-player.cc-done, .tu-card.cc-done{ opacity:.45; filter:grayscale(1); position:relative; }
    .tu-player.cc-done::after, .tu-card.cc-done::after{
      content:'✓'; position:absolute; top:6px; right:6px; width:22px; height:22px; display:flex; align-items:center; justify-content:center;
      border-radius:999px; background:#10B981; color:#061710; font-weight:900; border:1px solid rgba(0,0,0,.25);
    }

    .status{ margin-top:8px; font-weight:700; }
    .status.ok{ color:#34D399; }
    .status.err{ color:#F87171; }
    .status.warn{ color:#F59E0B; }
  </style>
</head>

<body class="theme-atl practice-page">
  <header class="page-header">
    <h1>Coaches Corner</h1>
    <nav class="menu-actions">
      <a href="../index.html" class="menu-btn">Home</a>
      <a href="../tryout/index.html" class="menu-btn">Tryout Hub</a>
    </nav>
  </header>

  <main>
    <div class="container stack">
      <div id="ctxBanner" class="chip tiny" aria-live="polite">Loading context…</div>

      <section class="card" aria-labelledby="coachHdr">
        <div class="toolbar" style="width:100%; align-items:flex-end; gap:14px">
          <span class="chip">Mode: <strong>Coach Ratings</strong></span>

          <div style="min-width:220px">
            <label id="coachHdr" for="coachSelect" class="label" style="margin:0">Coach</label>
            <select id="coachSelect" class="form-select"></select>
          </div>

          <div style="min-width:180px">
            <label for="stationSelect" class="label" style="margin:0">Station</label>
            <select id="stationSelect" class="form-select">
              <option value="AGILITY">Agility</option>
              <option value="QB">QB</option>
              <option value="RB">RB</option>
              <option value="WR">WR</option>
              <option value="TE">TE</option>
              <option value="OL">OL</option>
              <option value="DL">DL</option>
              <option value="LB">LB</option>
              <option value="DB">DB</option>
              <option value="1V1">1v1</option>
              <option value="TEAM">Team</option>
            </select>
          </div>

          <div style="min-width:260px">
            <label for="coachDrill" class="label" style="margin:0">Coach Drill (defaults lanes)</label>
            <select id="coachDrill" class="form-select"></select>
          </div>

          <!-- Assign selection to lane -->
          <div id="laneSegWrap" class="seg" role="group" aria-label="Assign selection to lane">
            <button type="button" class="seg-btn is-active" data-lane="A" aria-pressed="true">Lane A</button>
            <button type="button" class="seg-btn" data-lane="B" aria-pressed="false">Lane B</button>
            <button type="button" class="seg-btn" data-lane="C" aria-pressed="false">Lane C</button>
            <button type="button" class="seg-btn" data-lane="D" aria-pressed="false">Lane D</button>
          </div>

          <span id="coachBadge" class="chip badge">Active Lane: A</span>
        </div>
        <div class="muted" id="stationHint"></div>
      </section>

      <!-- Shared Tryout UI -->
      <section class="card">
        <div class="shared-wrap">
          <div id="tryout-shared"></div>
          <div id="tryout-loading" class="tu-loading" aria-live="polite" aria-busy="true">
            <span class="ring" aria-hidden="true"></span>
            <span>Loading roster…</span>
          </div>
        </div>
      </section>

      <!-- Four lanes -->
      <section class="grid-4">
        <!-- Lane A -->
        <div id="laneA" class="card lane-card lane-active" data-lane="A">
          <div class="lane-title">
            <span>Lane A</span>
            <span id="whoA" class="lane-chip" style="display:none"></span>
          </div>
          <div class="row" style="margin-top:8px">
            <div>
              <label class="label">Drill</label>
              <select id="drillA" class="form-select"></select>
            </div>
            <div>
              <label class="label">Attempt</label>
              <select id="attA" class="form-select"><option>1</option><option>2</option><option>3</option></select>
            </div>
            <div>
              <label class="label">Notes</label>
              <input id="notesA" class="form-input" placeholder="coaching note…"/>
            </div>
          </div>
          <div id="critA" style="margin-top:8px"></div>
          <div class="toolbar" style="margin-top:10px">
            <button id="saveA" class="btn success" disabled>Save Ratings (A)</button>
          </div>
          <div id="statusA" class="status"></div>
        </div>

        <!-- Lane B -->
        <div id="laneB" class="card lane-card" data-lane="B">
          <div class="lane-title">
            <span>Lane B</span>
            <span id="whoB" class="lane-chip" style="display:none"></span>
          </div>
          <div class="row" style="margin-top:8px">
            <div>
              <label class="label">Drill</label>
              <select id="drillB" class="form-select"></select>
            </div>
            <div>
              <label class="label">Attempt</label>
              <select id="attB" class="form-select"><option>1</option><option>2</option><option>3</option></select>
            </div>
            <div>
              <label class="label">Notes</label>
              <input id="notesB" class="form-input" placeholder="coaching note…"/>
            </div>
          </div>
          <div id="critB" style="margin-top:8px"></div>
          <div class="toolbar" style="margin-top:10px">
            <button id="saveB" class="btn success" disabled>Save Ratings (B)</button>
          </div>
          <div id="statusB" class="status"></div>
        </div>

        <!-- Lane C -->
        <div id="laneC" class="card lane-card" data-lane="C">
          <div class="lane-title">
            <span>Lane C</span>
            <span id="whoC" class="lane-chip" style="display:none"></span>
          </div>
          <div class="row" style="margin-top:8px">
            <div>
              <label class="label">Drill</label>
              <select id="drillC" class="form-select"></select>
            </div>
            <div>
              <label class="label">Attempt</label>
              <select id="attC" class="form-select"><option>1</option><option>2</option><option>3</option></select>
            </div>
            <div>
              <label class="label">Notes</label>
              <input id="notesC" class="form-input" placeholder="coaching note…"/>
            </div>
          </div>
          <div id="critC" style="margin-top:8px"></div>
          <div class="toolbar" style="margin-top:10px">
            <button id="saveC" class="btn success" disabled>Save Ratings (C)</button>
          </div>
          <div id="statusC" class="status"></div>
        </div>

        <!-- Lane D -->
        <div id="laneD" class="card lane-card" data-lane="D">
          <div class="lane-title">
            <span>Lane D</span>
            <span id="whoD" class="lane-chip" style="display:none"></span>
          </div>
          <div class="row" style="margin-top:8px">
            <div>
              <label class="label">Drill</label>
              <select id="drillD" class="form-select"></select>
            </div>
            <div>
              <label class="label">Attempt</label>
              <select id="attD" class="form-select"><option>1</option><option>2</option><option>3</option></select>
            </div>
            <div>
              <label class="label">Notes</label>
              <input id="notesD" class="form-input" placeholder="coaching note…"/>
            </div>
          </div>
          <div id="critD" style="margin-top:8px"></div>
          <div class="toolbar" style="margin-top:10px">
            <button id="saveD" class="btn success" disabled>Save Ratings (D)</button>
          </div>
          <div id="statusD" class="status"></div>
        </div>
      </section>
    </div>
  </main>

  <footer class="site-footer">
    <p>&copy; 2025 Game Speed Data Systems</p>
  </footer>

  <!-- libs -->
  <script src="../js/api.js"></script>
  <script src="../js/rules.js"></script>
  <script src="../js/context.js"></script>
  <script src="../js/tryout-ui.js"></script>

  <script>
    // ---------- Boot shared context ----------
    (function(){
      const meta = document.querySelector('meta[name="gsds-api-base"]');
      window.API_BASE = (window.API_BASE || (meta && meta.content) || '').trim();
    })();
    GameContext.configure({ apiBase: window.API_BASE, server: true, pollMs: 1000 });
    GameContext.mountBanner('#ctxBanner');

    // ---------- Small API helper ----------
    async function apiGet(action, params={}) {
      const url = new URL(window.API_BASE);
      url.searchParams.set('action', action);
      Object.entries(params).forEach(([k,v])=> url.searchParams.set(k, v));
      const r = await fetch(url, { credentials:'omit' });
      return r.json();
    }
    async function apiPost(payload) {
      const r = await fetch(window.API_BASE, { method:'POST', headers:{'Content-Type':'text/plain','Accept':'application/json'}, body: JSON.stringify(payload) });
      return r.json();
    }

    // ---------- Constants ----------
    const PAGE_SIZE = 10;
    const POS_STATIONS = ['QB','RB','WR','TE','OL','DL','LB','DB'];

    // ---------- State ----------
    const savedPlayers = new Set();           // mark roster cards after save
    let roster = [];
    const groupLatest = new Map();
    let drills = [];
    let drillMap = new Map();
    let criteriaIndex = {};

    const lanePlayers = { A:null, B:null, C:null, D:null };
    const laneAttempt = { A:1, B:1, C:1, D:1 };
    let activeLane = 'A';

    // ---------- Helpers ----------
    const qs  = (s,p=document)=>p.querySelector(s);
    const qsa = (s,p=document)=>[...p.querySelectorAll(s)];
    function ctx(){ return GameContext.get ? GameContext.get() : {}; }
    const uuid = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
      const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8); return v.toString(16);
    });
    function stationId(){ return String(qs('#stationSelect')?.value || 'AGILITY').toUpperCase(); }
    function coachDrillId(){ return String(qs('#coachDrill')?.value || ''); }
    const toTri = v => (/^\d{1,3}$/.test(String(v||'').trim()) ? String(v).padStart(3,'0') : String(v||'').trim());

    function normalizePlayer(rec){
      if (!rec) return null;
      const pid  = String(rec.player_id || rec.id || '').trim();
      const tnum = toTri(rec.tryout_num || rec.number || rec.jersey_number || '');
      const byPid  = pid  ? roster.find(r => String(r.player_id||'').trim() === pid) : null;
      const byTnum = tnum ? roster.find(r => toTri(r.tryout_num) === tnum) : null;
      return byPid || byTnum || null;
    }

    // ---------- Coaches ----------
    function getAuthIdentityTokens(){
      const tokens = new Set();
      const add = v => { if(!v) return; tokens.add(String(v).trim().toLowerCase()); };
      const keys = ['auth_user','auth_username','auth_email','user_email','email','username','user','display_name','coach_id','coach_name'];
      keys.forEach(k => add(localStorage.getItem(k)));
      try { const obj = JSON.parse(localStorage.getItem('auth_user') || '{}');
            ['username','email','name','id','display_name'].forEach(k=> add(obj?.[k])); } catch(e){}
      return tokens;
    }

    async function loadCoaches(){
      const sel = qs('#coachSelect');
      let rows = [];
      try{ const res = await apiGet('coaches_get'); if (res?.ok) rows = res.coaches || []; }catch(e){}
      if (!rows.length) rows = [{ coach_id:'coach.unknown', coach_name:'Coach' }];
      sel.innerHTML = rows.map(r=> `<option value="${r.coach_id}">${r.coach_name}</option>`).join('');

      const tokens = getAuthIdentityTokens();
      let picked = null;
      if (tokens.size){
        for (const opt of sel.options) {
          const val = String(opt.value).toLowerCase();
          const txt = String(opt.textContent||'').toLowerCase();
          if (tokens.has(val) || tokens.has(txt)) { picked = opt.value; break; }
        }
      }
      if (!picked) {
        const last = localStorage.getItem('coach_id');
        if (last && [...sel.options].some(o=>o.value===last)) picked = last;
      }
      if (!picked && sel.options.length === 1) picked = sel.options[0].value;
      if (picked) sel.value = picked;
      localStorage.setItem('coach_id', sel.value);
    }

    // ---------- Roster & groups ----------
    async function loadRoster(){
      const res = await apiGet('tryout_roster');
      if(!res?.ok) return;
      const tid = ctx().tryout_id || '';
      roster = (res.roster||res.rows||[])
        .filter(r => !tid || String(r.tryout_id||'')===String(tid))
        .map(r => ({
          player_id:    r.player_id || r.id || '',
          display_name: r.display_name || r.player_name || r.name || '',
          primary_pos:  r.primary_pos || r.position || '',
          tryout_num:   toTri(r.tryout_num || r.jersey_number || r.number || ''),
          group_code:   r.group_code || r.primary_pos || '',
          tryout_id:    r.tryout_id || r.tryout || r.session_id || ''
        }))
        .sort((a,b)=> (parseInt(a.tryout_num,10)||0) - (parseInt(b.tryout_num,10)||0));
    }

    async function loadLatestGroups(){
      const res = await apiGet('tryout_groups_get', { latest: '1', tryout_id: ctx().tryout_id||'' });
      if(!res?.ok || !Array.isArray(res.latest)) return;
      groupLatest.clear();
      res.latest.forEach(row => { if(row.player_id && row.group_code) groupLatest.set(String(row.player_id).trim(), String(row.group_code).trim()); });
    }
    function resolveGroupCode(pid, fallback, rec){
      if (pid) {
        const direct = groupLatest.get(String(pid).trim());
        if (direct) return direct;
        const r = roster.find(x => String(x.player_id).trim() === String(pid).trim());
        return r?.group_code || r?.primary_pos || fallback || '';
      }
      return rec?.group_code || rec?.primary_pos || fallback || '';
    }

    // ---------- Drills + Criteria ----------
    async function loadDrills(){
      const want = stationId();
      let rows = [];
      try{
        const dd = await apiGet('tryout_drilldict');
        const all = (dd?.drills||[]).map(d => ({ ...d, station_id:String(d.station_id||'').toUpperCase() }));
        rows = all.filter(d => d.station_id===want);
        if (!rows.length) rows = all;
      }catch(e){}
      if (!Array.isArray(rows) || !rows.length) rows = [{drill_id:'GEN01', drill_name:`${want} Drill`, station_id:want}];

      rows.sort((a,b)=> String(a.drill_name||a.drill_id).localeCompare(String(b.drill_name||b.drill_id)));
      drills = rows.map(d => ({...d, drill_id:String(d.drill_id)}));
      drillMap = new Map(drills.map(d => [String(d.drill_id), d]));

      const coachDrillSel = qs('#coachDrill');
      coachDrillSel.innerHTML = drills.map(d => `<option value="${d.drill_id}">${d.drill_name || d.name || d.drill_id}</option>`).join('');
      if (drills[0]) coachDrillSel.value = drills[0].drill_id;

      ['A','B','C','D'].forEach(l=>{
        const sel = qs('#drill'+l);
        sel.innerHTML = coachDrillSel.innerHTML;
        if ([...sel.options].some(o=>o.value===coachDrillSel.value)) sel.value = coachDrillSel.value;
      });

      qs('#stationHint').textContent = `Loaded ${drills.length} drill${drills.length===1?'':'s'} for ${want}.`;

      await loadCriteriaIndexForStation(want);
      await Promise.all(['A','B','C','D'].map(renderCriteriaUI));
    }

    async function loadCriteriaIndexForStation(station){
      criteriaIndex = {};
      try{
        const res = await apiGet('tryout_coach_criteria', { station_id: station });
        if (res?.ok && res.by_drill) criteriaIndex = res.by_drill;
      }catch(e){}
    }

    function labelsFromDrill(d){
      const fromIndex = (criteriaIndex[d.drill_id] || []).map((c,i)=>({ id:c.criterion_id||`${d.drill_id}::C${i+1}`, label:c.criterion_label||`Trait ${i+1}`, weight:c.weight||1, order:c.order||i+1 }));
      if (fromIndex.length) return fromIndex;
      const sources = [d.rating_labels, d.criteria_labels, d.coach_criteria, d.criteria, d.labels];
      let raw = sources.map(s=> (typeof s==='string'? s : Array.isArray(s)? s.join('|') : '')).filter(Boolean).shift() || '';
      let arr = raw.split(/[|,;/]/).map(t=>t.trim()).filter(Boolean).slice(0,8);
      if (!arr.length) arr = ['Trait 1','Trait 2','Trait 3'];
      return arr.map((txt,i)=> ({ id:`${d.drill_id}::C${i+1}`, label:txt, weight:1, order:i+1 }));
    }

    async function renderCriteriaUI(lane){
      const sel = qs('#drill'+lane);
      const drillId = sel?.value || (drills[0]?.drill_id) || '';
      const d = drillMap.get(drillId) || drills[0] || { drill_id: 'GEN01' };
      const box = qs('#crit'+lane);
      if (!box) return;

      const use = labelsFromDrill(d);
      const def = 3;

      box.innerHTML = use.map(c => `
        <div class="crit" data-crit-id="${c.id}">
          <label>${c.label}</label>
          <div class="rating-group" role="group" aria-label="${c.label}">
            ${[1,2,3,4,5].map(v =>
              `<button type="button" class="rating-btn"
                       data-val="${v}" aria-pressed="${v===def?'true':'false'}"
                       aria-label="${c.label} ${v}">${v}</button>`
            ).join('')}
          </div>
          <span class="val">${def}</span>
        </div>
      `).join('');

      [...box.querySelectorAll('.rating-group')].forEach(group=>{
        group.addEventListener('click', e=>{
          const btn = e.target.closest('.rating-btn'); if(!btn) return;
          group.querySelectorAll('.rating-btn').forEach(b=> b.setAttribute('aria-pressed', b===btn ? 'true' : 'false'));
          group.parentElement.querySelector('.val').textContent = btn.dataset.val;
        });
        group.addEventListener('keydown', e=>{
          if (!['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Home','End'].includes(e.key)) return;
          e.preventDefault();
          const buttons = [...group.querySelectorAll('.rating-btn')];
          let idx = buttons.findIndex(b=>b.getAttribute('aria-pressed')==='true');
          if (idx < 0) idx = def - 1;
          if (e.key==='ArrowRight' || e.key==='ArrowUp')   idx = Math.min(4, idx+1);
          if (e.key==='ArrowLeft'  || e.key==='ArrowDown') idx = Math.max(0, idx-1);
          if (e.key==='Home') idx = 0;
          if (e.key==='End')  idx = 4;
          buttons.forEach((b,i)=> b.setAttribute('aria-pressed', String(i===idx)));
          group.parentElement.querySelector('.val').textContent = buttons[idx].dataset.val;
          buttons[idx].focus();
        });
      });
    }

    // ---------- Shared Tryout UI mounting ----------
    async function mountRosterForStation(){
      const overlay = document.getElementById('tryout-loading');
      const mountSel = '#tryout-shared';
      const sid = stationId();

      overlay.style.display = 'flex';
      document.querySelector(mountSel).innerHTML = '';

      const isPos = POS_STATIONS.includes(sid);
      const opts = isPos
        ? { showGroup:true,  filterMode:'groups',      allowPresence:false, clickSelects:true, showHideDoneToggle:true }
        : { showGroup:false, filterMode:'numberBands', allowPresence:false, clickSelects:true, showHideDoneToggle:true };

      await TryoutUI.init(mountSel, opts);

      // Immediately filter on position stations
      if (isPos) GameContext.setGroup(sid); else GameContext.setGroup('');

      // Ensure roster clicks/keys assign to lanes
      wireRosterDelegation();

      setupPagination();
      overlay.style.display = 'none';
    }

    // ---------- Pagination ----------
    function setupPagination(){
      const root = document.querySelector('#tryout-shared');
      const rosterBox = root.querySelector('#tuRoster, .tu-roster') || root;
      if (!rosterBox) return;

      let pager = root.querySelector('#ccPager');
      if (!pager){
        pager = document.createElement('div');
        pager.id = 'ccPager';
        pager.className = 'cc-pager';
        pager.innerHTML = `
          <button class="cc-btn" data-act="prev">Prev</button>
          <span class="cc-meta" data-role="meta">Page 1 of 1</span>
          <button class="cc-btn" data-act="next">Next</button>
        `;
        root.appendChild(pager);
      }

      const state = { page:1, pages:1 };
      const meta = pager.querySelector('[data-role="meta"]');
      const btnPrev = pager.querySelector('[data-act="prev"]');
      const btnNext = pager.querySelector('[data-act="next"]');

      function currentCards(){
        const cards = [...rosterBox.querySelectorAll('.tu-player, .tu-card, [data-player-id]')];
        return cards.filter(c => c.offsetParent !== null && getComputedStyle(c).display !== 'none');
      }

      function render(){
        const cards = currentCards();
        const total = cards.length;
        state.pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        state.page  = Math.min(state.pages, Math.max(1, state.page));
        cards.forEach((c,i)=>{
          const inPage = i >= (state.page-1)*PAGE_SIZE && i < state.page*PAGE_SIZE;
          c.style.display = inPage ? '' : 'none';
        });
        meta.textContent = `Page ${state.page} of ${state.pages}`;
        btnPrev.disabled = (state.page <= 1);
        btnNext.disabled = (state.page >= state.pages);
        pager.style.display = (total > PAGE_SIZE) ? 'flex' : 'none';
      }

      btnPrev.onclick = ()=>{ state.page--; render(); };
      btnNext.onclick = ()=>{ state.page++; render(); };

      const mo = new MutationObserver(()=>{ state.page = 1; render(); });
      mo.observe(rosterBox, { childList:true, subtree:true, attributes:true, attributeFilter:['style','class'] });

      render();
    }

    // ---------- Lane activation ----------
    function setActiveLane(l){
      const L = ['A','B','C','D'].includes(l) ? l : 'A';
      activeLane = L;
      qs('#coachBadge').textContent = `Active Lane: ${L}`;
      ['A','B','C','D'].forEach(x=>{
        qs('#lane'+x).classList.toggle('lane-active', x===L);
      });
      qsa('#laneSegWrap .seg-btn').forEach(btn=>{
        const on = btn.dataset.lane === L;
        btn.classList.toggle('is-active', on);
        btn.setAttribute('aria-pressed', on ? 'true' : 'false');
      });
    }
    qsa('#laneSegWrap .seg-btn').forEach(btn=>{
      btn.addEventListener('click', ()=> setActiveLane(btn.dataset.lane));
    });
    document.addEventListener('click', (e)=>{
      const laneEl = e.target.closest('.lane-card'); if (!laneEl) return;
      const l = laneEl.dataset.lane || (laneEl.id||'').replace(/^lane/,'');
      if (l) setActiveLane(l);
    });

    // ---------- Lane reset helpers ----------
    function resetLaneUI(l){
      laneAttempt[l] = 1;
      const attSel = qs('#att'+l);
      const notes  = qs('#notes'+l);
      if (attSel) attSel.value = '1';
      if (notes)  notes.value  = '';
      renderCriteriaUI(l);
      const btn = qs('#save'+l);
      if (btn) btn.disabled = !lanePlayers[l];
    }

    // ---------- Lane chips / assign / clear ----------
    function renderLaneChip(l){
      const rec = lanePlayers[l];
      const el = qs('#who'+l);
      const saveBtn = qs('#save'+l);
      if (rec){
        const txt = `${rec.tryout_num||''} • ${rec.display_name||rec.player_id}${rec.primary_pos?` (${rec.primary_pos})`:''}`;
        el.innerHTML = `${txt} <span class="x" title="Clear" aria-label="Clear" data-clear="${l}">✕</span>`;
        el.style.display = '';
        saveBtn.disabled = false;
        el.querySelector('.x').addEventListener('click', (ev)=> {
          ev.stopPropagation(); ev.preventDefault();
          unassignLane(l);
        }, { once:true });
      } else {
        el.style.display = 'none';
        saveBtn.disabled = true;
      }
    }
    function assignToActiveLane(rec){
      const L = activeLane;
      lanePlayers[L] = rec;
      resetLaneUI(L);
      renderLaneChip(L);
    }
    function unassignLane(L){
      const rec = lanePlayers[L];
      lanePlayers[L] = null;
      renderLaneChip(L);
      resetLaneUI(L);
      if (rec && savedPlayers.has(rec.player_id||rec.tryout_num)) {
        try { TryoutUI?.markDone?.(rec.player_id || rec.tryout_num); } catch {}
        markCardDoneUI(rec);
      }
    }

    // ---------- Save ratings ----------
    function setSaving(lane, saving){
      const btn = qs('#save'+lane);
      if (!btn.dataset.label) btn.dataset.label = btn.textContent;
      if (saving){
        btn.classList.add('loading'); btn.disabled = true;
        btn.innerHTML = '<span class="spin"></span>Saving…';
      } else {
        btn.classList.remove('loading');
        btn.disabled = !lanePlayers[lane];
        btn.textContent = btn.dataset.label || 'Save';
      }
    }

    function markCardDoneUI(player){
      try { TryoutUI?.markDone?.(player.player_id || player.tryout_num); } catch {}
      const root = document.getElementById('tryout-shared');
      const num = toTri(player.tryout_num||'');
      const pid = String(player.player_id||'').trim();
      const sels = [
        `[data-player-id="${pid}"]`,
        `[data-id="${pid}"]`,
        `[data-tryout-num="${num}"]`,
        `[data-number="${num}"]`,
        `[data-num="${num}"]`
      ];
      root.querySelectorAll(sels.join(',')).forEach(c=> c.classList.add('cc-done'));
    }

    async function saveLane(lane){
      const statusEl = qs('#status'+lane);
      statusEl.textContent = '';

      const coachSel = qs('#coachSelect');
      const stationSel = qs('#stationSelect');
      const drillSel = qs('#drill'+lane);

      const c = ctx();
      if (!c.tryout_id){ statusEl.textContent='Set a Tryout ID first.'; statusEl.className='status warn'; return; }

      const player = lanePlayers[lane];
      if(!(player?.tryout_num || player?.player_id)){
        statusEl.textContent=`Assign a player to Lane ${lane}.`;
        statusEl.className='status warn';
        return;
      }

      const drill = drillMap.get(drillSel.value);
      if(!drill){ statusEl.textContent='Choose a drill.'; statusEl.className='status warn'; return; }

      const att = Number(qs('#att'+lane).value || 1);
      const notes = (qs('#notes'+lane).value || '').trim();

      const critBox = qs('#crit'+lane);
      const critRows = [...(critBox?.querySelectorAll('.crit')||[])].map(el => {
        const id = el.getAttribute('data-crit-id');
        const label = el.querySelector('label')?.textContent || id;
        const selBtn = el.querySelector('.rating-btn[aria-pressed="true"]');
        const val = Number(selBtn?.dataset.val || 3);
        return { id, label, value: val, weight: 1 };
      });

      const tsUTC = new Date().toISOString();
      const repId = uuid();
      const clientId = (localStorage.getItem('client_id') || (function(){ const id=uuid(); localStorage.setItem('client_id', id); return id; })());

      const base = {
        rating_id: uuid(),
        ts_utc: tsUTC,
        tryout_id:   c.tryout_id || '',
        period_code: c.period_code || '',
        station_id:  String(stationSel.value || drill.station_id || '').toUpperCase(),
        coach_id:    coachSel.value || '',
        coach_name:  coachSel.selectedOptions?.[0]?.textContent || coachSel.value || '',
        player_id:   String(player.player_id || '').trim(),
        tryout_num:  String(player.tryout_num || '').trim(),
        group_code:  resolveGroupCode(player.player_id, '', player) || '',
        position_group: String(player.primary_pos || '').trim(),
        drill_id:    drill.drill_id,
        lane:        lane,
        attempt:     att,
        rep_id:      repId,
        notes:       notes,
        source_app:  'coaches_corner_v1',
        client_id:   clientId
      };

      const ops = critRows.map(cr => ({
        route: 'tryout_coach_ratings',
        ensure_headers: [
          'rating_id','ts_utc','tryout_id','period_code','station_id','coach_id','coach_name','player_id',
          'tryout_num','group_code','position_group','drill_id','criterion_id','criterion_label','rating_value',
          'weight','lane','attempt','rep_id','notes','source_app','client_id'
        ],
        row: { ...base, criterion_id: cr.id, criterion_label: cr.label, rating_value: cr.value, weight: cr.weight }
      }));

      setSaving(lane, true);
      let ok=true, err='';
      try{
        const res = await apiPost({ action:'batch', ops });
        ok = !!res?.ok;
        if (!ok) err = res?.error || 'Save failed.';
      } catch(e){ ok=false; err = e?.message || 'Save failed.'; }
      setSaving(lane, false);

      if(!ok){ statusEl.textContent = err; statusEl.className = 'status err'; return; }

      statusEl.textContent = `Saved ✔ · ${ops.length} rating${ops.length===1?'':'s'} recorded`;
      statusEl.className = 'status ok';

      // auto-increment attempt for multiple reps (same player)
      const next = (att % 3) + 1; laneAttempt[lane] = next;
      qs('#att'+lane).value = String(next);

      // mark roster card, allow lane to be cleared with ✓ showing on roster
      savedPlayers.add(player.player_id || player.tryout_num);
      markCardDoneUI(player);
      try { window.dispatchEvent(new CustomEvent('tryoutui:done', { detail:{ player_id: player.player_id, tryout_num: player.tryout_num } })); } catch {}
    }

    // ---------- Station → TryoutUI + drills ----------
    function applyGroupFromStation(){
      const sid = stationId();
      if (POS_STATIONS.includes(sid)) GameContext.setGroup(sid);
      else GameContext.setGroup('');
    }

    // ----- Robust roster selection (like other pages) -----
    function resolvePlayerFromObjOrCard(objOrEl){
      // payload object
      if (objOrEl && typeof objOrEl === 'object' && !objOrEl.nodeType) {
        const hit = normalizePlayer(objOrEl);
        return hit || null;
      }
      // DOM card
      const card = objOrEl?.closest?.('.tu-player, .tu-card, [data-player-id]');
      if (!card) return null;

      const pid = card.getAttribute('data-player-id')
                || card.getAttribute('data-id')
                || card.dataset?.playerId
                || card.dataset?.id
                || '';
      const tnum = toTri(
        card.getAttribute('data-tryout-num')
        || card.getAttribute('data-number')
        || card.getAttribute('data-num')
        || card.dataset?.tryoutNum
        || card.dataset?.number
        || ''
      );

      let rec = null;
      if (pid) rec = roster.find(r => String(r.player_id).trim() === String(pid).trim());
      if (!rec && tnum) rec = roster.find(r => toTri(r.tryout_num) === tnum);

      if (!rec) {
        rec = { player_id: pid || '', tryout_num: tnum || '', display_name: (card.getAttribute('data-name') || card.textContent || '').trim() };
      }
      return rec;
    }

    function onTryoutUISelect(e){
      const rec = resolvePlayerFromObjOrCard(e?.detail?.player || e?.detail);
      if (rec) assignToActiveLane(rec);
    }
    window.addEventListener('tryoutui:select', onTryoutUISelect);

    function wireRosterDelegation(){
      const root = document.getElementById('tryout-shared');
      if (!root || root.dataset.boundSelect === '1') return;
      root.dataset.boundSelect = '1';

      root.addEventListener('click', (ev)=>{
        const card = ev.target.closest('.tu-player, .tu-card, [data-player-id]');
        if (!card) return;
        const rec = resolvePlayerFromObjOrCard(card);
        if (rec) {
          assignToActiveLane(rec);
          ev.stopPropagation();
          ev.preventDefault();
        }
      }, true);

      root.addEventListener('keydown', (ev)=>{
        if (ev.key !== 'Enter' && ev.key !== ' ') return;
        const card = ev.target.closest('.tu-player, .tu-card, [data-player-id]');
        if (!card) return;
        const rec = resolvePlayerFromObjOrCard(card);
        if (rec) {
          assignToActiveLane(rec);
          ev.stopPropagation();
          ev.preventDefault();
        }
      }, true);
    }

    // Top-level events
    qs('#coachSelect').addEventListener('change', (e)=> localStorage.setItem('coach_id', e.target.value));
    qs('#stationSelect').addEventListener('change', async ()=>{
      await loadDrills();
      await mountRosterForStation();
      wireRosterDelegation();     // ensure delegation after remount
      applyGroupFromStation();
    });
    qs('#coachDrill').addEventListener('change', ()=>{
      const did = coachDrillId();
      ['A','B','C','D'].forEach(L=>{
        const sel = qs('#drill'+L);
        if (sel && [...sel.options].some(o=>o.value===did)) { sel.value = did; renderCriteriaUI(L); }
      });
    });
    ['A','B','C','D'].forEach(L=> qs('#save'+L).addEventListener('click', ()=> saveLane(L)));

    // ---------- Init ----------
    (async function init(){
      setActiveLane('A');
      await Promise.all([loadCoaches(), loadRoster(), loadLatestGroups(), loadDrills()]);
      await mountRosterForStation();
      wireRosterDelegation();     // initial bind
      applyGroupFromStation();
    })();
  </script>
</body>
</html>
