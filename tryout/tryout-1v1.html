<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="gsds-api-base" content="https://script.google.com/macros/s/AKfycbxCHO9P5zOf_LjEztGUPalzGRweBAr_Y3U9v4iVn9jHir1pB0yueLp22_ltGSTFc6qzfA/exec">
  <title>1v1 Station — Tryouts</title>

  <!-- Simple auth guard -->
  <script>
    (function(){
      const ok = localStorage.getItem('auth_ok')==='1' &&
                 Number(localStorage.getItem('auth_until')||0) > Date.now();
      if(!ok){ window.location.href = '../index.html#login'; }
    })();
  </script>

  <!-- Theme + fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../style.css"/>

  <style>
    .container{ max-width:1100px; margin:0 auto; padding:16px; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    @media (max-width:1000px){ .grid-2{ grid-template-columns:1fr; } }

    .card{ background: rgba(255,255,255,.05); border:1px solid var(--border);
           border-radius:16px; padding:16px; box-shadow: var(--shadow-soft, 0 8px 24px rgba(0,0,0,.18)); }
    .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
           border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06); font-weight:700; }
    .chip.badge{ background:linear-gradient(135deg,#7C4DFF,#8B5CF6); color:#071018; border:0; }
    .chip.ghost{ background:transparent; }

    .seg{ display:inline-flex; background:rgba(255,255,255,.06); border:1px solid var(--border);
          border-radius:10px; overflow:hidden; }
    .seg button{ appearance:none; border:0; padding:6px 10px; font-weight:800; color:#fff; background:transparent; cursor:pointer; }
    .seg button[aria-pressed="true"]{ background:#8B5CF6; color:#071018; }

    .field{ margin:10px 0; }
    .label{ font-weight:800; font-size:.95rem; opacity:.9; margin-bottom:6px; display:block; }
    .form-input, .form-select, .form-number{ width:100%; padding:.68rem .8rem; border-radius:12px; border:1px solid rgba(255,255,255,.28);
      background:rgba(255,255,255,.08); color:#fff; }
    .row{ display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }

    .toggle-switch{ display:inline-flex; align-items:center; gap:10px; cursor:pointer; user-select:none; }
    .toggle-switch input{ position:absolute; opacity:0; width:0; height:0; }
    .toggle-slider{ position:relative; width:50px; height:26px; background:rgba(255,255,255,.15); border-radius:999px; transition:all .3s ease; border:1px solid rgba(255,255,255,.25); }
    .toggle-slider::before{ content:''; position:absolute; width:20px; height:20px; border-radius:50%; background:#fff; top:2px; left:3px; transition:all .3s ease; box-shadow:0 2px 4px rgba(0,0,0,.2); }
    .toggle-switch input:checked + .toggle-slider{ background:linear-gradient(135deg,#16A34A,#10B981); border-color:#16A34A; }
    .toggle-switch input:checked + .toggle-slider::before{ transform:translateX(23px); }
    .toggle-label{ font-weight:700; font-size:.9rem; }

    /* Small timer */
    .timer{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .time{ font-variant-numeric:tabular-nums; font-weight:900; font-size:1.15rem; min-width:70px; text-align:right; }

    .btn{ appearance:none; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.08); color:#fff;
          padding:.55rem .8rem; border-radius:10px; font-weight:800; cursor:pointer; transition: all .2s ease; }
    .btn.primary{ background:linear-gradient(135deg,#7C4DFF,#8B5CF6); color:#071018; border:0; }
    .btn.success{ background:linear-gradient(135deg,#16A34A,#10B981); color:#061710; border:0; }
    .btn.warn{ background:linear-gradient(135deg,#F59E0B,#F59E0B); color:#2A1400; border:0; }
    .btn.ghost{ background:transparent; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn.loading{ position:relative; pointer-events:none; }
    .btn.loading .spin{ width:14px; height:14px; border:2px solid rgba(255,255,255,.45); border-top-color:#fff; border-radius:50%;
                        display:inline-block; margin-right:8px; vertical-align:-2px; animation:spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .status{ margin-top:6px; font-weight:700; }
    .status.ok{ color:#34D399; } .status.err{ color:#F87171; } .status.warn{ color:#F59E0B; }

    /* Hard cap 10 roster cards */
    #tryout-shared ._limit-hide { display:none !important; }
  </style>
</head>

<body class="theme-atl practice-page">
  <header class="page-header">
    <h1>1v1 Station</h1>
    <nav class="menu-actions">
      <a class="menu-btn" href="../index.html">Home</a>
      <a class="menu-btn" href="../tryout/index.html">Tryout Hub</a>
    </nav>
  </header>

  <main>
    <div class="container">
      <!-- Shared: context bar, filter chips, roster cards -->
      <div id="tryout-shared" style="margin-bottom:12px"></div>

      <!-- Assignment -->
      <section class="card" style="margin-bottom:14px">
        <div class="toolbar">
          <span class="chip">Station: <strong>1v1</strong></span>

          <div class="seg" role="tablist" aria-label="Assign selected roster card to role">
            <button id="segOff" role="tab" aria-pressed="true">Offense</button>
            <button id="segDef" role="tab" aria-pressed="false">Defense</button>
            <button id="segQB"  role="tab" aria-pressed="false">QB</button>
          </div>

          <span class="chip ghost small" style="margin-left:auto">Tip: click roster card or search → assigns to active role.</span>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label class="label">Search Player (number or name)</label>
            <input id="playerPicker" class="form-input" list="onevone_roster" placeholder="e.g., 1 • Carter Hall"/>
            <datalist id="onevone_roster"></datalist>
          </div>
          <div>
            <label class="label">Notes</label>
            <input id="notes" class="form-input" placeholder="release, leverage, placement, etc."/>
          </div>
        </div>

        <div class="toolbar" style="gap:10px; margin-top:10px;">
          <span id="whoOff" class="chip badge" style="display:none"></span>
          <span id="whoDef" class="chip badge" style="display:none"></span>
          <span id="whoQB"  class="chip" style="display:none"></span>
        </div>
      </section>

      <!-- Rep form (aligned to 72_Fact_Tryout_1v1 columns) -->
      <section class="card">
        <div class="row3">
          <div>
            <label class="label">Matchup Type</label>
            <select id="matchupType" class="form-select">
              <option>WR-DB</option>
              <option>TE-DB</option>
              <option>RB-LB</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label class="label">Route / Rush</label>
            <input id="routeOrRush" class="form-input" list="routes_list" placeholder="Slant, Fade, Out, In, Post, Corner, Go, Comeback, Curl, Dig, Screen, Rush"/>
            <datalist id="routes_list">
              <option>Slant</option><option>Fade</option><option>Out</option><option>In</option>
              <option>Post</option><option>Corner</option><option>Go</option><option>Comeback</option>
              <option>Curl</option><option>Dig</option><option>Screen</option><option>Rush</option>
            </datalist>
          </div>
          <div>
            <label class="label">Win Side</label>
            <div class="seg" style="width:100%">
              <button data-win="offense" class="wbtn" aria-pressed="true">Offense</button>
              <button data-win="defense" class="wbtn" aria-pressed="false">Defense</button>
              <button data-win="tie"     class="wbtn" aria-pressed="false">Tie</button>
            </div>
          </div>
        </div>

        <div class="row3">
          <div>
            <label class="label">Targeted</label>
            <label class="toggle-switch"><input id="targeted" type="checkbox"><span class="toggle-slider"></span><span class="toggle-label">Yes</span></label>
          </div>
          <div>
            <label class="label">Catch</label>
            <label class="toggle-switch"><input id="catch" type="checkbox"><span class="toggle-slider"></span><span class="toggle-label">Yes</span></label>
          </div>
          <div>
            <label class="label">PBU</label>
            <label class="toggle-switch"><input id="pbu" type="checkbox"><span class="toggle-slider"></span><span class="toggle-label">Yes</span></label>
          </div>
        </div>

        <div class="row3">
          <div>
            <label class="label">INT</label>
            <label class="toggle-switch"><input id="int" type="checkbox"><span class="toggle-slider"></span><span class="toggle-label">Yes</span></label>
          </div>
          <div>
            <label class="label">Separation (1–5)</label>
            <input id="sep" type="range" min="1" max="5" step="1" value="3" class="form-input" oninput="document.getElementById('sepVal').textContent=this.value">
            <div class="small">Value: <strong id="sepVal">3</strong></div>
          </div>
          <div>
            <label class="label">Yards (est.)</label>
            <input id="yards" class="form-number" type="number" step="1" placeholder="e.g., 12"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label class="label">Time to Release (sec)</label>
            <div class="timer">
              <span class="time" id="tPress">0.00</span>
              <button class="btn" id="pressToggle" aria-pressed="false">Start</button>
              <button class="btn ghost" id="pressReset">Reset</button>
            </div>
          </div>
          <div style="display:flex; align-items:flex-end; gap:8px; justify-content:flex-end">
            <button id="saveBtn" class="btn success" disabled>Save 1v1 Rep</button>
          </div>
        </div>

        <div class="status" id="status"></div>
      </section>

      <!-- Recent writes -->
      <section class="card" style="margin-top:14px">
        <div class="toolbar">
          <button id="toggleRecent" class="btn ghost">Recent Writes ▾</button>
          <span id="recentCount" class="small muted"></span>
        </div>
        <div id="recentPanel" style="display:none; margin-top:8px">
          <ul id="recentList" style="margin:0; padding-left:18px"></ul>
        </div>
      </section>
    </div>
  </main>

  <footer class="site-footer"><p>&copy; 2025 Game Speed Data Systems</p></footer>

  <!-- libs -->
  <script src="../js/api.js"></script>
  <script src="../js/rules.js"></script>
  <script src="../js/context.js"></script>
  <script src="../js/tryout-ui.js"></script>

  <script>
    // ---------- Boot shared context/UI ----------
    (function(){
      const meta = document.querySelector('meta[name="gsds-api-base"]');
      window.API_BASE = (meta && meta.content || '').trim();
    })();
    GameContext.configure({ apiBase: window.API_BASE, server: true, pollMs: 1000 });

    // Show roster grid + chips; hard-cap visible cards to 10
    TryoutUI.init('#tryout-shared', {
      showGroup: true,
      showRoster: true,        // <- render roster grid
      filterMode: 'groups',
      allowPresence: false,
      pageSize: 10,
      maxCards: 10
    });

    // Start unfiltered so cards appear immediately
    GameContext.setGroup('ALL');

    // Hard clamp to 10 even if internal paging changes
    const CARD_SEL = '#tryout-shared .tu-player, #tryout-shared [data-role="roster-card"], #tryout-shared .roster-card';
    const clampRosterCards = ()=>{
      const cards = document.querySelectorAll(CARD_SEL);
      cards.forEach((el, i) => el.classList.toggle('_limit-hide', i >= 10));
    };
    new MutationObserver(clampRosterCards)
      .observe(document.getElementById('tryout-shared'), { childList:true, subtree:true });
    window.addEventListener('tryoutui:filter', clampRosterCards);
    window.addEventListener('tryoutui:roster', clampRosterCards);
    window.addEventListener('tryoutui:ready', clampRosterCards);
    setTimeout(clampRosterCards, 400);

    // ---------- Page State ----------
    const STATION_ID = '1v1';
    const lane = { offense:null, defense:null, qb:null };
    let activeRole = 'offense';

    let roster = [];
    const groupLatest = new Map();
    const pageLog = [];
    const PAGE_LOG_LIMIT = 12;

    // ------- helpers -------
    const qs  = (s,p=document)=>p.querySelector(s);
    const labelFor = (r)=> [r.tryout_num, '•', r.display_name, r.primary_pos?`(${r.primary_pos})`:'' ].filter(Boolean).join(' ');
    const fmtTime = (d)=>{ const pad=n=>String(n).padStart(2,'0'); return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; };
    function ctx(){ return GameContext.get ? GameContext.get() : {}; }

    async function loadRoster(){
      const res = await API.tryout.read.roster();
      if(!res?.ok) return;
      const tid = ctx().tryout_id || '';
      roster = (res.roster||[]).filter(r => !tid || String(r.tryout_id||'')===String(tid))
        .map(r => ({
          player_id: r.player_id || '',
          display_name: r.display_name || r.player_name || '',
          primary_pos: r.primary_pos || r.position || '',
          tryout_num: r.tryout_num || r.jersey_number || '',
          group_code: r.group_code || r.primary_pos || ''
        }));
      const dl = document.getElementById('onevone_roster');
      dl.innerHTML = '';
      roster.forEach(rec=>{
        const opt = document.createElement('option');
        opt.value = labelFor(rec);
        opt.dataset.pid = rec.player_id;
        dl.appendChild(opt);
      });
    }

    async function loadLatestGroups(){
      const res = await API.tryout.read.groupsLatest(ctx().tryout_id);
      if(!res?.ok || !Array.isArray(res.latest)) return;
      groupLatest.clear();
      res.latest.forEach(row => { if(row.player_id && row.group_code) groupLatest.set(String(row.player_id).trim(), String(row.group_code).trim()); });
    }
    function resolveGroupCode(pid, fallback, rec){
      if (pid) {
        const direct = groupLatest.get(String(pid).trim());
        if (direct) return direct;
        const r = roster.find(x => String(x.player_id).trim() === String(pid).trim());
        return r?.group_code || r?.primary_pos || fallback || '';
      }
      return rec?.group_code || rec?.primary_pos || fallback || '';
    }

    function setRole(role){
      activeRole = role;
      ['segOff','segDef','segQB'].forEach(id=>{
        const pressed = (id==='segOff' && role==='offense') || (id==='segDef' && role==='defense') || (id==='segQB' && role==='qb');
        document.getElementById(id).setAttribute('aria-pressed', pressed?'true':'false');
      });
    }
    document.getElementById('segOff').onclick = ()=> setRole('offense');
    document.getElementById('segDef').onclick = ()=> setRole('defense');
    document.getElementById('segQB').onclick  = ()=> setRole('qb');

    // Timer for pressure
    function makeTimer(timeEl, onState){
      let running=false, t0=0, acc=0, raf=null;
      const fmt = ms => (ms/1000).toFixed(2);
      const tick = ()=>{ const now=performance.now(); const ms=acc + (running ? (now-t0) : 0); timeEl.textContent = fmt(ms); if(running) raf=requestAnimationFrame(tick); };
      const start = ()=>{ if(running) return; running=true; t0=performance.now(); tick(); onState?.(true); };
      const stop  = ()=>{ if(!running) return; running=false; acc += performance.now()-t0; cancelAnimationFrame(raf); tick(); onState?.(false); };
      const reset = ()=>{ running=false; acc=0; cancelAnimationFrame(raf); tick(); onState?.(false); };
      const toggle= ()=> running ? stop() : start();
      tick();
      return { start, stop, reset, toggle, isRunning:()=>running, read:()=>parseFloat(timeEl.textContent||'0') };
    }
    const pressTimer = makeTimer(document.getElementById('tPress'), (running)=>{
      const btn = document.getElementById('pressToggle');
      btn.textContent = running ? 'Stop' : 'Start';
      btn.setAttribute('aria-pressed', running ? 'true' : 'false');
      btn.classList.toggle('warn', running);
    });
    document.getElementById('pressToggle').onclick = pressTimer.toggle;
    document.getElementById('pressReset').onclick  = pressTimer.reset;

    // Win side segmented
    let winSide = 'offense';
    document.querySelectorAll('.wbtn').forEach(b=>{
      b.addEventListener('click', ()=>{
        winSide = b.getAttribute('data-win');
        document.querySelectorAll('.wbtn').forEach(x=> x.setAttribute('aria-pressed', x===b?'true':'false'));
      });
    });

    // Assign selection to active role
    function renderWho(){
      const badge = (el, rec, label) => {
        if(!rec){ el.style.display='none'; return; }
        const txt = `${rec.tryout_num||''} • ${rec.display_name}${rec.primary_pos?` (${rec.primary_pos})`:''}`;
        el.textContent = `${label}: ${txt}`; el.style.display='';
      };
      badge(document.getElementById('whoOff'), lane.offense, 'Offense');
      badge(document.getElementById('whoDef'), lane.defense, 'Defense');
      badge(document.getElementById('whoQB'),  lane.qb,      'QB');
      document.getElementById('saveBtn').disabled = !(lane.offense && lane.defense);
    }
    function assignToActiveRole(rec){
      lane[activeRole] = rec;
      document.getElementById('playerPicker').value = labelFor(rec);
      renderWho();
    }

    // From roster cards
    window.addEventListener('tryoutui:select', (e)=>{
      const d = e?.detail?.player; if(!d) return;
      const hit = roster.find(r => r.player_id===d.player_id) || d;
      assignToActiveRole(hit);
    });
    // Search box
    document.getElementById('playerPicker').addEventListener('change', (e)=>{
      const txt = (e.target.value||'').toLowerCase();
      const hit = roster.find(r => labelFor(r).toLowerCase() === txt) ||
                  roster.find(r => String(r.tryout_num||'').toLowerCase() === txt) ||
                  roster.find(r => String(r.display_name||'').toLowerCase() === txt);
      if(hit) assignToActiveRole(hit);
    });

    // ----- Recent writes (bottom) -----
    function addRecent(summary){
      pageLog.unshift({ ts:new Date(), summary });
      pageLog.splice(PAGE_LOG_LIMIT);
      const ul = qs('#recentList');
      const cnt = qs('#recentCount');
      ul.innerHTML = pageLog.map(it => `<li><strong>${fmtTime(it.ts)}</strong> — ${it.summary}</li>`).join('');
      cnt.textContent = pageLog.length ? `${pageLog.length} item${pageLog.length===1?'':'s'}` : '';
    }
    document.getElementById('toggleRecent').addEventListener('click', ()=>{
      const p = document.getElementById('recentPanel');
      const open = p.style.display !== 'none';
      p.style.display = open ? 'none' : '';
      document.getElementById('toggleRecent').textContent = open ? 'Recent Writes ▾' : 'Recent Writes ▴';
    });

    // Mutually-helpful toggles
    document.getElementById('catch').addEventListener('change', (e)=>{
      if (e.target.checked){ document.getElementById('pbu').checked=false; document.getElementById('int').checked=false; }
    });
    document.getElementById('int').addEventListener('change', (e)=>{
      if (e.target.checked){ document.getElementById('catch').checked=false; }
    });

    // Save
    async function saveRep(){
      const statusEl = document.getElementById('status');
      statusEl.textContent = '';
      const c = ctx();
      if(!c.tryout_id){ statusEl.textContent='Set a Tryout ID first.'; statusEl.className='status warn'; return; }
      if(!(lane.offense && lane.defense)){ statusEl.textContent='Assign Offense and Defense.'; statusEl.className='status warn'; return; }

      if (pressTimer.isRunning()) pressTimer.toggle();

      const row = {
        // REQUIRED: exact columns for 72_Fact_Tryout_1v1
        timestamp: new Date().toISOString(),
        tryout_id: c.tryout_id || '',
        period_code: c.period_code || '',
        offense_id: String(lane.offense.player_id||'').trim(),
        offense_group: resolveGroupCode(lane.offense.player_id,'', lane.offense) || '',
        defense_id: String(lane.defense.player_id||'').trim(),
        defense_group: resolveGroupCode(lane.defense.player_id,'', lane.defense) || '',
        qb_id: lane.qb ? String(lane.qb.player_id||'').trim() : '',
        matchup_type: (document.getElementById('matchupType').value||'').trim(),
        route_or_rush: (document.getElementById('routeOrRush').value||'').trim(),
        targeted: document.getElementById('targeted').checked ? 1 : 0,
        catch:    document.getElementById('catch').checked ? 1 : 0,
        pbu:      document.getElementById('pbu').checked ? 1 : 0,
        int:      document.getElementById('int').checked ? 1 : 0,
        separation_1_5: Number(document.getElementById('sep').value||3),
        time_to_pressure_sec: Number(pressTimer.read()||0),
        win_side: winSide, // offense | defense | tie
        yards_est: (function(v){ const n=parseFloat(v); return isNaN(n)?'':n; })(document.getElementById('yards').value),
        notes: (document.getElementById('notes').value||'').trim(),

        // helpful extras (ignored by sheet if not mapped)
        source_app: 'station-1v1',
        client_id: (localStorage.getItem('client_id')||'web')
      };

      const saveBtn = document.getElementById('saveBtn');
      if (!saveBtn.dataset.label) saveBtn.dataset.label = saveBtn.textContent;

      const setSaving = (s)=>{
        if (s){
          saveBtn.classList.add('loading'); saveBtn.disabled=true;
          saveBtn.innerHTML = '<span class="spin"></span>Saving…';
        } else {
          saveBtn.classList.remove('loading'); saveBtn.disabled=false;
          saveBtn.textContent = saveBtn.dataset.label;
        }
      };

      setSaving(true);
      let res;
      try {
        if (API?.tryout?.write?.onevone) {
          res = await API.tryout.write.onevone(row);
        } else {
          res = await API.tryout.write.station({ station_id: STATION_ID, ...row });
        }
      } catch(e){
        res = { ok:false, error: e?.message || 'Error' };
      } finally {
        setSaving(false);
      }

      if(!res?.ok){
        statusEl.textContent = res?.error || 'Save failed.';
        statusEl.className='status err';
        return;
      }

      addRecent(`1v1 • ${lane.offense.tryout_num||lane.offense.player_id} vs ${lane.defense.tryout_num||lane.defense.player_id} • ${row.matchup_type} • ${row.route_or_rush || '—'} • ${row.win_side} • tgt:${row.targeted} catch:${row.catch} pbu:${row.pbu} int:${row.int} • sep ${row.separation_1_5} • pr ${row.time_to_pressure_sec.toFixed(2)}s • yds ${row.yards_est||'—'}`);

      try { TryoutUI?.markDone?.(lane.offense.player_id || lane.offense.tryout_num); } catch {}
      try { TryoutUI?.markDone?.(lane.defense.player_id || lane.defense.tryout_num); } catch {}

      // soft reset toggles & pressure timer, keep players
      ['targeted','catch','pbu','int'].forEach(id=> document.getElementById(id).checked=false);
      document.getElementById('sep').value = '3'; document.getElementById('sepVal').textContent='3';
      document.getElementById('yards').value = '';
      document.getElementById('routeOrRush').value = '';
      pressTimer.reset();
      document.getElementById('notes').value = '';

      statusEl.textContent = 'Saved ✔';
      statusEl.className='status ok';
    }

    document.getElementById('saveBtn').addEventListener('click', saveRep);

    // Init
    (async function init(){
      setRole('offense');
      await Promise.all([ loadRoster(), loadLatestGroups() ]);

      // preload if TryoutUI has a current selection
      if (window.TryoutUI?.getSelectedPlayers) {
        const cur = TryoutUI.getSelectedPlayers();
        if (Array.isArray(cur) && cur[0]) assignToActiveRole(cur[0]);
      }
      renderWho();
    })();
  </script>
</body>
</html>
