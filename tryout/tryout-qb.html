<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="gsds-api-base" content="https://script.google.com/macros/s/AKfycbxCHO9P5zOf_LjEztGUPalzGRweBAr_Y3U9v4iVn9jHir1pB0yueLp22_ltGSTFc6qzfA/exec">
  <title>QB Station — Tryouts</title>

  <!-- Simple auth guard -->
  <script>
    (function(){
      const ok = localStorage.getItem('auth_ok')==='1' &&
                 Number(localStorage.getItem('auth_until')||0) > Date.now();
      if(!ok){ window.location.href = '../index.html#login'; }
    })();
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../style.css"/>

  <style>
    .container{ max-width:1100px; margin:0 auto; padding:16px; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    @media (max-width:900px){ .grid-2{ grid-template-columns:1fr; } }

    .card{ background: rgba(255,255,255,.05); border:1px solid var(--border);
           border-radius:16px; padding:16px; box-shadow: var(--shadow-soft, 0 8px 24px rgba(0,0,0,.18)); }
    .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
           border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06); font-weight:700; }
    .chip.badge{ background:linear-gradient(135deg,#7C4DFF,#8B5CF6); color:#071018; border:0; }
    .chip.ghost{ background:transparent; }

    .assign{ display:flex; align-items:center; gap:8px; margin-left:auto; }
    .seg{ display:inline-flex; background:rgba(255,255,255,.06); border:1px solid var(--border); border-radius:10px; overflow:hidden; }
    .seg button{ appearance:none; border:0; padding:6px 10px; font-weight:800; color:#fff; background:transparent; cursor:pointer; }
    .seg button[aria-pressed="true"]{ background:#8B5CF6; color:#071018; }

    .field{ margin:10px 0; }
    .label{ font-weight:800; font-size:.95rem; opacity:.9; margin-bottom:6px; display:block; }
    .form-input, .form-select{ width:100%; padding:.68rem .8rem; border-radius:12px; border:1px solid rgba(255,255,255,.28);
      background:rgba(255,255,255,.08); color:#fff; }
    .row{ display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
    .row3{ display:grid; grid-template-columns: 1fr; gap:12px; }

    .timer{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .time{ font-variant-numeric:tabular-nums; font-weight:900; font-size:1.25rem; min-width:82px; text-align:right; }

    .btn{ appearance:none; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.08); color:#fff;
          padding:.55rem .8rem; border-radius:10px; font-weight:800; cursor:pointer; transition: all .2s ease; }
    .btn.primary{ background:linear-gradient(135deg,#7C4DFF,#8B5CF6); color:#071018; border:0; }
    .btn.success{ background:linear-gradient(135deg,#16A34A,#10B981); color:#061710; border:0; }
    .btn.warn{ background:linear-gradient(135deg,#F59E0B,#F59E0B); color:#2A1400; border:0; }
    .btn.ghost{ background:transparent; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    /* Counter control */
    .counter-control { display:flex; align-items:center; gap:8px; }
    .counter-btn {
      width: 40px; height: 40px; display:flex; align-items:center; justify-content:center;
      border-radius: 8px; border: 1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.08); color:#fff; font-size:20px; font-weight:800;
      cursor:pointer; transition: all .2s ease; user-select:none;
    }
    .counter-btn:hover { background: rgba(255,255,255,.15); transform: scale(1.05); }
    .counter-btn:active { transform: scale(0.95); }
    .counter-value { min-width:60px; text-align:center; font-size:24px; font-weight:900; color:#C4B5FD; font-variant-numeric:tabular-nums; }

    /* Rate display (calculated percentage) */
    .rate-display { margin-top:8px; padding:8px 12px; background:rgba(139,92,246,.15);
      border:1px solid rgba(139,92,246,.3); border-radius:8px; text-align:center; }
    .rate-value { font-size:28px; font-weight:900; color:#C4B5FD; font-variant-numeric:tabular-nums; }
    .rate-label { font-size:11px; opacity:.7; margin-top:2px; }

    /* Save indicator */
    .btn.loading{ position:relative; pointer-events:none; }
    .btn.loading .spin{ width:14px; height:14px; border:2px solid rgba(255,255,255,.45);
                        border-top-color:#fff; border-radius:50%; display:inline-block;
                        margin-right:8px; vertical-align:-2px; animation:spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .lane-title{ display:flex; align-items:center; justify-content:space-between; gap:10px; font-weight:900; letter-spacing:.04em; opacity:.9; }
    .lane-chip{ display:inline-flex; align-items:center; gap:8px; padding:4px 8px; border-radius:999px;
                border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08); font-weight:800; font-size:.9rem; }
    .lane-chip .x{ opacity:.7; cursor:pointer; padding:0 .25rem; }

    .lane-card{ transition: box-shadow .15s ease, border-color .15s ease; }
    .lane-card.lane-active{ border-color:#8B5CF6; box-shadow:0 0 0 2px rgba(139,92,246,.35) inset; }

    .small{ font-size:.85rem; opacity:.8; }
    .status{ margin-top:8px; font-weight:700; }
    .status.ok{ color:#34D399; } 
    .status.err{ color:#F87171; } 
    .status.warn{ color:#F59E0B; }
    .status.avg{ color:#8B5CF6; }

    .table{ width:100%; border-collapse:collapse; font-size:.95rem; }
    .table th,.table td{ padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.12); text-align:left; }

    .muted{ opacity:.75; }

    .rating-above{ background:linear-gradient(135deg,#16A34A,#10B981); color:#061710; padding:4px 8px; border-radius:6px; font-weight:800; font-size:11px; }
    .rating-avg{ background:linear-gradient(135deg,#8B5CF6,#A78BFA); color:#071018; padding:4px 8px; border-radius:6px; font-weight:800; font-size:11px; }
    .rating-below{ background:linear-gradient(135deg,#DC2626,#EF4444); color:#fff; padding:4px 8px; border-radius:6px; font-weight:800; font-size:11px; }

    .measure-help { font-size:11px; opacity:.7; font-weight:500; margin-top:2px; font-style:italic; }
  </style>
</head>

<body class="theme-atl practice-page">
  <header class="page-header">
    <h1>QB Station</h1>
    <nav class="menu-actions">
      <a class="menu-btn" href="../index.html">Home</a>
      <a class="menu-btn" href="../tryout/index.html">Tryout Hub</a>
    </nav>
  </header>

  <main>
    <div class="container">
      <div id="tryout-shared" style="margin-bottom:12px"></div>

      <section class="card" style="margin-bottom:14px">
        <div class="toolbar">
          <span class="chip">Station: <strong>QB</strong></span>

          <div class="field" style="min-width:280px; margin:0;">
            <label class="label">QB Drill</label>
            <select id="qbDrillSel" class="form-select"></select>
            <div id="qbDrillHint" class="small muted" style="margin-top:6px"></div>
          </div>

          <span id="drillBadge" class="chip badge">Drill: —</span>

          <div class="assign" style="margin-left:auto">
            <span class="chip ghost small">Assign selection to:</span>
            <div class="seg" role="tablist" aria-label="Active lane">
              <button id="segA" role="tab" aria-pressed="true">Lane A</button>
              <button id="segB" role="tab" aria-pressed="false">Lane B</button>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label class="label">Player (search by number or name)</label>
            <input id="playerPicker" class="form-input" list="qb_roster" placeholder="e.g., 12 • Jordan Price"/>
            <datalist id="qb_roster"></datalist>
          </div>
          <div>
            <label class="label">Notes (optional, applies to next save)</label>
            <input id="sharedNotes" class="form-input" placeholder="hash L, windy, wet ball, etc."/>
          </div>
        </div>

        <div class="toolbar" style="margin-top:10px;gap:12px">
          <span id="chipLaneA" class="lane-chip" style="display:none"></span>
          <span id="chipLaneB" class="lane-chip" style="display:none"></span>
          <span class="small muted">Time drills use a timer; rate drills use two simple counters. Attempts auto-calc.</span>
        </div>
      </section>

      <section class="grid-2">
        <!-- LANE A -->
        <div id="laneA" class="card lane-card lane-active">
          <div class="lane-title">
            <span>Lane A</span>
            <span id="laneAWho" class="lane-chip" style="display:none"></span>
          </div>

          <div class="row3 field">
            <div>
              <label class="label">Attempt</label>
              <select id="aAttempt" class="form-select">
                <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
                <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
              </select>
            </div>
          </div>

          <div class="field">
            <div id="aTimerBlock">
              <label class="label">Primary: <span id="aPrimaryLabel">Time</span></label>
              <div class="measure-help" id="aPrimaryHelp"></div>
              <div class="timer">
                <span class="time" id="aTime">0.00</span><span class="small muted">sec</span>
                <button class="btn" id="aToggle" aria-pressed="false">Start</button>
                <button class="btn ghost" id="aReset">Reset</button>
              </div>
            </div>
            <div id="aInputsBlock" style="display:none; margin-top:8px"></div>
            <div style="margin-top:8px">
              <button class="btn success" id="aSave" disabled>Save Attempt (A)</button>
            </div>
          </div>

          <div class="status" id="aStatus"></div>

          <table class="table" style="margin-top:10px">
            <thead id="aHead"><tr><th>Drill</th><th>Att</th><th>Primary</th><th>Secondary</th><th>Rating</th></tr></thead>
            <tbody id="aLog"></tbody>
          </table>
        </div>

        <!-- LANE B -->
        <div id="laneB" class="card lane-card">
          <div class="lane-title">
            <span>Lane B</span>
            <span id="laneBWho" class="lane-chip" style="display:none"></span>
          </div>

          <div class="row3 field">
            <div>
              <label class="label">Attempt</label>
              <select id="bAttempt" class="form-select">
                <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
                <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
              </select>
            </div>
          </div>

          <div class="field">
            <div id="bTimerBlock">
              <label class="label">Primary: <span id="bPrimaryLabel">Time</span></label>
              <div class="measure-help" id="bPrimaryHelp"></div>
              <div class="timer">
                <span class="time" id="bTime">0.00</span><span class="small muted">sec</span>
                <button class="btn" id="bToggle" aria-pressed="false">Start</button>
                <button class="btn ghost" id="bReset">Reset</button>
              </div>
            </div>
            <div id="bInputsBlock" style="display:none; margin-top:8px"></div>
            <div style="margin-top:8px">
              <button class="btn success" id="bSave" disabled>Save Attempt (B)</button>
            </div>
          </div>

          <div class="status" id="bStatus"></div>

          <table class="table" style="margin-top:10px">
            <thead id="bHead"><tr><th>Drill</th><th>Att</th><th>Primary</th><th>Secondary</th><th>Rating</th></tr></thead>
            <tbody id="bLog"></tbody>
          </table>
        </div>
      </section>

      <section id="bothStartCard" class="card" style="margin-top:8px; display:none">
        <div class="toolbar" style="justify-content:center">
          <button id="bothStart" class="btn primary">Start Both</button>
        </div>
      </section>

      <section class="card" style="margin-top:14px">
        <div class="toolbar">
          <button id="toggleRecent" class="btn ghost">Recent Writes ▾</button>
          <span id="recentCount" class="small muted"></span>
        </div>
        <div id="recentPanel" style="display:none; margin-top:8px">
          <ul id="recentList" style="margin:0; padding-left:18px"></ul>
        </div>
      </section>

    </div>
  </main>

  <footer class="site-footer"><p>&copy; 2025 Game Speed Data Systems</p></footer>

  <!-- libs -->
  <script src="../js/api.js"></script>
  <script src="../js/rules.js"></script>
  <script src="../js/context.js"></script>
  <script src="../js/tryout-ui.js"></script>

  <script>
    // API base + context
    (function(){
      const meta = document.querySelector('meta[name="gsds-api-base"]');
      window.API_BASE = (meta && meta.content || '').trim();
    })();
    GameContext.configure({ apiBase: window.API_BASE, server: true, pollMs: 1000 });

    // Shared tryout header
    TryoutUI.init('#tryout-shared', { showGroup:true, filterMode:'groups', allowPresence:false });
    GameContext.setGroup('QB');

    // Station constants
    const STATION_ID = 'QB';
    const AFTER_SAVE = { clearLane:false, markDone:true };

    // Identify this device/app in the sheet (aligns with RB page)
    const SOURCE_APP = 'web.tryout.station';
    const CLIENT_ID  = (localStorage.client_id ||= (self.crypto?.randomUUID?.() || String(Date.now())));

    // State
    let roster = [];
    const groupLatest = new Map();
    const pageLog = [];
    const PAGE_LOG_LIMIT = 12;

    const lanePlayers = { A:null, B:null };
    let activeLane = 'A';
    const timers = new Map();
    let QB_DRILLS = [], QB_CURR = null;

    // utils
    const qs  = (s,p=document)=>p.querySelector(s);
    const qsa = (s,p=document)=>[...p.querySelectorAll(s)];
    const labelFor = (r)=> [r.tryout_num,'•',r.display_name, r.primary_pos?`(${r.primary_pos})`:'' ].filter(Boolean).join(' ');
    function ctx(){ return GameContext.get ? GameContext.get() : {}; }
    const fmtTime = (d)=>{ const pad=n=>String(n).padStart(2,'0'); return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; };
    const isTimeDrill = d => /sec/i.test(String(d?.measurement_unit||''));
    const isRateDrill = d => /percentage|percent|rate/i.test(String(d?.measurement_unit||'')) || String(d?.drill_type||'').toUpperCase()==='RATE';
    const pretty = s => String(s||'').replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());

    // labels
    function successLabelFor(meas){
      const m=String(meas||'').toLowerCase();
      if(m.includes('completion')) return 'Completions';
      if(m.includes('accuracy')) return 'On-target';
      if(m.includes('catch')) return 'Catches';
      if(m.includes('on_time')) return 'On-time';
      if(m.includes('success')) return 'Successes';
      return 'Good reps';
    }
    function failureLabelFor(meas){
      const m=String(meas||'').toLowerCase();
      if(m.includes('completion')) return 'Incompletions';
      if(m.includes('accuracy')) return 'Misses';
      if(m.includes('interception')) return 'Interceptions';
      if(m.includes('sack')) return 'Sacks';
      if(m.includes('error')) return 'Errors';
      return 'Bad reps';
    }

    // thresholds / evaluation
    function parseThreshold(str){
      if (!str) return null;
      const s=String(str).trim();
      const r=s.match(/^(-?\d+(?:\.\d+)?)\s*[-–]\s*(-?\d+(?:\.\d+)?)$/);
      if(r) return {type:'range',min:parseFloat(r[1]),max:parseFloat(r[2])};
      const c=s.match(/^(<=|>=|<|>|=|≤|≥)\s*(-?\d+(?:\.\d+)?)$/);
      if(c){ const op=c[1].replace('≤','<=').replace('≥','>=');
        return {type:'comp',op,value:parseFloat(c[2])}; }
      if(!isNaN(parseFloat(s))) return {type:'comp',op:'>=',value:parseFloat(s)};
      return null;
    }
    function meets(th,v){
      if(!th||v==null) return null;
      if(th.type==='range') return v>=th.min && v<=th.max;
      if(th.type==='comp'){
        switch(th.op){case'<=':return v<=th.value;case'>=':return v>=th.value;case'<':return v<th.value;case'>':return v>th.value;case'=':return v===th.value;}
      }
      return null;
    }
    function evaluateDrill(drill, p1, p2){
      const ok = meets(parseThreshold(drill.success_threshold), p1);
      const bad= meets(parseThreshold(drill.failure_threshold), p1);

      // If secondary is just an attempts goal, ignore it for rating
      const ignoreSecondary = isRateDrill(drill) && /attempt/i.test(String(drill.secondary_measurement||''));
      const secOk = ignoreSecondary ? true : (drill.secondary_threshold ? meets(parseThreshold(drill.secondary_threshold), p2) : true);

      if(ok && secOk) return {rating:'above', ratingText:'Above Average', ratingClass:'rating-above'};
      if(bad || !secOk) return {rating:'below', ratingText:'Below Average', ratingClass:'rating-below'};
      return {rating:'average', ratingText:'Average', ratingClass:'rating-avg'};
    }

    // timers
    function makeTimer(el,onState){
      let running=false,t0=0,acc=0,raf=null;
      const fmt=ms=>(ms/1000).toFixed(2);
      const tick=()=>{ const now=performance.now(); const ms=acc+(running?(now-t0):0); el.textContent=fmt(ms); if(running) raf=requestAnimationFrame(tick); };
      const start=()=>{ if(running) return; running=true; t0=performance.now(); tick(); onState?.(true); };
      const stop=()=>{ if(!running) return; running=false; acc+=performance.now()-t0; cancelAnimationFrame(raf); tick(); onState?.(false); };
      const reset=()=>{ running=false; acc=0; cancelAnimationFrame(raf); tick(); onState?.(false); };
      const toggle=()=>running?stop():start();
      tick(); return {start,stop,reset,toggle,isRunning:()=>running};
    }

    // roster datalist
    async function loadRoster(){
      const res = await API.tryout.read.roster();
      if(!res?.ok) return;
      const tid = ctx().tryout_id || '';
      roster = (res.roster||[]).filter(r => !tid || String(r.tryout_id||'')===String(tid));
      const dl = document.getElementById('qb_roster'); dl.innerHTML='';
      roster.forEach(r=>{
        const rec={ player_id:r.player_id||'', display_name:r.display_name||r.player_name||'', primary_pos:r.primary_pos||r.position||'', tryout_num:r.tryout_num||r.jersey_number||'', group_code:r.group_code||r.primary_pos||'' };
        const opt=document.createElement('option'); opt.value=labelFor(rec); opt.dataset.pid=rec.player_id; dl.appendChild(opt);
      });
    }
    async function loadLatestGroups(){
      const res = await API.tryout.read.groupsLatest(ctx().tryout_id);
      if(!res?.ok || !Array.isArray(res.latest)) return;
      groupLatest.clear();
      res.latest.forEach(row=>{ if(row.player_id&&row.group_code) groupLatest.set(String(row.player_id).trim(), String(row.group_code).trim()); });
    }
    function resolveGroupCode(pid, fallback, rec){
      if(pid){ const direct=groupLatest.get(String(pid).trim()); if(direct) return direct;
        const r=roster.find(x=>String(x.player_id).trim()===String(pid).trim()); return r?.group_code||r?.primary_pos||fallback||''; }
      return rec?.group_code||rec?.primary_pos||fallback||'';
    }

    // lane UI
    function setActiveLane(l){
      activeLane = (l==='B') ? 'B' : 'A';
      document.getElementById('segA').setAttribute('aria-pressed', activeLane==='A' ? 'true':'false');
      document.getElementById('segB').setAttribute('aria-pressed', activeLane==='B' ? 'true':'false');
      qs('#laneA').classList.toggle('lane-active', activeLane==='A');
      qs('#laneB').classList.toggle('lane-active', activeLane==='B');
    }
    document.getElementById('segA').addEventListener('click', ()=> setActiveLane('A'));
    document.getElementById('segB').addEventListener('click', ()=> setActiveLane('B'));
    qs('#laneA').addEventListener('click', ()=> setActiveLane('A'));
    qs('#laneB').addEventListener('click', ()=> setActiveLane('B'));

    function softResetLane(lane){
      const p = lane==='A' ? 'a' : 'b';
      qs(`#${p}Time`).textContent='0.00';
      const t=timers.get(p); t&&t.reset();
      const box=qs(`#${p}InputsBlock`);
      if(box){
        box.querySelectorAll('[data-counter-value]').forEach(el=> el.textContent='0');
        box.querySelectorAll('.rate-display .rate-value').forEach(el=> el.textContent='0%');
        box.querySelectorAll('[id$="SuccCount"], [id$="AttCount"]').forEach(el=> el.textContent='0');
      }
      qs(`#${p}Status`).textContent='';
    }
    function hardResetLane(lane){
      const p=lane==='A'?'a':'b';
      qs(`#${p}Attempt`).value='1';
      qs(`#${p}Log`).innerHTML='';
      softResetLane(lane);
    }

    function renderLaneChips(){
      const a=lanePlayers.A, b=lanePlayers.B;
      const aEl=qs('#laneAWho'), bEl=qs('#laneBWho'), topA=qs('#chipLaneA'), topB=qs('#chipLaneB');
      if(a){ const txt=`${a.tryout_num||''} • ${a.display_name||a.player_id}${a.primary_pos?` (${a.primary_pos})`:''}`;
        aEl.innerHTML=`${txt} <span class="x" data-clear="A">✕</span>`; aEl.style.display=''; topA.textContent=`Lane A: ${txt}`; topA.style.display=''; qs('#aSave').disabled=false;
      }else{ aEl.style.display='none'; topA.style.display='none'; qs('#aSave').disabled=true; }
      if(b){ const txt=`${b.tryout_num||''} • ${b.display_name||b.player_id}${b.primary_pos?` (${b.primary_pos})`:''}`;
        bEl.innerHTML=`${txt} <span class="x" data-clear="B">✕</span>`; bEl.style.display=''; topB.textContent=`Lane B: ${txt}`; topB.style.display=''; qs('#bSave').disabled=false;
      }else{ bEl.style.display='none'; topB.style.display='none'; qs('#bSave').disabled=true; }
      qsa('[data-clear="A"]').forEach(x=> x.onclick=()=>{ lanePlayers.A=null; renderLaneChips(); hardResetLane('A'); });
      qsa('[data-clear="B"]').forEach(x=> x.onclick=()=>{ lanePlayers.B=null; renderLaneChips(); hardResetLane('B'); });
    }
    function assignToActiveLane(rec){
      lanePlayers[activeLane]=rec;
      qs('#playerPicker').value=labelFor(rec);
      renderLaneChips();
      hardResetLane(activeLane);
    }

    window.addEventListener('tryoutui:select', (e)=>{
      const d=e?.detail?.player; if(!d) return;
      const hit=roster.find(r=>r.player_id===d.player_id)||d;
      assignToActiveLane(hit);
    });
    qs('#playerPicker').addEventListener('change', (e)=>{
      const txt=(e.target.value||'').toLowerCase();
      const hit=roster.find(r=>labelFor(r).toLowerCase()===txt) ||
                roster.find(r=>String(r.tryout_num||'').toLowerCase()===txt) ||
                roster.find(r=>String(r.display_name||'').toLowerCase()===txt);
      if(hit) assignToActiveLane(hit);
    });

    // ---- Drill dictionary + inputs (aligned with RB) ----
    function renderInputs(prefix, drill){
      const isTime=isTimeDrill(drill);
      const isRate=isRateDrill(drill);
      const timerBlk=qs(`#${prefix}TimerBlock`);
      const inputBlk=qs(`#${prefix}InputsBlock`);
      const bothCard=qs('#bothStartCard');
      const primaryLabel=qs(`#${prefix}PrimaryLabel`);
      const primaryHelp=qs(`#${prefix}PrimaryHelp`);

      const pm=(drill.primary_measurement||'').toLowerCase();
      const errorLike = pm.includes('error_rate') || pm.includes('interception_rate') || (pm.includes('error') && pm.includes('rate')) || (pm.includes('miss') && pm.includes('rate'));
      const friendly = errorLike ? (pm.includes('interception') ? 'Interception Rate' : pm.includes('miss') ? 'Miss Rate' : 'Error Rate')
                                 : (pm.includes('completion') ? 'Completion Rate' : pretty(drill.primary_measurement||'Primary'));

      primaryLabel.textContent = isRate ? `${friendly} (calculated %)` : (drill.primary_measurement || 'Time');

      const hint=[];
      if(drill.drill_category) hint.push(drill.drill_category);
      if(drill.success_threshold) hint.push(`Above Avg: ${drill.success_threshold}`);
      if(drill.failure_threshold) hint.push(`Below Avg: ${drill.failure_threshold}`);
      primaryHelp.textContent=hint.join(' • ');

      timerBlk.style.display = isTime ? '' : 'none';
      inputBlk.style.display  = isTime ? 'none' : '';

      const head=qs(`#${prefix}Head`);
      head.innerHTML=`<tr><th>Drill</th><th>Att</th><th>${pretty(drill.primary_measurement) || 'Primary'}</th><th>${drill.secondary_measurement?pretty(drill.secondary_measurement):'Secondary'}</th><th>Rating</th></tr>`;

      bothCard.style.display = isTime ? '' : 'none';
      inputBlk.innerHTML='';

      if(!isTime && isRate){
        const succId=`${prefix}Successes`;
        const secId =`${prefix}Secondary`;

        let succLabel = successLabelFor(drill.primary_measurement);
        let secLabel  = failureLabelFor(drill.primary_measurement);

        const attemptsIsGoal = /attempt/i.test(String(drill.secondary_measurement||'')) && drill.secondary_threshold;
        const secT = attemptsIsGoal ? parseThreshold(drill.secondary_threshold) : null;
        const goalValue = (secT && secT.type==='comp') ? secT.value : null;

        inputBlk.innerHTML = `
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <div>
              <label class="label">${succLabel}</label>
              <div class="counter-control">
                <button class="counter-btn" data-counter-dec="${succId}" type="button">−</button>
                <div class="counter-value" data-counter-value="${succId}">0</div>
                <button class="counter-btn" data-counter-inc="${succId}" type="button">+</button>
              </div>
            </div>
            <div>
              <label class="label">${secLabel}</label>
              <div class="counter-control">
                <button class="counter-btn" data-counter-dec="${secId}" type="button">−</button>
                <div class="counter-value" data-counter-value="${secId}">0</div>
                <button class="counter-btn" data-counter-inc="${secId}" type="button">+</button>
              </div>
            </div>
          </div>

          <div class="rate-display" style="margin-top:8px;">
            <div class="rate-value" id="${prefix}RateVal">0%</div>
            <div class="rate-label">${drill.primary_measurement || 'Rate'} (<span id="${prefix}SuccCount">0</span> / Attempts: <span id="${prefix}AttCount">0</span>)</div>
          </div>
          <div class="small" style="margin-top:6px;">
            <span data-rate="${prefix}-goal" class="chip ghost small" style="display:${attemptsIsGoal?'inline-flex':'none'}"></span>
          </div>
        `;

        const update=()=>{
          const s=parseInt(inputBlk.querySelector(`[data-counter-value="${succId}"]`)?.textContent||'0');
          const x=parseInt(inputBlk.querySelector(`[data-counter-value="${secId}"]`)?.textContent||'0');
          const att=s+x;
          const pct = att>0 ? (errorLike ? (x/att)*100 : (s/att)*100) : 0;
          inputBlk.querySelector(`#${prefix}RateVal`).textContent=pct.toFixed(1)+'%';
          inputBlk.querySelector(`#${prefix}SuccCount`).textContent=String(s);
          inputBlk.querySelector(`#${prefix}AttCount`).textContent=String(att);

          const goalEl=inputBlk.querySelector(`[data-rate="${prefix}-goal"]`);
          if(goalEl && goalValue!=null){
            const met = att>=goalValue;
            goalEl.textContent = met ? 'Attempts goal met ✓' : `Goal ≥ ${goalValue} attempts`;
            goalEl.classList.toggle('badge', met);
          }
        };

        inputBlk.querySelectorAll('[data-counter-inc],[data-counter-dec]').forEach(btn=>{
          const isInc=btn.hasAttribute('data-counter-inc');
          btn.addEventListener('click', ()=>{
            const id=btn.getAttribute(isInc?'data-counter-inc':'data-counter-dec');
            const el=inputBlk.querySelector(`[data-counter-value="${id}"]`);
            const cur=parseInt(el.textContent)||0;
            el.textContent=String(isInc ? cur+1 : Math.max(0,cur-1));
            update();
          });
        });
        update();
      }
    }

    async function loadQBDrills(){
      try{
        const res = await API.tryout.read.drills();
        if(res?.ok){
          const all=res.drills||res.rows||[];
          QB_DRILLS = all.filter(d=>{
            const pg=String(d.position_group||'').toUpperCase();
            const st=String(d.station_id||'').toUpperCase();
            return pg==='QB' || st==='QB' || st==='QBS';
          });
        }
      }catch(e){ console.error(e); }
      if(!Array.isArray(QB_DRILLS) || !QB_DRILLS.length){
        QB_DRILLS=[{drill_id:'QB01',drill_name:'Pocket Presence',station_id:'QB',position_group:'QB',drill_type:'Rate',primary_measurement:'completion_rate',measurement_unit:'percentage',success_threshold:'>=70',failure_threshold:'<=45',secondary_measurement:'incompletions',secondary_unit:'count',secondary_threshold:''}];
      }
      const sel=qs('#qbDrillSel');
      sel.innerHTML = QB_DRILLS.map(d=>`<option value="${d.drill_id}">${d.drill_name}</option>`).join('');
      if(QB_DRILLS[0]) sel.value=QB_DRILLS[0].drill_id;
      sel.dispatchEvent(new Event('change'));
    }

    qs('#qbDrillSel').addEventListener('change', ()=>{
      const sel=qs('#qbDrillSel');
      QB_CURR = QB_DRILLS.find(x=>x.drill_id===sel.value) || null;
      const badge=qs('#drillBadge'); const hint=qs('#qbDrillHint');
      if(QB_CURR){
        badge.textContent = `Drill: ${QB_CURR.drill_name}`;
        const hintParts=[];
        if(QB_CURR.drill_category) hintParts.push(QB_CURR.drill_category);
        if(QB_CURR.success_threshold) hintParts.push(`Above Avg: ${QB_CURR.success_threshold}`);
        if(QB_CURR.failure_threshold) hintParts.push(`Below Avg: ${QB_CURR.failure_threshold}`);
        hint.textContent = hintParts.join(' • ');
        renderInputs('a',QB_CURR); renderInputs('b',QB_CURR);
        softResetLane('A'); softResetLane('B');
      } else { badge.textContent='Drill: —'; hint.textContent=''; }
    });

    // recent log
    function addRecent(route, summary){
      pageLog.unshift({ts:new Date(), route, summary});
      pageLog.splice(PAGE_LOG_LIMIT);
      renderRecent();
    }
    function renderRecent(){
      const ul=qs('#recentList'); const cnt=qs('#recentCount'); if(!ul) return;
      ul.innerHTML=pageLog.map(it=>`<li><strong>${fmtTime(it.ts)}</strong> — ${it.summary}</li>`).join('');
      cnt.textContent=pageLog.length ? `${pageLog.length} item${pageLog.length===1?'':'s'}` : '';
    }
    qs('#toggleRecent').addEventListener('click', ()=>{
      const p=qs('#recentPanel'); const open=p.style.display!=='none';
      p.style.display = open ? 'none' : '';
      qs('#toggleRecent').textContent = open ? 'Recent Writes ▾' : 'Recent Writes ▴';
    });

    // save helpers
    function setSaving(lane, saving){
      const p=(lane==='A')?'a':'b';
      const saveBtn=qs('#'+p+'Save'); const toggleBtn=qs('#'+p+'Toggle'); const resetBtn=qs('#'+p+'Reset');
      if(!saveBtn.dataset.label) saveBtn.dataset.label=saveBtn.textContent;
      if(saving){ saveBtn.classList.add('loading'); saveBtn.disabled=true; if(toggleBtn) toggleBtn.disabled=true; if(resetBtn) resetBtn.disabled=true; saveBtn.innerHTML='<span class="spin"></span>Saving…'; }
      else { saveBtn.classList.remove('loading'); saveBtn.disabled=(lane==='A'? !lanePlayers.A : !lanePlayers.B); if(toggleBtn) toggleBtn.disabled=false; if(resetBtn) resetBtn.disabled=false; saveBtn.textContent=saveBtn.dataset.label||'Save'; }
    }

    // ---- universal lane read (time or rate) — aligns with RB page ----
    function readLaneValues(prefix, drill){
      const isTime=isTimeDrill(drill);
      const isRate=isRateDrill(drill);

      let primaryVal=null, secondaryVal=null;
      let successes=0, failures=0, attempts=0;

      if(isTime){
        const el=qs(`#${prefix}Time`);
        primaryVal=parseFloat((el.textContent||'0').trim());
        if(isNaN(primaryVal)) primaryVal=null;
      }else if(isRate){
        const pm=(drill.primary_measurement||'').toLowerCase();
        const errorLike = pm.includes('error_rate') || pm.includes('interception_rate') || (pm.includes('error') && pm.includes('rate')) || (pm.includes('miss') && pm.includes('rate'));
        const box=qs(`#${prefix}InputsBlock`);
        successes=parseInt(box?.querySelector(`[data-counter-value="${prefix}Successes"]`)?.textContent||'0');
        failures =parseInt(box?.querySelector(`[data-counter-value="${prefix}Secondary"]`)?.textContent||'0');
        attempts =successes+failures;
        primaryVal = attempts>0 ? (errorLike ? (failures/attempts)*100 : (successes/attempts)*100) : 0;

        // secondary_value:
        // - if drill defines "attempts" as secondary, send attempts
        // - else if secondary exists (e.g., errors/drops), send that count
        if (/attempt/i.test(String(drill.secondary_measurement||''))) secondaryVal = attempts;
        else if (drill.secondary_measurement) secondaryVal = failures;
      }
      return { primaryVal, secondaryVal, successes, failures, attempts, isTime, isRate };
    }

    // ---- SAVE (aligned to 71_Fact_Tryout_Position, same as RB page) ----
    async function saveAttempt({ lane }){
      const prefix = lane==='A' ? 'a' : 'b';
      const statusEl = qs(lane==='A' ? '#aStatus' : '#bStatus');
      const attSel   = qs(lane==='A' ? '#aAttempt' : '#bAttempt');
      const logTbody = qs(lane==='A' ? '#aLog'     : '#bLog');

      statusEl.textContent='';

      const c=ctx();
      if(!c.tryout_id){ statusEl.textContent='Set a Tryout ID first.'; statusEl.className='status warn'; return; }
      if(!QB_CURR){ statusEl.textContent='Choose a drill.'; statusEl.className='status warn'; return; }

      const player=lanePlayers[lane];
      if(!(player?.tryout_num || player?.player_id)){
        statusEl.textContent=`Assign a player to Lane ${lane}.`;
        statusEl.className='status warn'; return;
      }

      const t=timers.get(prefix); if(t?.isRunning()) t.stop();

      const { primaryVal, secondaryVal, successes, failures, attempts, isTime, isRate } = readLaneValues(prefix, QB_CURR);
      const attempt = Number(attSel.value||1);
      const evaluation = evaluateDrill(QB_CURR, primaryVal, secondaryVal);

      // Build universal write row
      const row = {
        timestamp:   '', // server fills, column present in 71_Fact_Tryout_Position
        tryout_id:   c.tryout_id || '',
        period_code: c.period_code || '',

        player_id:   String(player.player_id || '').trim(),
        tryout_num:  String(player.tryout_num || '').trim(),
        group_code:  resolveGroupCode(player.player_id, '', player) || '',

        station_id:  STATION_ID,
        drill_id:    QB_CURR.drill_id,
        attempt:     attempt,

        primary_name:   QB_CURR.primary_measurement || (isTime ? 'time' : 'rate'),
        primary_unit:   QB_CURR.measurement_unit || (isTime ? 'sec' : 'percentage'),
        primary_value:  (primaryVal===true)?1:(primaryVal===false)?0:primaryVal,
        primary_successes: isRate ? successes : '',
        primary_failures:  isRate ? failures  : '',
        primary_attempts:  isRate ? attempts  : '',

        secondary_name:  QB_CURR.secondary_measurement || '',
        secondary_unit:  QB_CURR.secondary_unit || '',
        secondary_value: (secondaryVal===true)?1:(secondaryVal===false)?0:secondaryVal,

        rating_tier: evaluation.rating,
        pass_flag:   evaluation.rating==='above'?1:0,
        score_5:     '',

        notes: (qs('#sharedNotes').value||'').trim(),
        source_app: `${SOURCE_APP}.${STATION_ID.toLowerCase()}`,
        client_id:  CLIENT_ID,

        // legacy compatibility fields used by older sheets
        metric_1: (primaryVal===true)?1:(primaryVal===false)?0:primaryVal,
        metric_2: secondaryVal,

        // convenience column if present in the table
        errors_count: isRate ? failures : ''
      };

      setSaving(lane,true);
      let res; try { res = await API.tryout.write.station(row); } finally { setSaving(lane,false); }
      if(!res?.ok){ statusEl.textContent = res?.error || 'Save failed.'; statusEl.className='status err'; return; }

      const primTxt = isTime ? Number(primaryVal).toFixed(2)+' s' : Number(primaryVal).toFixed(1)+'%';
      const secTxt  = QB_CURR.secondary_measurement ? (secondaryVal==null ? '—' : String(secondaryVal)) : '—';
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${QB_CURR.drill_name}</td><td>${attempt}</td><td>${primTxt}</td><td>${secTxt}</td><td><span class="${evaluation.ratingClass}">${evaluation.ratingText}</span></td>`;
      logTbody.prepend(tr); while(logTbody.children.length>10) logTbody.removeChild(logTbody.lastChild);

      const who=player.tryout_num||player.player_id||'—';
      addRecent('station', `Write → QB :: ${who} • ${QB_CURR.drill_name} • ${primTxt}${QB_CURR.secondary_measurement?` • ${secTxt}`:''} • ${evaluation.ratingText} (Att ${attempt})`);

      if (AFTER_SAVE.markDone){
        try { TryoutUI?.markDone?.(player.player_id || player.tryout_num); } catch{}
        try { window.dispatchEvent(new CustomEvent('tryoutui:done', { detail:{ player_id: player.player_id, tryout_num: player.tryout_num } })); } catch{}
      }

      const next=Math.min((attempt % 10)+1, 10);
      attSel.value=String(next);
      softResetLane(lane);

      statusEl.textContent = `Saved ✔ • ${evaluation.ratingText}`;
      statusEl.className = evaluation.rating==='above' ? 'status ok' : evaluation.rating==='below' ? 'status warn' : 'status avg';
    }

    // wiring
    function wireLane(prefix){
      const toggleBtn=qs('#'+prefix+'Toggle');
      const timeEl=qs('#'+prefix+'Time');
      const statusEl=qs('#'+prefix+'Status');
      const t=makeTimer(timeEl,(running)=>{
        if(toggleBtn){ toggleBtn.textContent=running?'Stop':'Start'; toggleBtn.setAttribute('aria-pressed',running?'true':'false'); toggleBtn.classList.toggle('warn', running); }
        if(!running) statusEl.textContent='';
      });
      timers.set(prefix,t);
      if(toggleBtn) toggleBtn.addEventListener('click', t.toggle);
      const resetBtn=qs('#'+prefix+'Reset');
      if(resetBtn) resetBtn.addEventListener('click', ()=> softResetLane(prefix==='a'?'A':'B'));
      qs('#'+prefix+'Save').addEventListener('click', ()=> saveAttempt({ lane: (prefix==='a'?'A':'B') }));
    }
    function wireBothStart(){
      const a=()=>timers.get('a'); const b=()=>timers.get('b');
      const btn=qs('#bothStart'); if(!btn) return;
      btn.addEventListener('click', ()=>{ if(lanePlayers.A) a()?.start(); if(lanePlayers.B) b()?.start(); });
    }

    (async function init(){
      wireLane('a'); wireLane('b'); wireBothStart(); setActiveLane('A');
      await Promise.all([loadRoster(), loadLatestGroups(), loadQBDrills()]);
      if (window.TryoutUI?.getSelectedPlayers){
        const cur=TryoutUI.getSelectedPlayers();
        if(Array.isArray(cur) && cur[0]) assignToActiveLane(cur[0]);
      }
    })();
  </script>
</body>
</html>
